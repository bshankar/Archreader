<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8">
<title>dm-crypt/Encrypting an entire system - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<style></style>
<meta name="generator" content="MediaWiki 1.26.4">
<meta name="robots" content="noindex,follow">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Dm-crypt_Encrypting_an_entire_system skin-archlinux action-view">

		<div id="globalWrapper" style="width: 100%">
		<div id="column-content">
			<div id="content" class="mw-body" role="main" style="margin: 2em; margin-bottom: 0">
				<a id="top"></a>
				
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">dm-crypt/Encrypting an entire system</h1>
				
				<div id="bodyContent" class="mw-body-content">
					<div id="contentSub"><span class="subpages">&lt; <a href="../../en/Dm-crypt.html" title="Dm-crypt">Dm-crypt</a></span></div>
										<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<p><span></span>
Back to <a href="../../en/Dm-crypt.html" title="Dm-crypt">dm-crypt</a>.
</p>
<p>The following are examples of common scenarios of full system encryption with <i>dm-crypt</i>. They explain all the adaptations that need to be done to the normal <a href="../../en/Installation_guide.html" title="Installation guide">installation procedure</a>. All the necessary tools are on the <a rel="nofollow" class="external text" href="https://www.archlinux.org/download/">installation image</a>.
</p>
<div id="toc" class="toc">
<div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#Simple_partition_layout_with_LUKS"><span class="tocnumber">2</span> <span class="toctext">Simple partition layout with LUKS</span></a>
<ul>
<li class="toclevel-2 tocsection-3"><a href="#Preparing_the_disk"><span class="tocnumber">2.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Preparing_non-boot_partitions"><span class="tocnumber">2.2</span> <span class="toctext">Preparing non-boot partitions</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Preparing_the_boot_partition"><span class="tocnumber">2.3</span> <span class="toctext">Preparing the boot partition</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Mounting_the_devices"><span class="tocnumber">2.4</span> <span class="toctext">Mounting the devices</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Configuring_mkinitcpio"><span class="tocnumber">2.5</span> <span class="toctext">Configuring mkinitcpio</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Configuring_the_boot_loader"><span class="tocnumber">2.6</span> <span class="toctext">Configuring the boot loader</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-9">
<a href="#LVM_on_LUKS"><span class="tocnumber">3</span> <span class="toctext">LVM on LUKS</span></a>
<ul>
<li class="toclevel-2 tocsection-10"><a href="#Preparing_the_disk_2"><span class="tocnumber">3.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#Preparing_the_logical_volumes"><span class="tocnumber">3.2</span> <span class="toctext">Preparing the logical volumes</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Preparing_the_boot_partition_2"><span class="tocnumber">3.3</span> <span class="toctext">Preparing the boot partition</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Configuring_mkinitcpio_2"><span class="tocnumber">3.4</span> <span class="toctext">Configuring mkinitcpio</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Configuring_the_boot_loader_2"><span class="tocnumber">3.5</span> <span class="toctext">Configuring the boot loader</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15">
<a href="#LUKS_on_LVM"><span class="tocnumber">4</span> <span class="toctext">LUKS on LVM</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#Preparing_the_disk_3"><span class="tocnumber">4.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#Preparing_the_logical_volumes_2"><span class="tocnumber">4.2</span> <span class="toctext">Preparing the logical volumes</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#Preparing_the_boot_partition_3"><span class="tocnumber">4.3</span> <span class="toctext">Preparing the boot partition</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#Configuring_mkinitcpio_3"><span class="tocnumber">4.4</span> <span class="toctext">Configuring mkinitcpio</span></a></li>
<li class="toclevel-2 tocsection-20"><a href="#Configuring_the_boot_loader_3"><span class="tocnumber">4.5</span> <span class="toctext">Configuring the boot loader</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#Configuring_fstab_and_crypttab"><span class="tocnumber">4.6</span> <span class="toctext">Configuring fstab and crypttab</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#Encrypting_logical_volume_.2Fhome"><span class="tocnumber">4.7</span> <span class="toctext">Encrypting logical volume /home</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-23"><a href="#LUKS_on_software_RAID"><span class="tocnumber">5</span> <span class="toctext">LUKS on software RAID</span></a></li>
<li class="toclevel-1 tocsection-24">
<a href="#Plain_dm-crypt"><span class="tocnumber">6</span> <span class="toctext">Plain dm-crypt</span></a>
<ul>
<li class="toclevel-2 tocsection-25"><a href="#Preparing_the_disk_4"><span class="tocnumber">6.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#Preparing_the_non-boot_partitions"><span class="tocnumber">6.2</span> <span class="toctext">Preparing the non-boot partitions</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Preparing_the_boot_partition_4"><span class="tocnumber">6.3</span> <span class="toctext">Preparing the boot partition</span></a></li>
<li class="toclevel-2 tocsection-28"><a href="#Configuring_mkinitcpio_4"><span class="tocnumber">6.4</span> <span class="toctext">Configuring mkinitcpio</span></a></li>
<li class="toclevel-2 tocsection-29"><a href="#Configuring_the_boot_loader_4"><span class="tocnumber">6.5</span> <span class="toctext">Configuring the boot loader</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Post-installation"><span class="tocnumber">6.6</span> <span class="toctext">Post-installation</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-31">
<a href="#Encrypted_boot_partition_.28GRUB.29"><span class="tocnumber">7</span> <span class="toctext">Encrypted boot partition (GRUB)</span></a>
<ul>
<li class="toclevel-2 tocsection-32"><a href="#Preparing_the_disk_5"><span class="tocnumber">7.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Preparing_the_logical_volumes_3"><span class="tocnumber">7.2</span> <span class="toctext">Preparing the logical volumes</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Preparing_the_boot_partition_5"><span class="tocnumber">7.3</span> <span class="toctext">Preparing the boot partition</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#Configuring_mkinitcpio_5"><span class="tocnumber">7.4</span> <span class="toctext">Configuring mkinitcpio</span></a></li>
<li class="toclevel-2 tocsection-36"><a href="#Configuring_the_boot_loader_5"><span class="tocnumber">7.5</span> <span class="toctext">Configuring the boot loader</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Configuring_fstab_and_crypttab_2"><span class="tocnumber">7.6</span> <span class="toctext">Configuring fstab and crypttab</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-38">
<a href="#Btrfs_subvolumes_with_swap"><span class="tocnumber">8</span> <span class="toctext">Btrfs subvolumes with swap</span></a>
<ul>
<li class="toclevel-2 tocsection-39"><a href="#Preparing_the_disk_6"><span class="tocnumber">8.1</span> <span class="toctext">Preparing the disk</span></a></li>
<li class="toclevel-2 tocsection-40">
<a href="#Preparing_the_system_partition"><span class="tocnumber">8.2</span> <span class="toctext">Preparing the system partition</span></a>
<ul>
<li class="toclevel-3 tocsection-41"><a href="#Create_LUKS_container"><span class="tocnumber">8.2.1</span> <span class="toctext">Create LUKS container</span></a></li>
<li class="toclevel-3 tocsection-42"><a href="#Unlock_LUKS_container"><span class="tocnumber">8.2.2</span> <span class="toctext">Unlock LUKS container</span></a></li>
<li class="toclevel-3 tocsection-43"><a href="#Format_mapped_device"><span class="tocnumber">8.2.3</span> <span class="toctext">Format mapped device</span></a></li>
<li class="toclevel-3 tocsection-44"><a href="#Mount_mapped_device"><span class="tocnumber">8.2.4</span> <span class="toctext">Mount mapped device</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-45">
<a href="#Creating_btrfs_subvolumes"><span class="tocnumber">8.3</span> <span class="toctext">Creating btrfs subvolumes</span></a>
<ul>
<li class="toclevel-3 tocsection-46"><a href="#Layout"><span class="tocnumber">8.3.1</span> <span class="toctext">Layout</span></a></li>
<li class="toclevel-3 tocsection-47"><a href="#Create_top-level_subvolumes"><span class="tocnumber">8.3.2</span> <span class="toctext">Create top-level subvolumes</span></a></li>
<li class="toclevel-3 tocsection-48"><a href="#Mount_top-level_subvolumes"><span class="tocnumber">8.3.3</span> <span class="toctext">Mount top-level subvolumes</span></a></li>
<li class="toclevel-3 tocsection-49"><a href="#Create_nested_subvolumes"><span class="tocnumber">8.3.4</span> <span class="toctext">Create nested subvolumes</span></a></li>
<li class="toclevel-3 tocsection-50"><a href="#Mount_ESP"><span class="tocnumber">8.3.5</span> <span class="toctext">Mount ESP</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-51">
<a href="#Configuring_mkinitcpio_6"><span class="tocnumber">8.4</span> <span class="toctext">Configuring mkinitcpio</span></a>
<ul>
<li class="toclevel-3 tocsection-52"><a href="#Create_keyfile"><span class="tocnumber">8.4.1</span> <span class="toctext">Create keyfile</span></a></li>
<li class="toclevel-3 tocsection-53"><a href="#Edit_mkinitcpio.conf"><span class="tocnumber">8.4.2</span> <span class="toctext">Edit mkinitcpio.conf</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-54"><a href="#Configuring_the_boot_loader_6"><span class="tocnumber">8.5</span> <span class="toctext">Configuring the boot loader</span></a></li>
<li class="toclevel-2 tocsection-55"><a href="#Configuring_swap"><span class="tocnumber">8.6</span> <span class="toctext">Configuring swap</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Overview">Overview</span></h2>
<p>Securing a root filesystem is where <i>dm-crypt</i> excels, feature and performance-wise. Unlike selectively encrypting non-root filesystems, an encrypted root filesystem can conceal information such as which programs are installed, the usernames of all user accounts, and common data-leakage vectors such as <a href="../../en/Core_utilities.html#locate" title="Mlocate" class="mw-redirect">mlocate</a> and <code>/var/log/</code>. Furthermore, an encrypted root filesystem makes tampering with the system far more difficult, as everything except the <a href="../../en/Boot_loader.html" title="Boot loader" class="mw-redirect">boot loader</a> and (usually) the kernel is encrypted. 
</p>
<p>All scenarios illustrated in the following share these advantages, other pros and cons differentiating them are summarized below:  
</p>
<table class="wikitable">
<tr>
<th> Scenarios
</th>
<th> Advantages
</th>
<th> Disadvantages
</th>
</tr>
<tr>
<td> <a href="#Simple_partition_layout_with_LUKS">#Simple partition layout with LUKS</a>
<p>shows a basic and straight-forward set-up for a fully LUKS encrypted root. 
</p>
</td>
<td>
<ul><li> Simple partitioning and setup</li></ul>
</td>
<td>
<ul><li> Inflexible; disk-space to be encrypted has to be pre-allocated </li></ul>
</td>
</tr>
<tr>
<td> <a href="#LVM_on_LUKS">#LVM on LUKS</a>
<p>achieves partitioning flexiblity by using LVM inside a single LUKS encrypted partition.
</p>
</td>
<td>
<ul>
<li> Simple partitioning with knowledge of LVM</li>
<li> Only one key required to unlock all volumes (e.g. easy resume-from-disk setup)</li>
<li> Volume layout not transparent when locked</li>
<li> Easiest method to allow <a href="../../en/Dm-crypt/Swap_encryption.html#With_suspend-to-disk_support" title="Dm-crypt/Swap encryption">suspension to disk</a>
</li>
</ul>
</td>
<td>
<ul>
<li> LVM adds an additional mapping layer and hook  </li>
<li> Less useful, if a singular volume should receive a separate key </li>
</ul>
</td>
</tr>
<tr>
<td> <a href="#LUKS_on_LVM">#LUKS on LVM</a>
<p>uses dm-crypt only after the LVM is setup. 
</p>
</td>
<td>
<ul>
<li> LVM can be used to have encrypted volumes span multiple disks </li>
<li> Easy mix of un-/encrypted volume groups</li>
</ul>
</td>
<td>
<ul>
<li> Complex; changing volumes requires changing encryption mappers too</li>
<li> Volumes require individual keys </li>
<li> LVM layout is transparent when locked </li>
</ul>
</td>
</tr>
<tr>
<td> <a href="#Plain_dm-crypt">#Plain dm-crypt</a>
<p>uses dm-crypt plain mode, i.e. without a LUKS header and its options for multiple keys. <br>This scenario also employs USB devices for <code>/boot</code> and key storage, which may be applied to the other scenarios. 
</p>
</td>
<td>
<ul>
<li> Data resilience for cases where a LUKS header may be damaged</li>
<li> Allows <a href="https://en.wikipedia.org/wiki/Disk_encryption#Full_disk_encryption" class="extiw" title="wikipedia:Disk encryption">Full Disk Encryption</a>
</li>
<li> Helps addressing <a href="../../en/Dm-crypt/Specialties.html#Discard.2FTRIM_support_for_solid_state_drives_.28SSD.29" title="Dm-crypt/Specialties">problems</a> with SSDs</li>
</ul>
</td>
<td>
<ul>
<li> High care to all encryption parameters is required</li>
<li> Single encryption key and no option to change it  </li>
</ul>
</td>
</tr>
<tr>
<td> <a href="#Encrypted_boot_partition_.28GRUB.29">#Encrypted boot partition (GRUB)</a>
<p>shows how to encrypt the boot partition using the GRUB bootloader. <br> This scenario also employs an ESP partition, which may be applied to the other scenarios.
</p>
</td>
<td>
<ul>
<li> Same advantages as the scenario the installation is based on (LVM on LUKS for this particular example)</li>
<li> Less data is left unencrypted, i.e. the boot loader and the ESP partition, if present</li>
</ul>
</td>
<td>
<ul>
<li> Same disadvantages as the scenario the installation is based on (LVM on LUKS for this particular example)</li>
<li> More complicated configuration</li>
<li> Not supported by other boot loaders</li>
</ul>
</td>
</tr>
<tr>
<td> <a href="#Btrfs_subvolumes_with_swap">#Btrfs subvolumes with swap</a>
<p>shows how to encrypt a <a href="../../en/Btrfs.html" title="Btrfs">Btrfs</a> system, including the <code>/boot</code> directory, also adding a partition for swap, on UEFI hardware.
</p>
</td>
<td>
<ul>
<li> Similar advantages as <a href="#Encrypted_boot_partition_.28GRUB.29">#Encrypted boot partition (GRUB)</a>
</li>
<li> Availability of Btrfs' features</li>
</ul>
</td>
<td>
<ul><li> Similar disadvantages as <a href="#Encrypted_boot_partition_.28GRUB.29">#Encrypted boot partition (GRUB)</a>
</li></ul>
</td>
</tr>
</table>
<p>While all above scenarios provide much greater protection from outside threats than encrypted secondary filesystems, they also share a common disadvantage: any user in possession of the encryption key is able to decrypt the entire drive, and therefore can access other users' data. If that is of concern, it is possible to use a combination of blockdevice and stacked filesystem encryption and reap the advantages of both. See <a href="../../en/Disk_encryption.html" title="Disk encryption">Disk encryption</a> to plan ahead. 
</p>
<p>See <a href="../../en/Dm-crypt/Drive_preparation.html#Partitioning" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation#Partitioning</a> for a general overview of the partitioning strategies used in the scenarios.
</p>
<p>Another area to consider is whether to set up an encrypted swap partition and what kind. See <a href="../../en/Dm-crypt/Swap_encryption.html" title="Dm-crypt/Swap encryption">Dm-crypt/Swap encryption</a> for alternatives.
</p>
<p>If you anticipate to protect the system's data not only against physical theft, but also have a requirement of precautions against logical tampering, see <a href="../../en/Dm-crypt/Specialties.html#Securing_the_unencrypted_boot_partition" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Securing the unencrypted boot partition</a> for further possibilities after following one of the scenarios.
</p>
<h2><span class="mw-headline" id="Simple_partition_layout_with_LUKS">Simple partition layout with LUKS</span></h2>
<p>This example covers a full system encryption with <i>dmcrypt</i> + LUKS in a simple partition layout:
</p>
<pre>+--------------------+--------------------------+--------------------------+
|Boot partition      |LUKS encrypted system     |Optional free space       |
|                    |partition                 |for additional partitions |
|/dev/sdaY           |/dev/sdaX                 |or swap to be setup later |
+--------------------+--------------------------+--------------------------+
</pre>
<p>The first steps can be performed directly after booting the Arch Linux install image.
</p>
<h3><span class="mw-headline" id="Preparing_the_disk">Preparing the disk</span></h3>
<p>Prior to creating any partitions, you should inform yourself about the importance and methods to securely erase the disk,  described in <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation</a>.
</p>
<p>Then create the needed partitions, at least one for <code>/</code> (e.g. <code>/dev/sdaX</code>) and <code>/boot</code> (<code>/dev/sdaY</code>), see <a href="../../en/Partitioning.html" title="Partitioning">Partitioning</a>.
</p>
<h3><span class="mw-headline" id="Preparing_non-boot_partitions">Preparing non-boot partitions</span></h3>
<p>The following commands create and mount the encrypted root partition. They correspond to the procedure described in detail in <a href="../../en/Dm-crypt/Encrypting_a_non-root_file_system.html#Partition" title="Dm-crypt/Encrypting a non-root file system">Dm-crypt/Encrypting a non-root file system#Partition</a> (which, despite the title, <i>can</i> be applied to root partitions, as long as <a href="#Configuring_mkinitcpio">mkinitcpio</a> and the <a href="#Configuring_the_boot_loader">boot loader</a> are correctly configured). 
If you want to use particular non-default encryption options (e.g. cipher, key length), see the <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">encryption options</a> before executing the first command:
</p>
<pre># cryptsetup -y -v luksFormat /dev/sdaX
# cryptsetup open /dev/sdaX cryptroot
# mkfs -t ext4 /dev/mapper/cryptroot
# mount -t ext4 /dev/mapper/cryptroot /mnt
</pre>
<p>Check the mapping works as intended:
</p>
<pre># umount /mnt
# cryptsetup close cryptroot
# cryptsetup open /dev/sdaX cryptroot
# mount -t ext4 /dev/mapper/cryptroot /mnt
</pre>
<p>If you created separate partitions (e.g. <code>/home</code>), these steps have to be adapted and repeated for all of them, <i>except</i> for <code>/boot</code>. See <a href="../../en/Dm-crypt/Encrypting_a_non-root_file_system.html#Automated_unlocking_and_mounting" title="Dm-crypt/Encrypting a non-root file system">Dm-crypt/Encrypting a non-root file system#Automated unlocking and mounting</a> on how to handle additional partitions at boot.
</p>
<p>Note that each blockdevice requires its own passphrase. This may be inconvenient, because it results in a separate passphrase to be input during boot. An alternative is to use a keyfile stored in the system partition to unlock the separate partition via <code>crypttab</code>. See <a href="../../en/Dm-crypt/Device_encryption.html#Using_LUKS_to_format_partitions_with_a_keyfile" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Using LUKS to format partitions with a keyfile</a> for instructions.
</p>
<h3><span class="mw-headline" id="Preparing_the_boot_partition">Preparing the boot partition</span></h3>
<p>What you do have to setup is a non-encrypted <code>/boot</code> partition, which is needed for a crypted root. For a standard <a href="../../en/Unified_Extensible_Firmware_Interface.html" title="EFI" class="mw-redirect">MBR/non-EFI</a> <code>/boot</code> partition, for example, execute:
</p>
<pre># mkfs -t ext4 /dev/sdaY
# mkdir /mnt/boot
# mount -t ext4 /dev/sdaY /mnt/boot
</pre>
<h3><span class="mw-headline" id="Mounting_the_devices">Mounting the devices</span></h3>
<p>At <a href="../../en/Installation_guide.html#Mount_the_partitions" title="Installation guide">Installation guide#Mount the partitions</a> you will have to mount the mapped devices, not the actual partitions. Of course <code>/boot</code>, which is not encrypted, will still have to be mounted directly.
</p>
<p>Afterwards continue with the installation procedure up to the mkinitcpio step.
</p>
<h3><span class="mw-headline" id="Configuring_mkinitcpio">Configuring mkinitcpio</span></h3>
<p>Add the <code>encrypt</code> hook to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS="... <b>encrypt</b> ... filesystems ..."</pre>
<p>Depending on which other hooks are used, the order may be relevant. See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">dm-crypt/System configuration#mkinitcpio</a> for details and other hooks that you may need.
</p>
<h3><span class="mw-headline" id="Configuring_the_boot_loader">Configuring the boot loader</span></h3>
<p>In order to unlock the encrypted root partition at boot, the following kernel parameters need to be set by the boot loader: 
</p>
<pre>cryptdevice=UUID=<i>&lt;device-UUID&gt;</i>:cryptroot root=/dev/mapper/cryptroot
</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#Boot_loader" title="Dm-crypt/System configuration">Dm-crypt/System configuration#Boot loader</a> for details.
</p>
<p>The <code><i>&lt;device-UUID&gt;</i></code> refers to the UUID of <code>/dev/sdaX</code>, see <a href="../../en/Persistent_block_device_naming.html" title="Persistent block device naming">Persistent block device naming</a> for details.
</p>
<h2><span class="mw-headline" id="LVM_on_LUKS">LVM on LUKS</span></h2>
<p>The straight-forward method is to set up <a href="../../en/LVM.html" title="LVM">LVM</a> on top of the encrypted partition instead of the other way round. Technically the LVM is setup inside one big encrypted blockdevice. Hence, the LVM is not transparent until the blockdevice is unlocked and the underlying volume structure is scanned and mounted during boot. 
</p>
<p>The disk layout in this example is: 
</p>
<pre>+-----------------------------------------------------------------------+ +----------------+
| Logical volume1       | Logical volume2       | Logical volume3       | |                |
|/dev/mapper/MyVol-swap |/dev/mapper/MyVol-root |/dev/mapper/MyVol-home | | Boot partition |
|_ _ _ _ _ _ _ _ _ _ _ _|_ _ _ _ _ _ _ _ _ _ _ _|_ _ _ _ _ _ _ _ _ _ _ _| | (may be on     |
|                                                                       | | other device)  |
|                        LUKS encrypted partition                       | |                |
|                          /dev/sdaX                                    | | /dev/sdbY      |
+-----------------------------------------------------------------------+ +----------------+
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>This method does not allow you to span the logical volumes over multiple disks easily; see <a href="../../en/Dm-crypt/Specialties.html#Modifying_the_encrypt_hook_for_multiple_partitions" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Modifying_the_encrypt_hook_for_multiple_partitions</a>.</div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Two variants of this setup: 
<ul>
<li> Instructions at <a href="../../en/Dm-crypt/Specialties.html#Encrypted_system_using_a_remote_LUKS_header" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Encrypted system using a remote LUKS header</a> use this setup with a remote LUKS header on a USB device to achieve a two factor authentication with it. </li>
<li> Instructions at <a rel="nofollow" class="external text" href="http://www.pavelkogan.com/2014/05/23/luks-full-disk-encryption/">Pavel Kogan's blog</a> show how to encrypt the <code>/boot</code> partition while keeping it on the main LUKS partition when using GRUB.</li>
</ul>
</div> 
<h3><span class="mw-headline" id="Preparing_the_disk_2">Preparing the disk</span></h3>
<p>Prior to creating any partitions, you should inform yourself about the importance and methods to securely erase the disk, described in <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation</a>.
</p>
<p>When using the <a href="../../en/GRUB.html" title="GRUB">GRUB</a> bootloader together with <a href="../../en/Partitioning.html#GUID_Partition_Table" title="GPT" class="mw-redirect">GPT</a>, create a BIOS Boot Partition as explained in <a href="../../en/GRUB.html#BIOS_systems" title="GRUB">GRUB#BIOS systems</a>.
</p>
<p>Create a partition to be mounted at <code>/boot</code> of type <code>8300</code> with a size of 100 MB or more.
</p>
<p>Create a partition of type <code>8E00</code>, which will later contain the encrypted container.
</p>
<p>Create the LUKS encrypted container at the "system" partition. Enter the chosen password twice.
</p>
<pre># cryptsetup luksFormat /dev/<i>sdaX</i>
</pre>
<p>For more information about the available cryptsetup options see the <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">LUKS encryption options</a> prior to above command.
</p>
<p>Open the container:
</p>
<pre># cryptsetup open --type luks /dev/<i>sdaX</i> lvm
</pre>
<p>The decrypted container is now available at <code>/dev/mapper/lvm</code>.
</p>
<h3><span class="mw-headline" id="Preparing_the_logical_volumes">Preparing the logical volumes</span></h3>
<p>Create a physical volume on top of the opened LUKS container:
</p>
<pre># pvcreate /dev/mapper/lvm
</pre>
<p>Create the volume group named <code>MyVol</code> (or whatever you want), adding the previously created physical volume to it:
</p>
<pre># vgcreate MyVol /dev/mapper/lvm
</pre>
<p>Create all your logical volumes on the volume group:
</p>
<pre># lvcreate -L 8G MyVol -n swap
# lvcreate -L 15G MyVol -n root
# lvcreate -l 100%FREE MyVol -n home
</pre>
<p>Format your filesystems on each logical volume:
</p>
<pre># mkfs.ext4 /dev/mapper/MyVol-root
# mkfs.ext4 /dev/mapper/MyVol-home
# mkswap /dev/mapper/MyVol-swap
</pre>
<p>Mount your filesystems:
</p>
<pre># mount /dev/mapper/MyVol-root /mnt
# mkdir /mnt/home
# mount /dev/mapper/MyVol-home /mnt/home
# swapon /dev/mapper/MyVol-swap
</pre>
<h3><span class="mw-headline" id="Preparing_the_boot_partition_2">Preparing the boot partition</span></h3>
<p>The bootloader loads the kernel, <a href="../../en/Mkinitcpio.html" title="Initramfs" class="mw-redirect">initramfs</a>, and its own configuration files from the <code>/boot</code> directory. This directory must be located on a separate unencrypted filesystem. 
</p>
<p>Create an Ext2 filesystem on the partition intended for <code>/boot</code>. Any filesystem that can be read by the bootloader is eligible.
</p>
<pre># mkfs.ext2 /dev/<i>sdbY</i>
</pre>
<p>Create the directory <code>/mnt/boot</code>:
</p>
<pre># mkdir /mnt/boot
</pre>
<p>Mount the partition to <code>/mnt/boot</code>:
</p>
<pre># mount /dev/<i>sdbY</i> /mnt/boot
</pre>
<p>Afterwards continue with the installation procedure up to the <code>mkinitcpio</code> step.
</p>
<h3><span class="mw-headline" id="Configuring_mkinitcpio_2">Configuring mkinitcpio</span></h3>
<p>Add the <code>encrypt</code> and <code>lvm2</code> hooks to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS="... <b>encrypt</b> <b>lvm2</b> ... filesystems ..."</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">dm-crypt/System configuration#mkinitcpio</a> for details and other hooks that you may need.
</p>
<h3><span class="mw-headline" id="Configuring_the_boot_loader_2">Configuring the boot loader</span></h3>
<p>In order to unlock the encrypted root partition at boot, the following kernel parameter needs to be set by the boot loader:
</p>
<pre>cryptdevice=UUID=<i>device-UUID</i>:lvm
</pre>
<p>The <code><i>&lt;device-UUID&gt;</i></code> refers to the UUID of <code>/dev/sdaX</code>, see <a href="../../en/Persistent_block_device_naming.html" title="Persistent block device naming">Persistent block device naming</a> for details.
</p>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#Boot_loader" title="Dm-crypt/System configuration">Dm-crypt/System configuration#Boot loader</a> for details.
</p>
<h2><span class="mw-headline" id="LUKS_on_LVM">LUKS on LVM</span></h2>
<p>To use encryption on top of <a href="../../en/LVM.html" title="LVM">LVM</a>, the LVM volumes are set up first and then used as the base for the encrypted partitions. This way, a mixture of encrypted and non-encrypted volumes/partitions is possible as well. 
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Unlike <a href="#LVM_on_LUKS">#LVM on LUKS</a>, this method allows normally spanning the logical volumes over multiple disks. </div>
<p>The following short example creates a LUKS on LVM setup and mixes in the use of a key-file for the /home partition and temporary crypt volumes for <code>/tmp</code> and <code>/swap</code>. The latter is considered desirable from a security perspective, because no potentially sensitive temporary data survives the reboot, when the encryption is re-initialised. If you are experienced with LVM, you will be able to ignore/replace LVM and other specifics according to your plan. If you want to span a logical volume over multiple disks during setup already, a procedure to do so is described in <a href="../../en/Dm-crypt/Specialties.html#Expanding_LVM_on_multiple_disks" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Expanding LVM on multiple disks</a>.
</p>
<div class="noprint archwiki-template-message">
<p><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The intro of this scenario needs some adjustment now that a comparison has been added to <a href="#Overview">#Overview</a>. A suggested structure is to make it similar to the <a href="#Simple_partition_layout_with_LUKS">#Simple partition layout with LUKS</a> intro. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Dm-crypt/Encrypting_an_entire_system">Talk:Dm-crypt/Encrypting an entire system#</a>)</div>
</div>
<h3><span class="mw-headline" id="Preparing_the_disk_3">Preparing the disk</span></h3>
<p>Partitioning scheme:
</p>
<ul>
<li> <code>/dev/sda1</code> -&gt; <code>/boot</code>
</li>
<li> <code>/dev/sda2</code> -&gt; LVM</li>
</ul>
<p>Randomise <code>/dev/sda2</code> according to <a href="../../en/Dm-crypt/Drive_preparation.html#dm-crypt_wipe_on_an_empty_disk_or_partition" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation#dm-crypt wipe on an empty disk or partition</a>.
</p>
<h3><span class="mw-headline" id="Preparing_the_logical_volumes_2">Preparing the logical volumes</span></h3>
<pre># lvm pvcreate /dev/sda2
# lvm vgcreate lvm /dev/sda2
# lvm lvcreate -L 10G -n lvroot lvm
# lvm lvcreate -L 500M -n swap lvm
# lvm lvcreate -L 500M -n tmp lvm
# lvm lvcreate -l 100%FREE -n home lvm
</pre>
<pre># cryptsetup luksFormat -c aes-xts-plain64 -s 512 /dev/lvm/lvroot
# cryptsetup open --type luks /dev/lvm/lvroot root
# mkfs -t ext4 /dev/mapper/root
# mount /dev/mapper/root /mnt
</pre>
<p>More information about the encryption options can be found in <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Encryption options for LUKS mode</a>.
Note that <code>/home</code> will be encrypted in <a href="#Encrypting_logical_volume_.2Fhome">#Encrypting logical volume /home</a>. Further, note that if you ever have to access the encrypted root from the Arch-ISO, the above <code>open</code> action will allow you to after the <a href="../../en/LVM.html#Logical_Volumes_do_not_show_up" title="LVM">LVM shows up</a>.
</p>
<h3><span class="mw-headline" id="Preparing_the_boot_partition_3">Preparing the boot partition</span></h3>
<pre># dd if=/dev/zero of=/dev/sda1 bs=1M
# mkfs -t ext4 /dev/sda1
# mkdir /mnt/boot
# mount /dev/sda1 /mnt/boot
</pre>
<p>Now after setup of the encrypted LVM partitioning, it would be time to install: <a href="../../en/Installation_guide.html#Mount_the_partitions" title="Installation guide">Arch Install Scripts</a>.
</p>
<h3><span class="mw-headline" id="Configuring_mkinitcpio_3">Configuring mkinitcpio</span></h3>
<p>Add the <code>lvm2</code> and <code>encrypt</code> hooks to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS="... <b>block<i> ''</i>encrypt</b> <b>lvm2</b> ... filesystems ..."</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">dm-crypt/System configuration#mkinitcpio</a> for details and other hooks that you may need.
</p>
<h3><span class="mw-headline" id="Configuring_the_boot_loader_3">Configuring the boot loader</span></h3>
<p>In order to unlock the encrypted root partition at boot, the following kernel parameters need to be set by the boot loader:
</p>
<pre>cryptdevice=/dev/lvm/lvroot:cryptoroot root=/dev/mapper/cryptoroot
</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#Boot_loader" title="Dm-crypt/System configuration">Dm-crypt/System configuration#Boot loader</a> for details.
</p>
<h3><span class="mw-headline" id="Configuring_fstab_and_crypttab">Configuring fstab and crypttab</span></h3>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
 /dev/mapper/root        /       ext4            defaults        0       1
 /dev/sda1               /boot   ext4            defaults        0       2
 /dev/mapper/tmp         /tmp    tmpfs           defaults        0       0
 /dev/mapper/swap        none    swap            sw              0       0</pre>
<p>The following <a href="../../en/Dm-crypt/System_configuration.html#crypttab" title="Dm-crypt/System configuration">crypttab</a> options will re-encrypt the temporary filesystems each reboot:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
 swap	/dev/lvm/swap	/dev/urandom	swap,cipher=aes-xts-plain64,size=256
 tmp	/dev/lvm/tmp	/dev/urandom	tmp,cipher=aes-xts-plain64,size=256</pre>
<h3><span class="mw-headline" id="Encrypting_logical_volume_.2Fhome">Encrypting logical volume /home</span></h3>
<p>Since this scenario uses LVM as the primary and dm-crypt as secondary mapper, each encrypted logical volume requires its own encryption. Yet, unlike the temporary filesystems configured with volatile encryption above, the logical volume for <code>/home</code> should be persistent, of course. The following assumes you have rebooted into the installed system, otherwise you have to adjust paths. 
To safe on entering a second passphrase at boot for it, a <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">keyfile</a> is created: 
</p>
<pre>mkdir -m 700 /etc/luks-keys
dd if=/dev/random of=/etc/luks-keys/home bs=1 count=256
</pre>
<p>The logical volume is encrypted with it: 
</p>
<pre>cryptsetup luksFormat -v -s 512 /dev/lvm/home /etc/luks-keys/home
cryptsetup -d /etc/luks-keys/home open --type luks /dev/lvm/home home
mkfs -t ext4 /dev/mapper/home
mount /dev/mapper/home /home
</pre>
<p>The encrypted mount is configured in <a href="../../en/Dm-crypt/System_configuration.html#crypttab" title="Dm-crypt/System configuration">crypttab</a>: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
home	/dev/lvm/home   /etc/luks-keys/home</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
/dev/mapper/home        /home   ext4        defaults        0       2</pre>
<p>and setup is done.
</p>
<p>If you want to expand the logical volume for <code>/home</code> (or any other volume) at a later point, it is important to note that the LUKS encrypted part has to be resized as well. For a procedure see <a href="../../en/Dm-crypt/Specialties.html#Expanding_LVM_on_multiple_disks" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Expanding LVM on multiple disks</a>.
</p>
<h2><span class="mw-headline" id="LUKS_on_software_RAID">LUKS on software RAID</span></h2>
<div class="noprint archwiki-template-message">
<p><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../../File:Tango-view-fullscreen.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Some references: <a href="../../en/RAID.html" title="RAID">RAID</a>, <a href="../../en/Software_RAID_and_LVM.html" title="Software RAID and LVM">Software RAID and LVM</a>, <a rel="nofollow" class="external free" href="http://wiki.drewhess.com/wiki/Creating_an_encrypted_filesystem_on_a_partition">http://wiki.drewhess.com/wiki/Creating_an_encrypted_filesystem_on_a_partition</a> , <a rel="nofollow" class="external free" href="http://jasonwryan.com/blog/2012/02/11/lvm/">http://jasonwryan.com/blog/2012/02/11/lvm/</a> . Note that full-disk encryption is <a rel="nofollow" class="external text" href="https://forums.gentoo.org/viewtopic-p-7029704.html">not deniable</a> with this configuration (consider RAID on LUKS instead?). (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Dm-crypt/Encrypting_an_entire_system">Talk:Dm-crypt/Encrypting an entire system#</a>)</div>
</div>
<h2><span class="mw-headline" id="Plain_dm-crypt">Plain dm-crypt</span></h2>
<p>Contrary to LUKS, dm-crypt <i>plain</i> mode does not require a header on the encrypted device: this scenario exploits this feature to set up a system on an unpartitioned, encrypted disk that will be indistinguishable from a disk filled with random data, which could allow <a href="https://en.wikipedia.org/wiki/Deniable_encryption" class="extiw" title="wikipedia:Deniable encryption">deniable encryption</a>. See also <a href="https://en.wikipedia.org/wiki/Disk_encryption#Full_disk_encryption" class="extiw" title="wikipedia:Disk encryption">wikipedia:Disk encryption#Full disk encryption</a>.
</p>
<p>Note that if full-disk encryption is not required, the methods using LUKS described in the sections above are better options for both system encryption and encrypted partitions. LUKS features like key management with multiple passphrases/key-files or re-encrypting a device in-place are unavailable with <i>plain</i> mode.
</p>
<p><i>Plain</i> dm-crypt encryption can be more resilient to damage than LUKS, because it does not rely on an encryption master-key which can be a single-point of failure if damaged. However, using <i>plain</i> mode also requires more manual configuration of encryption options to achieve the same cryptographic strength. See also <a href="../../en/Disk_encryption.html#Cryptographic_metadata" title="Disk encryption">Disk encryption#Cryptographic metadata</a>. Using <i>plain</i> mode could also be considered if concerned with the problems explained in <a href="../../en/Dm-crypt/Specialties.html#Discard.2FTRIM_support_for_solid_state_drives_.28SSD.29" title="Dm-crypt/Specialties">Dm-crypt/Specialties#Discard/TRIM support for solid state drives (SSD)</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>If headerless encryption is your goal but you are unsure about the lack of key-derivation with <i>plain</i> mode, then two alternatives are: 
<ul>
<li> <a href="../../en/Tcplay.html" title="Tcplay">tcplay</a> which offers headerless encryption but with the PBKDF2 function, or </li>
<li> dm-crypt LUKS mode by using the <i>cryptsetup</i> <code>--header</code> option. It cannot be used with the standard <i>encrypt</i> hook, but the hook <a href="../../en/Dm-crypt/Specialties.html#Encrypted_system_using_a_remote_LUKS_header" title="Dm-crypt/Specialties">may be modified</a>.</li>
</ul>
</div>
<p>The scenario uses two USB sticks:
</p>
<ul>
<li> one for the boot device, which also allows storing the options required to open/unlock the plain encrypted device in the boot loader configuration, since typing them on each boot would be error prone;</li>
<li> another for the encryption key file, assuming it stored as raw bits so that to the eyes of an unaware attacker who might get the usbkey the encryption key will appear as random data instead of being visible as a normal file. See also <a href="https://en.wikipedia.org/wiki/Security_through_obscurity" class="extiw" title="wikipedia:Security through obscurity">Wikipedia:Security through obscurity</a>, follow <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Keyfiles</a> to prepare the keyfile.</li>
</ul>
<p>The disk layout is: 
</p>
<pre>+--------------------+------------------+--------------------+ +---------------+ +---------------+
|Volume 1:           |Volume 2:         |Volume 3:           | |Boot device    | |Encryption key |
|                    |                  |                    | |               | |file storage   |
|root                |swap              |home                | |/boot          | |(unpartitioned |
|                    |                  |                    | |               | |in example)    |
|/dev/store/root     |/dev/store/swap   |/dev/store/home     | |/dev/sdY1      | |/dev/sdZ       |
|--------------------+------------------+--------------------| |---------------| |---------------|
|disk drive /dev/sdaX encrypted using plain mode and LVM     | |USB stick 1    | |USB stick 2    |
+------------------------------------------------------------+ +---------------+ +---------------+
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>
<ul>
<li> It is also possible to use a single usb key by copying the keyfile to the initram directly. An example keyfile <code>/etc/keyfile</code> gets copied to the initram image by setting <code>FILES="/etc/keyfile"</code> in <code>/etc/mkinitcpio.conf</code>. The way to instruct the <code>encrypt</code> hook to read the keyfile in the initram image is using <code>rootfs:</code> prefix before the filename, e.g. <code>cryptkey=rootfs:/etc/keyfile</code>. </li>
<li> Another option is using a passphrase with good <a href="../../en/Disk_encryption.html#Choosing_a_strong_passphrase" title="Disk encryption">entropy</a>.</li>
</ul>
</div>
<h3><span class="mw-headline" id="Preparing_the_disk_4">Preparing the disk</span></h3>
<p>It is vital that the mapped device is filled with data. In particular this applies to the scenario usecase we apply here. 
</p>
<p>See <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation</a> and <a href="../../en/Dm-crypt/Drive_preparation.html#dm-crypt_specific_methods" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation#dm-crypt specific methods</a>
</p>
<h3><span class="mw-headline" id="Preparing_the_non-boot_partitions">Preparing the non-boot partitions</span></h3>
<p>See <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_plain_mode" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Encryption options for plain mode</a> for details. 
</p>
<p>Using the device <code>/dev/sd<i>X</i></code>, with the twofish-xts cipher with a 512 bit key size and using a keyfile we have the following options for this scenario: 
</p>
<pre># cryptsetup --hash=sha512 --cipher=twofish-xts-plain64 --offset=0 --key-file=/dev/sd<i>Z</i> --key-size=512 open --type=plain /dev/sdX enc</pre>
<p>Unlike encrypting with LUKS, the above command must be executed <i>in full</i> whenever the mapping needs to be re-established, so it is important to remember the cipher, hash and key file details. 
</p>
<p>We can now check a mapping entry has been made for <code>/dev/mapper/enc</code>:
</p>
<pre># fdisk -l
</pre>
<p>Next, we setup <a href="../../en/LVM.html" title="LVM">LVM</a> logical volumes on the mapped device, see <a href="../../en/LVM.html#Installing_Arch_Linux_on_LVM" title="LVM">LVM#Installing Arch Linux on LVM</a> for further details: 
</p>
<pre># pvcreate /dev/mapper/enc
# vgcreate store /dev/mapper/enc
# lvcreate -L 20G store -n root
# lvcreate -L 10G store -n swap
# lvcreate -l 100%FREE store -n home
</pre>
<p>We format and mount them and activate swap, see <a href="../../en/File_systems.html#Create_a_file_system" title="File systems">File systems#Create a file system</a> for further details: 
</p>
<pre># mkfs.ext4 /dev/store/root
# mkfs.ext4 /dev/store/home
# mount /dev/store/root /mnt
# mkdir /mnt/home
# mount /dev/store/home /mnt/home
# mkswap /dev/store/swap
# swapon /dev/store/swap
</pre>
<h3><span class="mw-headline" id="Preparing_the_boot_partition_4">Preparing the boot partition</span></h3>
<p>The <code>/boot</code> partition can be installed on the standard vfat partition of a USB stick, if required. But if manual partitioning is needed, then a small 200MB partition is all that is required. Create the partition using a <a href="../../en/Partitioning.html#Partitioning_tools" title="Partitioning">partitioning tool</a> of your choice.
</p>
<p>We choose a non-journalling file system to preserve the flash memory of the <code>/boot</code> partition, if not already formatted as vfat:
</p>
<pre># mkfs.ext2 /dev/sd<i>Y</i>1
# mkdir /mnt/boot
# mount /dev/sd<i>Y</i>1 /mnt/boot
</pre>
<h3><span class="mw-headline" id="Configuring_mkinitcpio_4">Configuring mkinitcpio</span></h3>
<p>Add the <code>encrypt</code> and <code>lvm2</code> hooks to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS="... <b>encrypt</b> <b>lvm2</b> ... filesystems ..."</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">dm-crypt/System configuration#mkinitcpio</a> for details and other hooks that you may need.
</p>
<h3><span class="mw-headline" id="Configuring_the_boot_loader_4">Configuring the boot loader</span></h3>
<p>In order to boot the encrypted root partition, the following kernel parameters need to be set by the boot loader:
</p>
<pre>cryptdevice=/dev/sd<i>X</i>:enc cryptkey=/dev/sd<i>Z</i>:0:512 crypto=sha512:twofish-xts-plain64:512:0:
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If using sd-encrypt instead of encrypt, use <code><i>luks.uuid</i></code> instead of cryptdevice, see <i>systemd-cryptsetup-generator(8)</i>.</div>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#Boot_loader" title="Dm-crypt/System configuration">Dm-crypt/System configuration#Boot loader</a> for details and other parameters that you may need.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>If using GRUB, you can install it on the same USB as the <code>/boot</code> partition with:
<pre># grub-install --recheck /dev/sd<i>Y</i>
</pre>
</div>
<h3><span class="mw-headline" id="Post-installation">Post-installation</span></h3>
<p>You may wish to remove the USB sticks after booting. Since the <code>/boot</code> partition is not usually needed, the <code>noauto</code> option can be added to the relevant line in <code>/etc/fstab</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
# /dev/sd<i>Yn</i>
/dev/sd<i>Yn</i> /boot ext2 <b>noauto</b>,rw,noatime 0 2</pre>
<p>However, when an update to the kernel or bootloader is required, the <code>/boot</code> partition must be present and mounted. As the entry in <code>fstab</code> already exists, it can be mounted simply with:
</p>
<pre># mount /boot
</pre>
<h2><span class="mw-headline" id="Encrypted_boot_partition_.28GRUB.29">Encrypted boot partition (GRUB)</span></h2>
<p>This setup utilizes the same partition layout and configuration for the system's root partition as the previous <a href="#LVM_on_LUKS">#LVM on LUKS</a> section, with two distinct differences: 
</p>
<ol>
<li> The setup is performed for an <a href="../../en/Unified_Extensible_Firmware_Interface.html" title="UEFI" class="mw-redirect">UEFI</a> system and </li>
<li> A special feature of the <a href="../../en/GRUB.html" title="GRUB">GRUB</a> bootloader is used to additionally encrypt the boot partition <code>/boot</code>. See also <a href="../../en/GRUB.html#Boot_partition" title="GRUB">GRUB#Boot partition</a>.</li>
</ol>
<p>The disk layout in this example is: 
</p>
<pre>+---------------+----------------+----------------+----------------+----------------+
|ESP partition: |Boot partition: |Volume 1:       |Volume 2:       |Volume 3:       |
|               |                |                |                |                |
|/boot/efi      |/boot           |root            |swap            |home            |
|               |                |                |                |                |
|               |                |/dev/store/root |/dev/store/swap |/dev/store/home |
|/dev/sdaX      |/dev/sdaY       +----------------+----------------+----------------+
|<b>un</b>encrypted    |LUKS encrypted  |/dev/sdaZ encrypted using LVM on LUKS             |
+---------------+----------------+--------------------------------------------------+
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>All scenarios are intended as examples. It is, of course, possible to apply both of the two above distinct installation steps with the other scenarios as well. See also the variants linked in <a href="#LVM_on_LUKS">#LVM on LUKS</a>.</div> 
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>You can use <code>cryptboot</code> script from <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/cryptboot/">cryptboot</a></span><sup><small>AUR</small></sup> package for simplified encrypted boot management (mounting, unmounting, upgrading packages) and as a defense against <a rel="nofollow" class="external text" href="https://www.schneier.com/blog/archives/2009/10/evil_maid_attac.html">Evil Maid</a> attacks with <a href="../../en/Secure_Boot.html#Using_your_own_keys" title="Secure Boot">UEFI Secure Boot</a>. For more informations and limitations see <a rel="nofollow" class="external text" href="https://github.com/xmikos/cryptboot">cryptboot project</a> page.</div>
<h3><span class="mw-headline" id="Preparing_the_disk_5">Preparing the disk</span></h3>
<p>Prior to creating any partitions, you should inform yourself about the importance and methods to securely erase the disk, described in <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation</a>.
</p>
<p>Create an <a href="../../en/EFI_System_Partition.html" title="EFI System Partition">EFI System Partition</a> with an appropriate size, it will later be mounted at <code>/boot/efi</code>. 
</p>
<p>Create a partition to be mounted at <code>/boot</code> of type <code>8300</code> with a size of 100 MB or more.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>When using the <a href="../../en/GRUB.html" title="GRUB">GRUB</a> bootloader together with a BIOS/<a href="../../en/Partitioning.html#GUID_Partition_Table" title="GPT" class="mw-redirect">GPT</a>, create a BIOS Boot Partition as explained in <a href="../../en/GRUB.html#BIOS_systems" title="GRUB">GRUB#BIOS systems</a> instead of the ESP.</div>
<p>Create a partition of type <code>8E00</code>, which will later contain the encrypted container.
</p>
<p>Create the LUKS encrypted container at the "system" partition. 
</p>
<pre># cryptsetup luksFormat /dev/<i>sdaZ</i>
</pre>
<p>For more information about the available cryptsetup options see the <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">LUKS encryption options</a> prior to above command.
</p>
<p>Your partition layout should look similar to this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"> gdisk /dev/sda </pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
Number  Start (sector)    End (sector)  Size       Code  Name
   1            2048         1050623   512.0 MiB   EF00  EFI System
   2         1050624         1460223   200.0 MiB   8300  Linux filesystem
   3         1460224        41943006   19.3 GiB    8E00  Linux LVM
</pre>
<p>Open the container:
</p>
<pre># cryptsetup open --type luks /dev/<i>sdaZ</i> lvm
</pre>
<p>The decrypted container is now available at <code>/dev/mapper/lvm</code>.
</p>
<h3><span class="mw-headline" id="Preparing_the_logical_volumes_3">Preparing the logical volumes</span></h3>
<p>The LVM logical volumes of this example follow the exact layout as the previous scenario. Therefore, please follow <a href="#Preparing_the_logical_volumes">Preparing the logical volumes</a> above or adjust as required.
</p>
<h3><span class="mw-headline" id="Preparing_the_boot_partition_5">Preparing the boot partition</span></h3>
<p>The bootloader loads the kernel, <a href="../../en/Mkinitcpio.html" title="Initramfs" class="mw-redirect">initramfs</a>, and its own configuration files from the <code>/boot</code> directory. 
</p>
<p>First, create the LUKS container where the files will be located and installed into: 
</p>
<pre># cryptsetup luksFormat /dev/sda<i>Y</i> 
</pre>
<p>Next, open it: 
</p>
<pre># cryptsetup open /dev/sda<i>Y</i> cryptboot 
</pre>
<p>Create a filesystem on the partition intended for <code>/boot</code>. Any filesystem that can be read by the bootloader is eligible:
</p>
<pre># mkfs.ext2 /dev/mapper/<i>cryptboot</i>
</pre>
<p>Create the directory <code>/mnt/boot</code>:
</p>
<pre># mkdir /mnt/boot
</pre>
<p>Mount the partition to <code>/mnt/boot</code>:
</p>
<pre># mount /dev/mapper/<i>cryptboot</i> /mnt/boot
</pre>
<p>Create a mountpoint for the <a href="../../en/EFI_System_Partition.html" title="EFI System Partition">EFI System Partition</a> at <code>/boot/efi</code> for compatibility with <code>grub-install</code> and mount it:
</p>
<pre># mkdir /mnt/boot/efi
# mount /dev/<i>sdaX</i> /mnt/boot/efi
</pre>
<p>At this point, you should have the following partitions and logical volumes inside of <code>/mnt</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">lsblk</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
NAME              	  MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda                       8:0      0   200G  0 disk  
├─sda1                    8:1      0   512M  0 part  /boot/efi
├─sda2                    8:2      0   200M  0 part  
│ └─boot		  254:0    0   198M  0 crypt /boot
└─sda3                    8:3      0   100G  0 part  
  └─lvm                   254:1    0   100G  0 crypt 
    ├─MyStorage-swapvol   254:2    0     8G  0 lvm   [SWAP]
    ├─MyStorage-rootvol   254:3    0    15G  0 lvm   /
    └─MyStorage-homevol   254:4    0    77G  0 lvm   /home
</pre>
<p>Afterwards continue with the installation procedure up to the mkinitcpio step.
</p>
<h3><span class="mw-headline" id="Configuring_mkinitcpio_5">Configuring mkinitcpio</span></h3>
<p>Add the <code>encrypt</code> and <code>lvm2</code> hooks to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">HOOKS="... <b>encrypt</b> <b>lvm2</b> ... filesystems ..."</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">dm-crypt/System configuration#mkinitcpio</a> for details and other hooks that you may need.
</p>
<h3><span class="mw-headline" id="Configuring_the_boot_loader_5">Configuring the boot loader</span></h3>
<p>Configure GRUB to recognize the LUKS encrypted <code>/boot</code> partition and unlock the encrypted root partition at boot:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/default/grub</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">GRUB_CMDLINE_LINUX="... cryptdevice=UUID=<i>&lt;device-UUID&gt;</i>:lvm ..."
GRUB_ENABLE_CRYPTODISK=y</pre>
<p>See <a href="../../en/Dm-crypt/System_configuration.html#Boot_loader" title="Dm-crypt/System configuration">Dm-crypt/System configuration#Boot loader</a> and <a href="../../en/GRUB.html#Boot_partition" title="GRUB">GRUB#Boot partition</a> for details. The <code><i>&lt;device-UUID&gt;</i></code> refers to the UUID of <code>/dev/sdaZ</code> (the partition which holds the lvm containing the root filesystem), see <a href="../../en/Persistent_block_device_naming.html" title="Persistent block device naming">Persistent block device naming</a>.
</p>
<p>Generate GRUB's <a href="../../en/GRUB.html#Generate_the_main_configuration_file" title="GRUB">configuration</a> file and <a href="../../en/GRUB.html#Installation_2" title="GRUB">install</a> to the mounted ESP:
</p>
<pre># grub-mkconfig -o /boot/grub/grub.cfg
# grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=grub --recheck
</pre>
<p>If this finished without errors, GRUB should prompt for the passphrase to unlock the <code>/boot</code> partition after the next reboot.
</p>
<h3><span class="mw-headline" id="Configuring_fstab_and_crypttab_2">Configuring fstab and crypttab</span></h3>
<p>This section deals with extra configuration to let the system <b>mount</b> the encrypted <code>/boot</code>. 
</p>
<p>While GRUB asks for a passphrase to unlock the encrypted <code>/boot</code> after above instructions, the partition unlock is not passed on to the initramfs. Hence, <code>/boot</code> will not be available after the system has re-/booted, because the <code>encrypt</code> hook only unlocks the system's root. 
</p>
<p>If you used the <i>genfstab</i> script during installation, it will have generated <code>/etc/fstab</code> entries for the <code>/boot</code> and <code>/boot/efi</code> mount points already, but the system will fail to find the generated device mapper for the boot partition. To make it available, add it to <a href="../../en/Dm-crypt/System_configuration.html#crypttab" title="Dm-crypt/System configuration">crypttab</a>. For example: 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/crypttab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
cryptboot  /dev/sdaY      none        luks</pre>
<p>will make the system ask for the passphrase again (i.e. you have to enter it twice at boot: once for GRUB and once for systemd init). To avoid the double entry for unlocking <code>/boot</code>, follow the instructions at <a href="../../en/Dm-crypt/Device_encryption.html#Keyfiles" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Keyfiles</a> to: 
</p>
<ol>
<li> Create a <a href="../../en/Dm-crypt/Device_encryption.html#Storing_the_keyfile_on_a_filesystem" title="Dm-crypt/Device encryption">randomtext keyfile</a>, </li>
<li> Add the keyfile to the (<code>/dev/sdaY</code>) <a href="../../en/Dm-crypt/Device_encryption.html#Configuring_LUKS_to_make_use_of_the_keyfile" title="Dm-crypt/Device encryption">boot partition's LUKS header</a> and</li>
<li> Check the <code>/etc/fstab</code> entry and add the <code>/etc/crypttab</code> line to <a href="../../en/Dm-crypt/Device_encryption.html#Unlocking_a_secondary_partition_at_boot" title="Dm-crypt/Device encryption">unlock it automatically at boot</a>.</li>
</ol>
<p>If for some reason the keyfile fails to unlock the boot partition, systemd will fallback to ask for a passphrase to unlock and, in case that is correct, continue booting.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Optional post-installation steps: 
<ul>
<li> It may be worth considering to add the GRUB bootloader to the ignore list of <code>/etc/pacman.conf</code> in order to take particular control of when the bootloader (which includes its own encryption modules) is updated. </li>
<li> If you want to encrypt the <code>/boot</code> partition to protect against offline tampering threats, the <a href="../../en/Dm-crypt/Specialties.html#mkinitcpio-chkcryptoboot" title="Dm-crypt/Specialties">mkinitcpio-chkcryptoboot</a> hook has been contributed to help.</li>
</ul>
</div>
<h2><span class="mw-headline" id="Btrfs_subvolumes_with_swap">Btrfs subvolumes with swap</span></h2>
<p>The following example creates a full system encryption with LUKS using <a href="../../en/Btrfs.html" title="Btrfs">Btrfs</a> subvolumes to <a href="../../en/Btrfs.html#Mounting_subvolumes" title="Btrfs">simulate partitions</a>.
</p>
<p>If using UEFI, an <a href="../../en/EFI_System_Partition.html" title="EFI System Partition">EFI System Partition</a> (ESP) is required. <code>/boot</code> itself may reside on <code>/</code> and be encrypted; however, the ESP itself cannot be encrypted. In this example layout, the ESP is <code>/dev/sda<i>Y</i></code> and is mounted at <code>/boot/efi</code>. <code>/boot</code> itself is located on the system partition, <code>/dev/sda<i>X</i></code>.
</p>
<p>Since <code>/boot</code> resides on the encrypted <code>/</code>, <a href="../../en/GRUB.html" title="GRUB">GRUB</a> must be used as the bootloader because only GRUB can load modules necessary to decrypt <code>/boot</code> (e.g., crypto.mod, cryptodisk.mod and luks.mod) <a rel="nofollow" class="external autonumber" href="http://www.pavelkogan.com/2014/05/23/luks-full-disk-encryption/">[1]</a>. 
</p>
<p>Additionally an optional plain-encrypted <a href="../../en/Swap.html" title="Swap">swap</a> partition is shown.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>Do not use a <a href="../../en/Swap.html#Swap_file" title="Swap file" class="mw-redirect">swap file</a> instead of a separate partition, because this may result in data loss. See <a href="../../en/Btrfs.html#Swap_file" title="Btrfs">Btrfs#Swap file</a>.</div>
<pre>+--------------------------+--------------------------+--------------------------+
|ESP                       |System partition          |Swap partition            |
|<b>un</b>encrypted               |LUKS-encrypted            |plain-encrypted           |
|                          |                          |                          |
|/boot/efi                 |/                         |                          |
|/dev/sda<i>Y</i>                 |/dev/sda<i>X</i>                 |/dev/sda<i>Z</i>                 |
|--------------------------+--------------------------+--------------------------+
</pre>
<h3><span class="mw-headline" id="Preparing_the_disk_6">Preparing the disk</span></h3>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>It is not possible to use btrfs partitioning as described in <a href="../../en/Btrfs.html#Partitionless_Btrfs_disk" title="Btrfs">Btrfs#Partitionless Btrfs disk</a> when using LUKS. Traditional partitioning must be used, even if it is just to create one partition.</div>
<p>Prior to creating any partitions, you should inform yourself about the importance and methods to securely erase the disk, described in <a href="../../en/Dm-crypt/Drive_preparation.html" title="Dm-crypt/Drive preparation">Dm-crypt/Drive preparation</a>. If you are using <a href="../../en/Unified_Extensible_Firmware_Interface.html" title="UEFI" class="mw-redirect">UEFI</a> create an <a href="../../en/EFI_System_Partition.html" title="EFI System Partition">EFI System Partition</a> with an appropriate size. It will later be mounted at <code>/boot/efi</code>. If you are going to create an encrypted swap partition, create the partition for it, but do <b>not</b> mark it as swap, since plain <i>dm-crypt</i> will be used with the partition.
</p>
<p>Create the needed partitions, at least one for <code>/</code> (e.g. <code>/dev/sda<i>X</i></code>). See the <a href="../../en/Partitioning.html" title="Partitioning">Partitioning</a> article.
</p>
<h3><span class="mw-headline" id="Preparing_the_system_partition">Preparing the system partition</span></h3>
<h4><span class="mw-headline" id="Create_LUKS_container">Create LUKS container</span></h4>
<p>Follow <a href="../../en/Dm-crypt/Device_encryption.html#Encrypting_devices_with_LUKS_mode" title="Dm-crypt/Device encryption">dm-crypt/Device encryption#Encrypting devices with LUKS mode</a> to setup <code>/dev/sda<i>X</i></code> for LUKS. See the <a href="../../en/Dm-crypt/Device_encryption.html#Encryption_options_for_LUKS_mode" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Encryption options for LUKS mode</a> before doing so for a list of encryption options.
</p>
<h4><span class="mw-headline" id="Unlock_LUKS_container">Unlock LUKS container</span></h4>
<p>Now follow <a href="../../en/Dm-crypt/Device_encryption.html#Unlocking.2FMapping_LUKS_partitions_with_the_device_mapper" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#Unlocking/Mapping LUKS partitions with the device mapper</a> to unlock the LUKS container and map it.
</p>
<h4><span class="mw-headline" id="Format_mapped_device">Format mapped device</span></h4>
<p>Proceed to format the mapped device as described in <a href="../../en/Btrfs.html#File_system_on_a_single_device" title="Btrfs">Btrfs#File system on a single device</a>, where <code><i>/dev/partition</i></code> is the name of the mapped device (i.e., <code>cryptroot</code>) and <b>not</b> <code>/dev/sda<i>X</i></code>.
</p>
<h4><span class="mw-headline" id="Mount_mapped_device">Mount mapped device</span></h4>
<p>Finally, <a href="../../en/File_systems.html#Mount_a_file_system" title="Mount" class="mw-redirect">mount</a> the now-formatted mapped device (i.e., <code>/dev/mapper/cryptroot</code>) to <code>/mnt</code>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>You may want to use the <code>compress=lzo</code> mount option. See <a href="../../en/Btrfs.html#Compression" title="Btrfs">Btrfs#Compression</a> for more information.</div>
<h3><span class="mw-headline" id="Creating_btrfs_subvolumes">Creating btrfs subvolumes</span></h3>
<h4><span class="mw-headline" id="Layout">Layout</span></h4>
<p><a href="../../en/Btrfs.html#Subvolumes" title="Btrfs">Subvolumes</a> will be used to simulate partitions, but other (nested) subvolumes will also be created. Here is a partial representation of what the following example will generate:
</p>
<pre>subvolid=5 (/dev/sda<i>X</i>)
   |
   ├── @ (mounted as /)
   |       |
   |       ├── /bin (directory)
   |       |
   |       ├── /home (mounted @home subvolume)
   |       |
   |       ├── /usr (directory)
   |       |
   |       ├── /.snapshots (mounted @snapshots subvolume)
   |       |
   |       ├── /var/cache/pacman/pkg (nested subvolume)
   |       |
   |       ├── ... (other directories and nested subvolumes)
   |
   ├── @snapshots (mounted as /.snapshots)
   |
   ├── @home (mounted as /home)
   |
   └── @... (additional subvolumes you wish to use as mount points)
</pre>
<p>This section follows the <a href="../../en/Snapper.html#Suggested_filesystem_layout" title="Snapper">Snapper#Suggested filesystem layout</a>, which is most useful when used with <a href="../../en/Snapper.html" title="Snapper">Snapper</a>. You should also consult <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Layout">Btrfs Wiki SysadminGuide#Layout</a>.
</p>
<h4><span class="mw-headline" id="Create_top-level_subvolumes">Create top-level subvolumes</span></h4>
<p>Here we are using the convention of prefixing <code>@</code> to subvolume names that will be used as mount points, and <code>@</code> will be the subvolume that is mounted as <code>/</code>.
</p>
<p>Following the <a href="../../en/Btrfs.html#Creating_a_subvolume" title="Btrfs">Btrfs#Creating a subvolume</a> article, create subvolumes at <code>/mnt/@</code>, <code>/mnt/@snapshots</code>, and <code>/mnt/@home</code>.
</p>
<p>Create any additional subvolumes you wish to use as mount points now.
</p>
<h4><span class="mw-headline" id="Mount_top-level_subvolumes">Mount top-level subvolumes</span></h4>
<p>Unmount the system partition at <code>/mnt</code>.
</p>
<p>Now mount the newly created <code>@</code> subvolume which will serve as <code>/</code> to <code>/mnt</code> using the <code>subvol=</code> mount option. Assuming the mapped device is named <code>cryptroot</code>, the command would look like:
</p>
<pre># mount -o compress=lzo,subvol=@ /dev/mapper/cryptroot /mnt
</pre>
<p>See <a href="../../en/Btrfs.html#Mounting_subvolumes" title="Btrfs">Btrfs#Mounting subvolumes</a> for more details.
</p>
<p>Also mount the other subvolumes to their respective mount points: <code>@home</code> to <code>/mnt/home</code> and <code>@snapshots</code> to <code>/mnt/.snapshots</code>.
</p>
<h4><span class="mw-headline" id="Create_nested_subvolumes">Create nested subvolumes</span></h4>
<p>Create any subvolumes you do <b>not</b> want to have snapshots of when taking a snapshot of <code>/</code>. For example, you probably do not want to take snapshots of <code>/var/cache/pacman/pkg</code>. These subvolumes will be nested under the <code>@</code> subvolume, but just as easily could have been created earlier at the same level as <code>@</code> according to your preference.
</p>
<p>Since the <code>@</code> subvolume is mounted at <code>/mnt</code> you will need to <a href="../../en/Btrfs.html#Creating_a_subvolume" title="Create a subvolume" class="mw-redirect">create a subvolume</a> at <code>/mnt/var/cache/pacman/pkg</code> for this example. You may have to create any parent directories first.
</p>
<p>Other directories you may wish to do this with are <code>/var/abs</code>, <code>/var/tmp</code>, and <code>/srv</code>.
</p>
<h4><span class="mw-headline" id="Mount_ESP">Mount ESP</span></h4>
<p>If you prepared an EFI system partition earlier, create its mount point and mount it now.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>Btrfs snapshots will exclude <code>/boot/efi</code>, since it is not a btrfs file system.</div>
<p>At the <a href="../../en/Installation_guide.html#Install_the_base_packages" title="Installation guide">pacstrap</a> installation step, the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> must be installed in addition to the base group.
</p>
<h3><span class="mw-headline" id="Configuring_mkinitcpio_6">Configuring mkinitcpio</span></h3>
<h4><span class="mw-headline" id="Create_keyfile">Create keyfile</span></h4>
<p>In order for GRUB to open the LUKS partition without having the user enter his passphrase twice, we will use a keyfile embedded in the initramfs. Follow <a href="../../en/Dm-crypt/Device_encryption.html#With_a_keyfile_embedded_in_the_initramfs" title="Dm-crypt/Device encryption">Dm-crypt/Device encryption#With a keyfile embedded in the initramfs</a> making sure to add the key to <code>/dev/sda<i>X</i></code> at the <i>luksAddKey</i> step.
</p>
<h4><span class="mw-headline" id="Edit_mkinitcpio.conf">Edit mkinitcpio.conf</span></h4>
<p>After creating, adding, and embedding the key as described above, add the <code>encrypt</code> hook to <a href="../../en/Mkinitcpio.html" title="Mkinitcpio.conf" class="mw-redirect">mkinitcpio.conf</a> as well as any other hooks you require. See <a href="../../en/Dm-crypt/System_configuration.html#mkinitcpio" title="Dm-crypt/System configuration">Dm-crypt/System configuration#mkinitcpio</a> for detailed information. Be sure to regenerate the initial ramdisk when finished.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>You may want to add <code>BINARIES="/usr/bin/btrfs"</code> to your <code>mkinitcpio.conf</code>. See the <a href="../../en/Btrfs.html#Corruption_recovery" title="Btrfs">Btrfs#Corruption recovery</a> article.</div>
<h3><span class="mw-headline" id="Configuring_the_boot_loader_6">Configuring the boot loader</span></h3>
<p>Install <a href="../../en/GRUB.html" title="GRUB">GRUB</a> to <code>/dev/sda</code>. Then, edit <code>/etc/default/grub</code> as instructed in the <a href="../../en/GRUB.html#Encryption" title="GRUB">GRUB#Encryption</a> article, following both the instructions for an encrypted root and boot partition. Finally, generate the GRUB configuration file.
</p>
<h3><span class="mw-headline" id="Configuring_swap">Configuring swap</span></h3>
<p>If you created a partition to be used for encrypted swap, now is the time to configure it. Follow the instructions at <a href="../../en/Dm-crypt/Swap_encryption.html" title="Dm-crypt/Swap encryption">Dm-crypt/Swap encryption</a>.
</p>
<p>After completing this step, continue configuring your system as normal according to the <a href="../../en/Installation_guide.html#Reboot" title="Installation guide">installation guide</a>.
</p>
</div>
<div id="catlinks" class="catlinks">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Categories</a>: <ul>
<li><a href="../../en/Category:Encryption.html" title="Category:Encryption">Encryption</a></li>
<li><a href="../../en/Category:File_systems.html" title="Category:File systems">File systems</a></li>
<li><a href="../../en/Category:Getting_and_installing_Arch.html" title="Category:Getting and installing Arch">Getting and installing Arch</a></li>
</ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden category: <ul><li><a href="../../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li></ul>
</div>
</div>					<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
						<ul id="f-list" style="margin: 0 2em">
									<li>
Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Dm-crypt/Encrypting_an_entire_system&amp;oldid=453953">https://wiki.archlinux.org/index.php?title=Dm-crypt/Encrypting_an_entire_system&amp;oldid=453953</a>"</li>
					<li id="lastmod"> This page was last modified on 14 October 2016, at 16:30.</li>
									<li id="copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
									<br><li id="privacy"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
									<li id="about"><a href="../../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
									<li id="disclaimer"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
							</ul>
		</div>
		</div>
		</body>
</html>
