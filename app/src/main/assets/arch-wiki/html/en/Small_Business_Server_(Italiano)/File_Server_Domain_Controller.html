<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8">
<title>Small Business Server (Italiano)/File Server Domain Controller - ArchWiki</title>
<link rel="stylesheet" href="../../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<style></style>
<meta name="generator" content="MediaWiki 1.26.4">
<meta name="robots" content="noindex,follow">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Small_Business_Server_Italiano_File_Server_Domain_Controller skin-archlinux action-view">

		<div id="globalWrapper" style="width: 100%">
		<div id="column-content">
			<div id="content" class="mw-body" role="main" style="margin: 2em; margin-bottom: 0">
				<a id="top"></a>
				
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">Small Business Server (Italiano)/File Server Domain Controller</h1>
				
				<div id="bodyContent" class="mw-body-content">
					<div id="contentSub"><span class="subpages">&lt; <a href="../../it/Small_Business_Server.html" title="Small Business Server (Italiano)">Small Business Server (Italiano)</a></span></div>
										<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div id="toc" class="toc">
<div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Introduzione"><span class="tocnumber">1</span> <span class="toctext">Introduzione</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Samba"><span class="tocnumber">1.1</span> <span class="toctext">Samba</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Cos.E2.80.99e.E2.80.99_questa_guida_.3F"><span class="tocnumber">1.2</span> <span class="toctext">Cos’e’ questa guida ?</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Samba_Server_.C3.A8_meglio_di_Windows_Server_.3F"><span class="tocnumber">1.3</span> <span class="toctext">Samba Server è meglio di Windows Server ?</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Ma_allora_perch.C3.A9_usare_Samba_.3F"><span class="tocnumber">1.4</span> <span class="toctext">Ma allora perché usare Samba ?</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#E.E2.80.99_pi.C3.B9_facile_usare.2Famministrare_Windows_o_Linux.2FSamba_.3F"><span class="tocnumber">1.5</span> <span class="toctext">E’ più facile usare/amministrare Windows o Linux/Samba ?</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Sostituisco_i_miei_server_Windows_con_Linux.2FSamba_.3F"><span class="tocnumber">1.6</span> <span class="toctext">Sostituisco i miei server Windows con Linux/Samba ?</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8">
<a href="#Installazione"><span class="tocnumber">2</span> <span class="toctext">Installazione</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Operazioni_preliminari"><span class="tocnumber">2.1</span> <span class="toctext">Operazioni preliminari</span></a></li>
<li class="toclevel-2 tocsection-10">
<a href="#Il_repository_radioattivo"><span class="tocnumber">2.2</span> <span class="toctext">Il repository <i>radioattivo</i></span></a>
<ul>
<li class="toclevel-3 tocsection-11"><a href="#Attiviamo_il_repository"><span class="tocnumber">2.2.1</span> <span class="toctext">Attiviamo il repository</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-12">
<a href="#Installazione_pacchetti"><span class="tocnumber">2.3</span> <span class="toctext">Installazione pacchetti</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="#Samba_2"><span class="tocnumber">2.3.1</span> <span class="toctext">Samba</span></a></li>
<li class="toclevel-3 tocsection-14"><a href="#LDAP_Tools"><span class="tocnumber">2.3.2</span> <span class="toctext">LDAP Tools</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#Samba_LDAP_Schema"><span class="tocnumber">2.3.3</span> <span class="toctext">Samba LDAP Schema</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-16">
<a href="#Configurazione_autenticazione_LDAP"><span class="tocnumber">3</span> <span class="toctext">Configurazione autenticazione LDAP</span></a>
<ul>
<li class="toclevel-2 tocsection-17"><a href="#OpenLDAP_server"><span class="tocnumber">3.1</span> <span class="toctext">OpenLDAP server</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#LDAP_Tools_2"><span class="tocnumber">3.2</span> <span class="toctext">LDAP Tools</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#Popolare_LDAP"><span class="tocnumber">3.3</span> <span class="toctext">Popolare LDAP</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-20">
<a href="#Pianificazione_condivisioni"><span class="tocnumber">4</span> <span class="toctext">Pianificazione condivisioni</span></a>
<ul>
<li class="toclevel-2 tocsection-21">
<a href="#Gruppi"><span class="tocnumber">4.1</span> <span class="toctext">Gruppi</span></a>
<ul>
<li class="toclevel-3 tocsection-22"><a href="#Creiamo_gli_altri_gruppi"><span class="tocnumber">4.1.1</span> <span class="toctext">Creiamo gli altri gruppi</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#Creiamo_gli_utenti"><span class="tocnumber">4.1.2</span> <span class="toctext">Creiamo gli utenti</span></a></li>
<li class="toclevel-3 tocsection-24"><a href="#Assegniamo_gli_utenti_ai_gruppi"><span class="tocnumber">4.1.3</span> <span class="toctext">Assegniamo gli utenti ai gruppi</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-25">
<a href="#Condivisioni"><span class="tocnumber">4.2</span> <span class="toctext">Condivisioni</span></a>
<ul>
<li class="toclevel-3 tocsection-26">
<a href="#public"><span class="tocnumber">4.2.1</span> <span class="toctext">public</span></a>
<ul>
<li class="toclevel-4 tocsection-27"><a href="#La_.22rogna.22_dei_permessi_utente"><span class="tocnumber">4.2.1.1</span> <span class="toctext">La <i>"rogna"</i> dei permessi utente</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-28"><a href="#netlogon_.26_profiles"><span class="tocnumber">4.2.2</span> <span class="toctext">netlogon &amp; profiles</span></a></li>
<li class="toclevel-3 tocsection-29"><a href="#rootdir"><span class="tocnumber">4.2.3</span> <span class="toctext">rootdir</span></a></li>
<li class="toclevel-3 tocsection-30"><a href="#apps"><span class="tocnumber">4.2.4</span> <span class="toctext">apps</span></a></li>
<li class="toclevel-3 tocsection-31"><a href="#homes"><span class="tocnumber">4.2.5</span> <span class="toctext">homes</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-32">
<a href="#Configurazione_di_Samba"><span class="tocnumber">5</span> <span class="toctext">Configurazione di Samba</span></a>
<ul>
<li class="toclevel-2 tocsection-33"><a href="#Parametri_globali"><span class="tocnumber">5.1</span> <span class="toctext">Parametri globali</span></a></li>
<li class="toclevel-2 tocsection-34">
<a href="#Condivisioni_2"><span class="tocnumber">5.2</span> <span class="toctext">Condivisioni</span></a>
<ul>
<li class="toclevel-3 tocsection-35"><a href="#public_2"><span class="tocnumber">5.2.1</span> <span class="toctext">public</span></a></li>
<li class="toclevel-3 tocsection-36"><a href="#netlogon"><span class="tocnumber">5.2.2</span> <span class="toctext">netlogon</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-37"><a href="#smb.conf_completo"><span class="tocnumber">5.3</span> <span class="toctext">smb.conf completo</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-38"><a href="#Avvio_del_servizio"><span class="tocnumber">6</span> <span class="toctext">Avvio del servizio</span></a></li>
<li class="toclevel-1 tocsection-39">
<a href="#Join_al_dominio_e_scripts_di_manutenzione"><span class="tocnumber">7</span> <span class="toctext">Join al dominio e scripts di manutenzione</span></a>
<ul>
<li class="toclevel-2 tocsection-40"><a href="#Join_al_dominio"><span class="tocnumber">7.1</span> <span class="toctext">Join al dominio</span></a></li>
<li class="toclevel-2 tocsection-41"><a href="#Funziona_.3F"><span class="tocnumber">7.2</span> <span class="toctext">Funziona ?</span></a></li>
<li class="toclevel-2 tocsection-42">
<a href="#Scripts_di_manutenzione"><span class="tocnumber">7.3</span> <span class="toctext">Scripts di manutenzione</span></a>
<ul>
<li class="toclevel-3 tocsection-43"><a href="#purge"><span class="tocnumber">7.3.1</span> <span class="toctext">purge</span></a></li>
<li class="toclevel-3 tocsection-44"><a href="#setchown"><span class="tocnumber">7.3.2</span> <span class="toctext">setchown</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-45"><a href="#Firewall"><span class="tocnumber">7.4</span> <span class="toctext">Firewall</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="#Abbiamo_finito_.3F"><span class="tocnumber">7.5</span> <span class="toctext">Abbiamo finito ?</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-47">
<a href="#Gestione_dei_permessi"><span class="tocnumber">8</span> <span class="toctext">Gestione dei permessi</span></a>
<ul>
<li class="toclevel-2 tocsection-48"><a href="#Gli_utenti_Windows"><span class="tocnumber">8.1</span> <span class="toctext">Gli utenti Windows</span></a></li>
<li class="toclevel-2 tocsection-49"><a href="#Un_caso_pratico"><span class="tocnumber">8.2</span> <span class="toctext">Un caso pratico</span></a></li>
<li class="toclevel-2 tocsection-50"><a href="#Mettamoci_la_lavoro"><span class="tocnumber">8.3</span> <span class="toctext">Mettamoci la lavoro</span></a></li>
<li class="toclevel-2 tocsection-51"><a href="#Samba_non_c.27entra"><span class="tocnumber">8.4</span> <span class="toctext">Samba non c'entra</span></a></li>
<li class="toclevel-2 tocsection-52">
<a href="#ACL_POSIX"><span class="tocnumber">8.5</span> <span class="toctext">ACL POSIX</span></a>
<ul>
<li class="toclevel-3 tocsection-53"><a href="#setfacl_.26_getfacl"><span class="tocnumber">8.5.1</span> <span class="toctext">setfacl &amp; getfacl</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-54">
<a href="#Conclusioni"><span class="tocnumber">9</span> <span class="toctext">Conclusioni</span></a>
<ul>
<li class="toclevel-2 tocsection-55"><a href="#Print_services"><span class="tocnumber">9.1</span> <span class="toctext">Print services</span></a></li>
<li class="toclevel-2 tocsection-56"><a href="#Client_grafici_di_amministrazione"><span class="tocnumber">9.2</span> <span class="toctext">Client grafici di amministrazione</span></a></li>
<li class="toclevel-2 tocsection-57"><a href="#Quota"><span class="tocnumber">9.3</span> <span class="toctext">Quota</span></a></li>
<li class="toclevel-2 tocsection-58"><a href="#Comandi_Samba"><span class="tocnumber">9.4</span> <span class="toctext">Comandi Samba</span></a></li>
<li class="toclevel-2 tocsection-59"><a href="#Lock_sui_file"><span class="tocnumber">9.5</span> <span class="toctext">Lock sui file</span></a></li>
<li class="toclevel-2 tocsection-60"><a href="#Sicurezza"><span class="tocnumber">9.6</span> <span class="toctext">Sicurezza</span></a></li>
<li class="toclevel-2 tocsection-61"><a href="#Client_Linux"><span class="tocnumber">9.7</span> <span class="toctext">Client Linux</span></a></li>
<li class="toclevel-2 tocsection-62"><a href="#Concludiamo_managgia_.21"><span class="tocnumber">9.8</span> <span class="toctext">Concludiamo managgia !</span></a></li>
</ul>
</li>
</ul>
</div>

<h1><span class="mw-headline" id="Introduzione">Introduzione</span></h1>
<p>Questa parte della guida è, personale opinione, la più importante. Un file server in una azienda è sicuramente lo scopo principale per cui si installa un server (almeno inizialmente). Oramai nessuno può svolgere i compiti principali senza condivisione di dati tra utenti, e le soluzioni peer to peer di condivisione hanno limiti che non stò neanche a considerare qui. Prima di proseguire permettetemi di sintetizzare dei concetti di base che devono essere ben chiari prima di passare alla fase di implementazione della rete vera e propria.
</p>
<h2><span class="mw-headline" id="Samba">Samba</span></h2>
<p>Con GNU/Linux ho diverse possibilità di scelta, ma io considererò solo la soluzione <b>Samba</b> che mi permette di interagire ottimamente con dei clients Microsoft Windows che, volenti o dolenti, rappresentano il 98% del mercato desktop.
Samba è un grande, complesso progetto. Scopo del progetto è l’ interoperabilità il più trasparente possibile tra il mondo Microsoft Windows e i sistemi Unix/Linux.
Samba offre servizi di autenticazione e condivisione file e stampanti da una qualsiasi piattaforma TCP/IP enabled. Le piattaforme originali erano Unix e Linux,ma oggi vengono impiegati con successo anche altri tipi di sistemi.
</p>
<h2><span class="mw-headline" id="Cos.E2.80.99e.E2.80.99_questa_guida_.3F">Cos’e’ questa guida ?</span></h2>
<p>Ricordo ancora che questa guida <i>NON è una guida completa a  Samba e OpenLDAP</i>, oltre a quanto già ribadito presuppone anche che abbiate già una buona conoscenza di come funziona una rete Windows basata su un dominio.
Lo scopo che ci prefiggiamo qui è quello di descrivere in modo abbastanza esteso un caso di reale implementazione di una rete che utilizzano Microsoft Windows sui loro desktop e Linux, Samba e OpenLDAP su lato server in sostituzione dei prodotti server di Microsoft. Essendo un progetto di una certa complessità non bisogna trascurare il fatto che leggere le guide “ufficiali” molto ben fatte e aggiornate che trovate sul <a rel="nofollow" class="external text" href="http://www.samba.org">sito</a> è molto più di un consiglio: fare le cose senza capirle bene è una pessima abitudine.
</p>
<h2><span class="mw-headline" id="Samba_Server_.C3.A8_meglio_di_Windows_Server_.3F">Samba Server è meglio di Windows Server ?</span></h2>
<p>Ad essere sinceri, secondo me, la risposta è NO. Samba è fantastico nel “mascherare” le evidenti differenze tra le piattaforme Windows e Linux/Posix, il risultato non è perfetto, ma essendo un prodotto il continua e veloce evoluzione queste “imperfezioni” sono sempre meno percettibili. Và comunque detto che queste “imperfezioni” non si riferiscono alle funzionalità nei servizi offerti da Samba (questi oramai hanno raggiunto un grado di affidabilità molto elevata, considerando il fatto che milioni di PC nel mondo usano questi servizi), ma bensì al fatto di far credere ai client Windows che dalla parte server non c’e’ Samba ma un “regolare” server Windows. Non tutte le funzionalità sono state implementate (ad esempio i gruppi nidificati e le utili Group Policy) e quindi se voglio usare Samba qualche caratteristica avanzata deve essere lasciata da parte. Queste “mancanze” saranno dei macigni per un fido Microsoft sponsor, dei sassolini per chi, come me, non ama le guerre di religione Microsoft/Linux, ma cerca di cavare il meglio dalle due piattaforme. Pane al pane, vino al vino: Windows sui Desktop (per ora) e, ove possibile e conveniente, Linux sui Server.
Ricordiamoci, inoltre, che Samba NON puo’ agire come ADS (Active Directory) Domain Controller (Windows 2000/2003 server), ma puo’ efficacemente diventarne membro come server aggiuntivo. La funzionalità ADS domain controller sarà inclusa nella versione 4 di Samba ora in fase di sviluppo.
Samba 3 puo’ “emulare” un Domain Controller stile Windows NT 4 anche se con notevoli miglioramenti nella scalabilità dovuti in gran parte alla adozione di OpenLDAP come possibile backend (repository) per utenti, gruppi e passwords. Naturalmente dei server Windows 2000 o 2003 possono efficacemente essere inseriti in un dominio controllato da Samba 3 come server membri.
</p>
<h2><span class="mw-headline" id="Ma_allora_perch.C3.A9_usare_Samba_.3F">Ma allora perché usare Samba ?</span></h2>
<p>I motivi possono essere molti. Vi posso dire i miei personali. Ho optato per Samba perché :
</p>
<ul>
<li> Salute. Mi viene il mal di testa quando leggo le politiche licensing di Microsoft, non per i costi ma per il garbuglio di opzioni che cambiano ad ogni quando. Con Linux/Samba questi pensieri svaniscono per sempre.</li>
<li> Risparmio. Fate voi il conto di quanto costano le licenze per un dominio con il numero di PC nella vostra rete e il server. Attenzione però, inutile illudersi, generalmente i costi di manutenzione sono grossomodo gli stessi.</li>
<li> Sicurezza. Non voglio sindacare sul livello di sicurezza raggiunto da Windows (dipende naturalmente anche da chi lo installa), ma il fatto che Linux è molto meno preso di mira da virus e allegra brigata mi fa dormire sonni più tranquilli.</li>
<li> Single Signon. Con OpenLDAP riesco ad avere un unico repository dei dati utenti/password per tutti i servizi e server aziendali (posta, rete ecc.). Il cambio password di un utente non è più un incubo, ogni Desktop o Server, Windows o Linux che sia, viene autenticato centralmente nell’ albero OpenLDAP.</li>
</ul>
<h2><span class="mw-headline" id="E.E2.80.99_pi.C3.B9_facile_usare.2Famministrare_Windows_o_Linux.2FSamba_.3F">E’ più facile usare/amministrare Windows o Linux/Samba ?</span></h2>
<p>Qui sarebbe difficile trovare due persone con la stessa opinione. Personalmente vi posso dire che Windows e il suo Active Directory Services (ADS è un LDAP pesantemente personalizzato da Microsoft per lo scopo) è un eccellente prodotto e capire come realizzare un dominio con esso vuol dire masticare argomenti disparati quali LDAP, DNS, DHCP, TCP/IP, KERBEROS, WINS, e tutti gli aspetti inerenti ad una rete Microsoft: Primary Domain Controller (PDC), Backup Domain Controller (BDC), Browsing della rete, Access Control List (ACL) alle share, Profili Roaming eccetera. Insomma l’argomento è complesso, e avventurarsi in una installazione di questo tipo senza padroneggiare questi concetti è una <i>PESSIMA IDEA</i>.
E con Linux/Samba ? Stessa cosa, devo avere alba di cosa sia Linux, come si installa e come si amministra in modo almeno basilare, oltre a tutte le cose dette per Windows: LDAP, DNS, WINS, PDC, BDC, ACL, Profili Roaming ecc.. Ovviamente anche con Samba ci scontreremo con questi concetti basilari.
Alla fine della fiera la differenza sarà che con Windows ho dei comodi (ma a parer mio a volte diseducativi) tools grafici per fare il tutto, con Linux un mix tra tools grafici e cari e vecchi (ma efficaci) tools da linea di comando.
</p>
<h2><span class="mw-headline" id="Sostituisco_i_miei_server_Windows_con_Linux.2FSamba_.3F">Sostituisco i miei server Windows con Linux/Samba ?</span></h2>
<p>Mah, dipende. Se ho già un dominio Windows 2000/2003 ADS funzionante significa che ho già investito in licenze ed ammennicoli vari e sostituirlo con Samba non è che porta a svolte miracolose. Io eviterei, ribadisco che ADS è un buon prodotto. Se invece devo aggiungere un file server al dominio ADS, Samba puo’ essere una valida opzione.
Diverso il caso in cui dovessi aggiornare dei server Windows NT che ora Microsoft non segue più. Anche in questo caso la migrazione a Samba può essere una valida opzione.
</p>
<p>N.B. Se ho più server ricordiamoci un concetto importante : Se il PDC è Windows il/i BDC devono essere Windows, i server membri aggiuntivi sia Samba che Windows. Se il PDC è Samba il/i BDC devono essere Samba, i server membri aggiuntivi sia Samba che Windows.
</p>
<p>Bene, ora che è tutto chiaro (...) con possiamo iniziare :) .
</p>
<h1><span class="mw-headline" id="Installazione">Installazione</span></h1>
<p>Cominciamo con la configurazione del nostro file server <i>domain controller</i> basato su Samba e OpenLDAP. Come primo passo dedichiamoci all' installazione dei pacchetti necessari.
</p>
<h2><span class="mw-headline" id="Operazioni_preliminari">Operazioni preliminari</span></h2>
<p>In questo tipo di configurazioni è bene concentrarci sul singolo problema, evitando di correr dietro a cause esterne dovute ad altri servizi. Tutto questo per dire che se per caso avete attivato il firewall è giunto il momento di disattivarlo momentaneamente. Quando tutto funzionerà a dovere lo ripristineremo con le <i>rules</i> aggiuntive opportune. Quindi:
</p>
<pre>sudo /etc/rc.d/shorewall stop
</pre>
<p>In più abilitiamo momentaneamente **tutti** i protocolli :
</p>
<pre>sudo nano /etc/hosts.allow
</pre>
<p>e aggiungiamo la riga 
</p>
<pre>all: ALL : allow
</pre>
<p>Bene, ora che abbiamo eliminato eventuali cause esterne possiamo proseguire.
</p>
<h2><span class="mw-headline" id="Il_repository_radioattivo">Il repository <i>radioattivo</i></span></h2>
<p>Durante l'installazione ho, purtroppo, constatato che i pacchetti necessari in questa impresa non sono tutti disponibili né sui repository ufficiali nè su AUR. Certo, essendo degli script <i>perl</i> e delle librerie dello stesso, avrei potuto usare <i>CPAN</i> ed installare gli script a mano, ma finché posso voglio evitare questa pratica e allora (rullo di tamburi:)) ho creato un piccolo e <i>radioattivo</i> repository personale con quello che ci serve.
Creare un repository con Arch è veramente una operazione banale con il comando <i>repo-add</i>, un po' più complicati sono i <i>PKGBUILD</i>. Di grande aiuto mi è stata l'utility <i>cpan4pacman</i> installata precedentemente, che mi ha creato i <i>PKGBUILD</i> per le librerie perl mancanti, appena un po' più complesso il pacchetto <i>smbldap-tools</i> che ho dovuto fare da zero (o quasi). Perchè <i>radioattivo</i> ? Perchè ho ignorato tutte le opzioni di verifica delle dipendenze e i checksum MD5. Sono script in perl, di bassa pericolosità, ma naturalmente non mi assumo responsabilità.  
</p>
<h3><span class="mw-headline" id="Attiviamo_il_repository">Attiviamo il repository</span></h3>
<pre>sudo nano /etc/pacman.conf
</pre>
<p>aggiungiamo in fondo :
</p>
<pre>[stenoweb]
Server = <a rel="nofollow" class="external free" href="http://www.stenoweb.it/repo/i686">http://www.stenoweb.it/repo/i686</a>
</pre>
<p>e per finire aggiorniamo la lista dei pacchetti "risucchiando" la lista anche dal repo <i>stenoweb</i>:
</p>
<pre>sudo pacman -Sy
</pre>
<p>Bene ! Non dovreste ottenere errori.
</p>
<h2><span class="mw-headline" id="Installazione_pacchetti">Installazione pacchetti</span></h2>
<h3><span class="mw-headline" id="Samba_2">Samba</span></h3>
<p>Ma come diavolo si installerà Samba ? io proverei con un:
</p>
<pre>sudo pacman -S samba
</pre>
<p>Funziona ! Scusate non ho  resistito ...
</p>
<h3><span class="mw-headline" id="LDAP_Tools">LDAP Tools</span></h3>
<p>E qui interviene il mio repository. Gli <a rel="nofollow" class="external text" href="http://freshmeat.net/projects/smbldap-tools">LDAP Tools</a> sono degli script realizzati in perl che permettono di gestire utenti e gruppi Samba/Unix salvando i dati sull'albero LDAP anziché sui file <i>/etc/passwd e /etc/group</i>. In pratica sostituiscono i vari comandi standard linux di gestione degli utenti.
Iniziamo con installare le librerie perl necessarie :
</p>
<pre>sudo pacman -S perl-digest-sha1 perl-crypt-smbhash perl-jcode perl-unicode-map perl-unicode-map8 perl-unicode-maputf8 perl-unicode-string perl-ldap perl-io-socket-ssl 
</pre>
<p>e poi il pacchetto vero e proprio con gli scripts:
</p>
<pre>sudo pacman -S smbldap-tools
</pre>
<p>Gli script sono stati copiati/installati in <i>/usr/local/bin</i> e i file di configurazione in <i>/etc/smbldap-tools</i>.
I comandi sono nella forma (ad esempio per aggiungere un utente) :
</p>
<pre>sudo /usr/local/bin/smbldap-useradd <i>nomeutente</i>
</pre>
<p>ma non provateci adesso, mancando la necessaria configurazione otterrete solo un errore.
Ho fatto qualcosa in più: data la lunghezza del comando lo script di installazione del pacchetto crea anche dei link simbolici di più agevole forma in <i>/bin</i>. Il comando di prima diventerà il più semplice:
</p>
<pre>sudo netuseradd <i>nomeutente</i>
</pre>
<p>Prolunghiamo la vita alle nostre tastiere! :)
</p>
<h3><span class="mw-headline" id="Samba_LDAP_Schema">Samba LDAP Schema</span></h3>
<p>Per ultimo abbiamo bisogno del file di <i>schema</i> da applicare a OpenLDAP per memorizzare i dati di cui ha bisogno Samba. Cos'e' un file di schema ? LDAP in buona sostanza è un database, lo schema non è altro che il <i>tracciato record</i> che descrive, dichiara e crea i campi nel  database LDAP. Nello schema Samba ci sono i campi per il nome utente, la password, la home, i gruppi ecc. che servono a memorizzare i nostri dati nell'albero LDAP.
Il file <i>samba.schema</i> di cui abbiamo bisogno è fornito con i sorgenti di Samba: anziché scaricare i 17MB, scompattare e recuperare il file ve lo fornisco io direttamente.
Spostiamoci nella cartella degli schemi di OpenLDAP :
</p>
<pre>cd /etc/openldap/schema
</pre>
<p>e scarichiamoci lo schema:
</p>
<pre>sudo wget <a rel="nofollow" class="external free" href="http://www.stenoweb.it/repo/noarch/samba.schema">http://www.stenoweb.it/repo/noarch/samba.schema</a>
</pre>
<h1><span class="mw-headline" id="Configurazione_autenticazione_LDAP">Configurazione autenticazione LDAP</span></h1>
<p>Dopo aver installato tutti i pacchetti necessari cominciamo con la configurazione di OpenLDAP e la inizializzazione del suo database con gli utenti e gruppi di default richiesti da un dominio stile Microsoft.
</p>
<h2><span class="mw-headline" id="OpenLDAP_server">OpenLDAP server</span></h2>
<p>Abbiamo già configurato in modo basilare OpenLDAP, ora rimettiamo mano alla configurazione per includere ciò di cui ha bisogno samba.
</p>
<pre>sudo nano /etc/openldap/slapd.conf
</pre>
<p>Includiamo gli schemi necessari all'inizio (nis e samba):
</p>
<pre>include	/etc/openldap/schema/core.schema
include	/etc/openldap/schema/cosine.schema
include	/etc/openldap/schema/inetorgperson.schema
include	/etc/openldap/schema/nis.schema
include	/etc/openldap/schema/samba.schema
</pre>
<p>Impostiamo le regole di accesso :
</p>
<pre>access to dn.base=""
               by self write
               by * auth
</pre>
<pre>access to attrs=userPassword,sambaNTPassword,sambaLMPassword
       by dn="cn=Manager,dc=mede,dc=it" write
       by anonymous auth
       by self write
       by * none
</pre>
<pre>access to *
               by * read
               by anonymous auth
</pre>
<p>Soffermiamoci su di un aspetto: il rootdn <i>cn=Manager,dc=mede,dc=it</i> ha comunque accesso ai dati in lettura scrittura anche se non specifico nulla, ma di particolare importanza è la regola di accesso <i>"access to attrs=userPassword,sambaNTPassword,sambaLMPassword"</i> che di fatto permette ai singoli utenti di cambiare la propria password direttamente da Windows.
Per ultima cosa definiamo gli indici di ricerca per velocizzare gli accessi all'albero ldap (eliminate le voci "index" già presenti e sostituitele con queste) :
</p>
<pre># Indices
index objectClass           eq
index cn                    pres,sub,eq
index sn                    pres,sub,eq
index uid                   pres,sub,eq
index displayName           pres,sub,eq
index uidNumber             eq
index gidNumber             eq
index memberUID             eq
index sambaSID              eq
index sambaPrimaryGroupSID  eq
index sambaDomainName       eq
index default               sub
</pre>
<p>Per attivare le nuove impostazioni riavviamo il servizio:
</p>
<pre>sudo /etc/rc.d/slapd restart
</pre>
<p>Il nostro albero è pronto.
</p>
<h2><span class="mw-headline" id="LDAP_Tools_2">LDAP Tools</span></h2>
<p>Gli <i>LDAP tools</i> sono necessari per gestire utenti e gruppi, per poterli utilizzare dobbiamo configurarli a dovere. Per prima cosa diamo un file di configurazione di base a Samba :
</p>
<pre>sudo nano /etc/samba/smb.conf
</pre>
<p>e inseriamo :
</p>
<pre>[global]
       unix charset = LOCALE
       workgroup = MEDE
       netbios name = ARCHI
       server string = %h PDC (%v)
       interfaces = eth1, lo
       bind interfaces only = Yes
       enable privileges = yes
       guest account = guest
       domain logons = Yes
       domain master = yes
       preferred master = Yes
       os level = 65
       wins support = Yes
       security = user
       ldap suffix = dc=mede,dc=it
       ldap user suffix = ou=Users
       ldap machine suffix = ou=Computers
       ldap group suffix = ou=Groups
       ldap idmap suffix = ou=Idmap
       ldap admin dn = cn=Manager,dc=mede,dc=it
       idmap backend = ldap:ldap://archi.mede.it
       idmap uid = 10000-20000
       idmap gid = 10000-20000
       ldap passwd sync = Yes
      #ldap ssl = start tls
       ldap ssl = no
</pre>
<p>Come si può notare al momento (ricordo che <i>il servizio samba non è stato ancora avviato</i>) forniamo sono i dati essenziali, quali il dominio (workgroup = MEDE), il nome del server (netbios name = ARCHI), il suo ruolo di <i>Domain Controller</i> (domain logons = Yes) e i parametri LDAP. Sugli altri parametri consiglio una buona guida di Samba o le sue <i>manpage</i> :).
Come secondo passo prendiamo nota del <a href="https://en.wikipedia.org/wiki/Security_Identifier" class="extiw" title="wikipedia:Security Identifier">SID</a> del nostro server:
</p>
<pre>sudo net getlocalsid
</pre>
<p>dovrei ottenere qualcosa del tipo:
</p>
<pre>SID for domain ARCHI is: S-1-5-21-1491279793-2809991009-2777690449
</pre>
<p>Ora editiamo i file di configirazione dei smbldap-tools:
</p>
<pre>nano /etc/smbldap-tools/smbldap.conf
</pre>
<p>e scorrendo i parametri impostamoli così:
</p>
<pre>#Il SID ricavato con il comando precedente
SID="S-1-5-21-1491279793-2809991009-2777690449"
sambaDomain="MEDE"
suffix="dc=mede,dc=it"
hash_encrypt="MD5"
defaultMaxPasswordAge="180"
userSmbHome=""
userProfile=""
userHomeDrive="K:"
userScript="%U.bat"
mailDomain="mede.it"
</pre>
<p>Gli altri lasciamoli con i valori di default. Salviamo e editiamo il file:
</p>
<pre>sudo nano /etc/smbldap-tools/smbldap_bind.conf
</pre>
<p>e facciamo diventare così:
</p>
<pre>slaveDN="cn=Manager,dc=mede,dc=it"
slavePw="archimede"
masterDN="cn=Manager,dc=mede,dc=it"
masterPw="archimede"
</pre>
<p>Ricordo che "archimede" è la password che ho deciso per l'amministratore LDAP, la stessa che ho messo in <i>/etc/openldap/slapd.conf</i> in formato MD5 e in <i>/etc/ldap.secret</i> in chiaro.
Finito questo proteggiamo i file da occhi indiscreti:
</p>
<pre>sudo chmod 0644 /etc/smbldap-tools/smbldap.conf
sudo chmod 0600 /etc/smbldap-tools/smbldap_bind.conf
</pre>
<p>Ora non ci resta che dire anche a Samba la password da utilizzare per accedere a LDAP:
</p>
<pre>sudo smbpasswd -w archimede
</pre>
<p>se ottenete una risposta del tipo:
</p>
<pre>Setting stored password for "cn=Manager,dc=mede,dc=it" in secrets.tdb
</pre>
<p>Significa che fino ad ora tutto và per il verso giusto, e possiamo proseguire.
</p>
<h2><span class="mw-headline" id="Popolare_LDAP">Popolare LDAP</span></h2>
<p>Per il funzionamento corretto SAMBA ha bisogno di diversi gruppi predefiniti e 2 utenti: Administrator e guest. Inoltre, affinché si riesca ad aggiungere computer al dominio in modo automatico (da macchine Windows), deve esistere un utente con uid = 0 da utilizzare per questa operazione. Tale utente può essere un utente root (da aggiungere a mano) o lo stesso Administrator cambiandogli l'uid. Quest'ultima è la scelta presa in questa configurazione, in modo da avere un utente Administrator che è Administrator per Samba e root per il "dominio" UNIX.
Gli <i>ldap tools</i> forniscono un comodo comando per svolgere questa operazione: <i>smbldap-populate</i>. Lanciamolo così con questi parametri:
</p>
<pre>sudo /usr/local/bin/smbldap-populate -a Administrator -u 5001 -g 5001 -r 5001 -b guest -l 5000
</pre>
<p>al termine ci viene chiesta la password di "Administrator", mettiamo la stessa di root per non fare confusione. Dovrei vedere qualcosa del genere :
</p>
<pre>Populating LDAP directory for domain MEDE (S-1-5-21-1491279793-2809991009-2777690449)
(using builtin directory structure)
 
adding new entry: dc=mede,dc=it
adding new entry: ou=Users,dc=mede,dc=it
adding new entry: ou=Groups,dc=mede,dc=it
adding new entry: ou=Computers,dc=mede,dc=it
adding new entry: ou=Idmap,dc=mede,dc=it
adding new entry: uid=Administrator,ou=Users,dc=mede,dc=it
adding new entry: uid=guest,ou=Users,dc=mede,dc=it
adding new entry: cn=Domain Admins,ou=Groups,dc=mede,dc=it
adding new entry: cn=Domain Users,ou=Groups,dc=mede,dc=it
adding new entry: cn=Domain Guests,ou=Groups,dc=mede,dc=it
adding new entry: cn=Domain Computers,ou=Groups,dc=mede,dc=it
adding new entry: cn=Administrators,ou=Groups,dc=mede,dc=it
adding new entry: cn=Account Operators,ou=Groups,dc=mede,dc=it
adding new entry: cn=Print Operators,ou=Groups,dc=mede,dc=it
adding new entry: cn=Backup Operators,ou=Groups,dc=mede,dc=it
adding new entry: cn=Replicators,ou=Groups,dc=mede,dc=it
adding new entry: sambaDomainName=MEDE,dc=mede,dc=it
 
Please provide a password for the domain Administrator:
Changing UNIX and samba passwords for Administrator
New password:
Retype new password: 
</pre>
<p>Come possiamo notare <i>smbldap-populate</i> ha creato utenti e gruppi predefiniti in una installazione di windows server.
Per vedere se tutto funziona proviamo a creare un utente <i>user1</i>:
</p>
<pre>sudo netuseradd -a -m user1
</pre>
<p>e diamogli una password :
</p>
<pre>sudo netpasswd user1
</pre>
<p>ora controlliamo se l'utente c'e':
</p>
<pre>sudo getent passwd
</pre>
<p>Dovrei ottenere la lista degli utenti tra cui :
</p>
<pre>Administrator:x:0:0:Netbios Domain Administrator:/home/Administrator:/bin/false
guest:x:5000:514:guest:/dev/null:/bin/false
user1:x:5001:513:System User:/home/user1:/bin/bash
</pre>
<p>per le opzioni complete digitiamo <i>netuseradd</i> senza parametri e diamo una occhiata. Nell'esempio il parametro <i>-a</i> crea sia l'utente unix che samba e <i>-m</i> crea la home (/home/user1) dell'utente.
</p>
<h1><span class="mw-headline" id="Pianificazione_condivisioni">Pianificazione condivisioni</span></h1>
<p>E' (quasi) giunto il momento di avviare Samba, ma prima dobbiamo pianificare un po' COSA andremo a condividere e COME impostare gli accessi al file system (ACL). Quello che propongo qui è solo un esempio, i casi possono essere innumerevoli, ma secondo me questa rappresenta comunque una buona base di partenza.
</p>
<h2><span class="mw-headline" id="Gruppi">Gruppi</span></h2>
<p>Definiamo e creiamo un insieme di gruppi di utenti a cui poi assegnare una condivisione "privata". I nomi sono di fantasia (anche se non proprio :)):
</p>
<table class="wikitable">
<caption>
</caption>
<tr>
<th> Gruppo </th>
<th> Descrizione
</th>
</tr>
<tr>
<td> commerciale </td>
<td>  utenti ufficio commerciale
</td>
</tr>
<tr>
<td> tecnico </td>
<td> utenti ufficio tecnico
</td>
</tr>
<tr>
<td> Domain Users </td>
<td> gruppo che contiene tutti gli utenti
</td>
</tr>
</table>
<p><i>Domain Users</i> è già stato creato con <i>smbldap-populate</i>. Ogni nuovo utente viene assegnato in modo automatico a questo gruppo.
</p>
<h3><span class="mw-headline" id="Creiamo_gli_altri_gruppi">Creiamo gli altri gruppi</span></h3>
<pre>sudo netgroupadd -a Commerciale
sudo netgroupadd -a Tecnico
</pre>
<h3><span class="mw-headline" id="Creiamo_gli_utenti">Creiamo gli utenti</span></h3>
<pre>sudo netuseradd -a -m commerciale1
sudo netpasswd commerciale1
sudo netuseradd -a -m tecnico1
sudo netpasswd tecnico1
</pre>
<p>se abbiamo fatto tutto correttamente non dovrei vedere errori, controlliamo con:
</p>
<pre>sudo getent passwd
</pre>
<p>Alla fine dovrei vedere gli utenti appena creati:
</p>
<pre>commerciale1:x:5001:513:System User:/home/commerciale1:/bin/bash
tecnico1:x:5002:513:System User:/home/tecnico1:/bin/bash
</pre>
<p>Nota: come possiamo vedere ad ogni utente viene concesso l'accesso shell (<i>/bin/bash</i>). Se vogliamo togliere questo privilegio basta modificare l'utente (ad esempio tecnico1) così:
</p>
<pre>sudo netusermod -s /bin/false tecnico1
</pre>
<h3><span class="mw-headline" id="Assegniamo_gli_utenti_ai_gruppi">Assegniamo gli utenti ai gruppi</span></h3>
<pre>sudo netgroupmod -m commerciale1 Commerciale
sudo netgroupmod -m tecnico1 Tecnico
</pre>
<p>Anche qui possiamo controllare con :
</p>
<pre>sudo getent group
</pre>
<p>e ottenere qualcosa del genere:
</p>
<pre>Commerciale:*:5001:commerciale1
Tecnico:*:5002:tecnico1
</pre>
<p>I comandi <i>net*</i> li trovo in /bin: è utile prendere dimestichezza con questi per amministrare utenti e gruppi.
</p>
<h2><span class="mw-headline" id="Condivisioni">Condivisioni</span></h2>
<p>Vediamo ora cosa andremo a condividere, ho deciso di mettere tutto (tranne le home directory) in <i>/samba</i>:
</p>
<table class="wikitable">
<caption>
</caption>
<tr>
<th> Condivisione </th>
<th> Percorso </th>
<th> Descrizione
</th>
</tr>
<tr>
<td> public </td>
<td>/samba/public </td>
<td> Cartella pubblica. Contiene una cartella per ogni gruppo (vedi dopo)
</td>
</tr>
<tr>
<td> netlogon</td>
<td>/samba/netlogon  </td>
<td>Cartella di sistema necessaria in un domain controller. Contiene gli script di login utente.
</td>
</tr>
<tr>
<td> profiles</td>
<td>/samba/profiles</td>
<td>Cartella di sistema. Mi serve se uso i Profili Roaming di windows.
</td>
</tr>
<tr>
<td> rootdir</td>
<td>/samba</td>
<td>Condivisione ad uso backup. Contiene anche i symlink ai file più importanti del mio server
</td>
</tr>
<tr>
<td> apps</td>
<td>/samba/apps</td>
<td>Cartella applicazioni. Sola lettura
</td>
</tr>
<tr>
<td> homes</td>
<td>/home</td>
<td>Cartelle home per gli utenti. Ognuno la sua.
</td>
</tr>
</table>
<h3><span class="mw-headline" id="public">public</span></h3>
<p>Questa condivisione è la principale, anziché creare una condivisione per ogni gruppo ho deciso di mettere tutto dentro a <i>public</i> e di "giocare" poi con i permessi sulle cartelle. Per capirci meglio :
</p>
<table class="wikitable">
<caption>
</caption>
<tr>
<td> /samba/public </td>
<td> di proprietà di root/Administrator solo leggibile dagli altri
</td>
</tr>
<tr>
<td> /samba/public/commerciale </td>
<td> Cartella per gruppo "Commerciale"
</td>
</tr>
<tr>
<td> /samba/public/tecnico </td>
<td> Cartella per gruppo "Tecnico"
</td>
</tr>
<tr>
<td> /samba/public/comune </td>
<td> Cartella condivisa di tutti ("Domain Users")
</td>
</tr>
</table>
<p>Poi andremo a mappare una unità L: (a scelta) sulla condivisione "public" e gli utenti del gruppo "Commerciale" vedranno L:\COMUNE e L:\COMMERCIALE, gli utenti del gruppo "Tecnico" vedranno solo L:\COMUNE e L:\TECNICO. Nessuno (tranne i membri del gruppo "Domain Admins", off course) possono creare files o cartelle nella root di L:.
Tengo a precisare che questa non è una regola <i>ma una mia personale idea</i> su come organizzare le condivisioni. Quando abbiamo a che fare con molti gruppi ritengo abbastanza noioso e confusionario fare condivisioni separate. Un utente membro di diversi gruppi si troverebbe con molte mappature diverse che esauriscono in breve l'alfabeto. In questo modo ho una unica mappatura (L:\) e ognuno vedrà le sottocartelle a cui avrà accesso. Molto più ordinato e comodo. Questo tipo di organizzazione è la stessa che usavo quando installavo Novell Netware 10-15 anni fà, e quindi non ha niente di specifico di Samba o di Windows.
Quindi creiamo la struttura :
</p>
<pre>sudo mkdir /samba/public
sudo mkdir /samba/public/commerciale
sudo mkdir /samba/public/tecnico
sudo mkdir /samba/public/comune
</pre>
<p>e sistemiamo i permessi e la proprietà :
</p>
<pre>sudo chmod 770 /samba/public/commerciale
sudo chgrp Commerciale /samba/public/commerciale
sudo chmod 770 /samba/public/tecnico
sudo chgrp Tecnico /samba/public/tecnico
sudo chmod 770 /samba/public/comune
sudo chgrp "Domain Users" /samba/public/comune
</pre>
<p>Controlliamo cosa abbiamo combinato:
</p>
<pre>ls -al /samba/public
</pre>
<p>e dovrei vedere qualcosa del genere:
</p>
<pre>drwxr-xr-x 5 root root         4096 17 dic 16:24 .
drwxr-xr-x 7 root root         4096 12 dic 16:11 ..
drwxrwx--- 2 root Commerciale  4096 17 dic 16:24 commerciale
drwxrwx--- 2 root Domain Users 4096 17 dic 16:24 comune
drwxrwx--- 2 root Tecnico      4096 17 dic 16:24 tecnico
</pre>
<h4><span class="mw-headline" id="La_.22rogna.22_dei_permessi_utente">La <i>"rogna"</i> dei permessi utente</span></h4>
<p>Ora che abbiamo dato i permessi alle cartelle ci troviamo di fronte ad un problema inaspettato. Quando gli utenti creano nuovi files o cartelle nelle condivisioni questi vengono <i>flaggati</i> con utente=UtenteCreatore e gruppo=GruppoDefaultUtente. Il gruppo di default è "Domain Users", quindi tutti i nuovi files vengono impostati con questo gruppo. Dunque i nuovi files creati in "commerciale" sono potenzialmente a disposizione anche degli utenti del gruppo "Tecnico", essendo anche questi membri del gruppo "Domain Users". In questo caso sono protetti dai permessi della cartella stessa, ma potrebbe non essere così in un altro caso. L'utente "Administrator" ha come gruppo di default "Domain Admins", quindi ogni file creato/copiato/ripristinato dall'amministratore risulta non accessibile dagli utenti "normali". Indubbiamente una bella rottura di scatole dover ogni volta reimpostare a mano i permessi sui files manipolati dall'amministratore ...
Ma non disperate ! :) Ci viene in aiuto il flag <a href="https://en.wikipedia.org/wiki/Setuid" class="extiw" title="wikipedia:Setuid">SETUID</a> di unix. Se leggete l'articolo linkato sembra non centrare una benemerita fava con l'argomento in questione, ma in questo caso l'effetto del flag è quello da noi voluto. In pratica abilitiamo il flag sul gruppo in questo modo :
</p>
<pre>sudo chmod g+s /samba/public/commerciale
sudo chmod g+s /samba/public/tecnico
sudo chmod g+s /samba/public/comune
</pre>
<p>se ricontrollo ora con <i>ls -al</i> dovrei vedere che la tripletta dei permessi sul gruppo è cambiata da <i>rwx</i> a <i>rws</i> che indica, appunto, che è attivo il setuid. Cosa provoca questo ? Questo trucchetto fà si che <i>ogni file creato nelle cartelle avrà come gruppo proprietario il guppo della cartella e non quello dell'utente</i>. Quindi ogni file, ad esempio, creato in "commerciale" avrà come gruppo proprietario "Commerciale" che corrisponde al gruppo proprietario della cartella. Ora potete usare anche "Administrator" per ripristinare o creare files che saranno accessibili agli utenti normali. Fiuuuuuu. Andiamo avanti.
</p>
<h3><span class="mw-headline" id="netlogon_.26_profiles">netlogon &amp; profiles</span></h3>
<p>Queste sono due condivisioni di sistema, necessarie quando si configura un <i>domain controller</i>. In <i>netlogon</i> si saranno gli script di login degli utenti (che vedremo come creare al "volo" in modo dinamico), in <i>profiles</i> ci saranno i profili utente nel caso avessimo deciso di usare i <i>profili roaming</i> di Microsoft (utili i certi casi, ma a me, idea personalissima, non piacciono).
Creiamo le certelle e diamo i permessi :
</p>
<pre>sudo mkdir /samba/netlogon
sudo mkdir /samba/profiles
chmod 777 /samba/profiles
</pre>
<h3><span class="mw-headline" id="rootdir">rootdir</span></h3>
<p>Questa è una condivisione di "comodo" accessibile solo all'amministratore. Creiamo anche una cartella <i>system</i> con i <i>link simbolici</i> alle cartelle o ai file che poi potremmo salvare via condivisione samba da un altro PC per fare dei veloci backup.
</p>
<pre>sudo ln -s /home /samba/home
</pre>
<p>In questo modo l'amministratore accedendo alla condivisione "rootdir" potrà vedere e manipolare tutte le home degli utenti
</p>
<pre>sudo mkdir /samba/system
sudo ln -s /etc /samba/system/etc
sudo ln -s /var/lib/openldap/openldap-data /samba/system/ldap
</pre>
<p>Ora l'amministratore trova nella cartella "system" anche i file di configurazione del server e il database utenti/gruppi di OpenLDAP. Molto comodo, e potrei anche aggiungere altri link senza inventarmi condivisioni "esotiche".
</p>
<h3><span class="mw-headline" id="apps">apps</span></h3>
<p>In questa condivisione mettiamo i programmi condivisi nella rete. Solo "Administrator" può scrivere nella cartella, gli altri utenti possono solo leggere e eseguire i file contenuti. creiamo la cartella e settiamo i permessi:
</p>
<pre>sudo mkdir /samba/apps
sudo chmod 750 /samba/apps
sudo chgrp "Domain Users" /samba/apps
sudo chmod g+s /samba/apps
</pre>
<h3><span class="mw-headline" id="homes">homes</span></h3>
<p>Questa condivisione è creata automaticamente (o quasi) da Samba. Le home degli utenti saranno mappate con K: e sarà privata ad ogni utente.
</p>
<p>Bene, dovremmo esserci. Ora siamo pronti a completare la configurazione di samba ed ad avviare (finalmente) il servizio.
</p>
<h1><span class="mw-headline" id="Configurazione_di_Samba">Configurazione di Samba</span></h1>
<p>E' giunta l' ora del servizio <i>Samba</i> finalmente. Configuriamolo a dovere e avviamo il servizio. Vediamo anche una (breve) spiegazione dei parametri principali applicati al nostro <i>smb.conf</i>.
Andiamo ad editare il file di configurazione di Samba:
</p>
<pre>sudo nano /etc/samba/smb.conf
</pre>
<p>e vediamo cosa scriverci ...
</p>
<h2><span class="mw-headline" id="Parametri_globali">Parametri globali</span></h2>
<p>Nella sezione [global] abbiamo i parametri generali del server, soffermiamoci solo su quelli (per me) significativi. Alla fine c'e' il file completo per un comodo copia/incolla. Per il resto rimando alla guida.
Il nome del dominio:
</p>
<pre>workgroup = MEDE
</pre>
<p>Il nome del server :
</p>
<pre>netbios name = ARCHI
</pre>
<p>Samba rimane in ascolto solo sulle interfacce specificate, la eth0 che è rivolta all'esterno verso internet naturalmente non viene servita. O vogliamo dare servizi di file server al mondo ? :)
</p>
<pre>interfaces = eth1, lo
bind interfaces only = Yes
</pre>
<p>Diciamo a Samba che il <i>repository</i> di utenti, gruppi e password è il server LDAP specificato.
</p>
<pre>passdb backend = ldapsam:ldap://archi.mede.it
</pre>
<p>Ordine con cui vengono risolti i nomi delle workstation. <i>Broadcast</i> per ultimo off course.
</p>
<pre>name resolve order = wins host dns bcast
</pre>
<p>Script richiamati da Samba quando <i>da Windows</i> tento le operazioni citate. Questo mi permette di usare tools windows per gestire utenti e gruppi, oltre che ad eseguire la <i>join</i> al dominio.
</p>
<pre>add user script = /bin/netuseradd -a -m '%u'
delete user script = /bin/netuserdel '%u'
add group script = /bin/netgroupadd -a -p '%g'
delete group script = /bin/netgroupdel '%g'
add user to group script = /bin/netgroupmod -m '%u' '%g'
delete user from group script = /bin/netgroupmod -x '%u' '%g'
set primary group script = /bin/netusermod -g '%g' '%u'
add machine script = /bin/netuseradd -w '%u'
</pre>
<p>Script di login eseguiti dagli utenti quando si collegano. %U viene trasformata nel nome utente. Ad esempio l' utente <i>tecnico1</i> eseguirà (se esiste) lo script <i>tecnico1.bat</i> che si trova in <i>netlogon</i>.
</p>
<pre>logon script = %U.bat
</pre>
<p>Non voglio i profili roaming, quindi metto a <i>null</i> questi parametri. Attenzione che i parametri <i>userSmbHome</i> e <i>userProfile</i> specificati in <i>/etc/smbldap-tools/smbldap.conf</i> hanno la precedenza su questi !
</p>
<pre>logon path =
logon home =
</pre>
<p>Il mio server è un <i>domain controller</i> :)
</p>
<pre>domain logons = Yes
</pre>
<p>Eleggiamo il nostro server ad autorità <i>maxima</i>, facciamolo diventare <a href="https://en.wikipedia.org/wiki/Domain_Master_Browser" class="extiw" title="wikipedia:Domain Master Browser">master browser</a> per il segmento della nostra rete.
</p>
<pre>domain master = yes
preferred master = Yes
os level = 65
</pre>
<p>Il nostro server è anche server <a href="https://en.wikipedia.org/wiki/Windows_Internet_Name_Service" class="extiw" title="wikipedia:Windows Internet Name Service">wins</a>
</p>
<pre>wins support = Yes
</pre>
<p>Parametri dell'albero LDAP a cui Samba si collega. In questo modo si indica a Samba dove trovare utenti, gruppi, computer e il nome utente da utilizzare per connettersi (cn=Manager). Ricordiamo che la password la abbiamo memorizzata con il comando <i>smbpasswd -w </i> nell'articolo precedente.
</p>
<pre>ldap suffix = dc=mede,dc=it
ldap user suffix = ou=Users
ldap machine suffix = ou=Computers
ldap group suffix = ou=Groups
ldap idmap suffix = ou=Idmap
ldap admin dn = cn=Manager,dc=mede,dc=it
idmap backend = ldap:ldap://archi.mede.it
idmap uid = 10000-20000
idmap gid = 10000-20000
ldap passwd sync = Yes
ldap ssl = no
</pre>
<p>Il tipo di autenticazione da usare (IMPORTANTISSIMO!).
</p>
<pre>security = user
</pre>
<p>Ho specificato dei parametri aggiuntivi che vedete alla fine del post, lascio a voi il compito di interpretarli ;).
Ora passiamo alla sezione <i>condivisioni</i>.
</p>
<h2><span class="mw-headline" id="Condivisioni_2">Condivisioni</span></h2>
<p>Abbiamo visto nell' articolo precedente quali condivisioni andiamo a realizzare, vediamo come sono state tradotte sul file di configurazione. Non le espongo tutte, ma solo quelle che hanno qualche parametro significativo da spiegare. La versione completa del file <i>smb.conf</i> la trovate alla fine del post.
</p>
<h3><span class="mw-headline" id="public_2">public</span></h3>
<p>Nome e percorso condivisione
</p>
<pre>comment = "L: - Cartella Pubblica Utenti"
path = /samba/public
</pre>
<p>Scrivibile:
</p>
<pre>writeable = yes
</pre>
<p>La vedo nel <i>browsing</i> della rete:
</p>
<pre>browseable = Yes
</pre>
<p>Nascondi i file e le cartelle che l'utente non può leggere. Questo è utile, in questa condivisione un utente vedrà solo quello che gli serve anzichè chiedersi cosa ci sia "dentro" una cartella che non riesce ad aprire... :)
</p>
<pre>hide unreadable = Yes
</pre>
<p>Questa serie di parametri corrispondono ad una serie di tentativi per fare in modo che questa condivisione funzioni a dovere. Ora non me la sento di cambiare qualcosa. Chi lascia la vecchia strada ...
</p>
<pre>directory mask = 0775
create mask = 0775
force create mode = 0775
force directory mode = 6775
security mask = 0777
force security mode = 0
directory security mask = 0777
force directory security mode = 0
</pre>
<p>I <i>vfs objects</i> sono un utile "plugin" di Samba. In questo caso usiamo l'oggetto <i>recycle</i> per realizzare un <i>cestino di rete</i>. I file eliminati non andranno eliminati immediatamente ma finiranno in una cartella nascosta <i>.cestino/nomeutente</i>. Poi faremo uno script di <i>purge</i> per vuotare i cestini ogni tanto. I parametri aggiuntivi servono per dire a samba di non salvare i file temporanei e di backup e di non applicare il <i>versioning</i> ai file di office (creano problemi con il salvataggio automatico di quest'ultimo). 
</p>
<pre>vfs objects = recycle
recycle:repository = .cestino/%U
recycle:keeptree = yes
recycle:touch = yes
recycle:versions= yes
recycle:exclude = *.tmp *.bak ~$*
recycle:exclude_dir = /tmp /temp /cache
recycle:noversions = *.doc *.xls *.ppt
</pre>
<h3><span class="mw-headline" id="netlogon">netlogon</span></h3>
<p>Questa condivisione di "servizio" è fondamentale per la gestione degli script di logon degli utenti.
Intanto la nascondiamo dal browsing della rete.
</p>
<pre>browseable = No
</pre>
<p>Nel momento in cui l'utente accede alla condivisione (e tutti gli utenti di un dominio lo fanno) viene eseguito <i>/etc/samba/logon.pl</i> a cui vengono passati dei parametri tipo il nome utente che ha richiamato lo script, il gruppo, l'orario ecc.. Cosa fà questo programmino ? Semplice, <i>crea lo script di logon dell'utente "al volo"</i> secondo le regole definite in <i>logon.pl</i>. Ad esempio viene creato <i>tecnico1.bat</i> per l'utente <i>tecnico1</i>.  Potrei omettere questo parametro e creare a mano lo script, ma così è molto più comodo e vedremo perché. 
</p>
<pre>root preexec = /etc/samba/logon.pl "%U" "%G" "%L" "%T" "%m" "%a"
</pre>
<p>E ora vediamo come è fatto questo <i>logon.pl</i>. 
</p>
<pre>sudo nano /etc/samba/logon.pl
</pre>
<p>e impostiamolo così:
</p>
<pre>#!/usr/bin/perl
#
open LOG, "&gt;&gt;/var/log/samba/netlogon.log";
print LOG "$ARGV[3] - Utente $ARGV[0] collegato a $ARGV[2]\n";
close LOG;
#
# Elenco utenti per share
#
$APPS   ="-tecnico1-tecnico2-";
$NOLOGON ="-administrator-";
$DELMAP  ="-winnt-win2k-win2k3-winxp-";
$ADMIN   ="administrator";
#
# Inizio generazione script
#
open LOGON, "&gt;/samba/netlogon/$ARGV[0].bat";
print LOGON "\@ECHO OFF\r\n";
print LOGON "ECHO ARCHI logon script\r\n";
print LOGON "ECHO.\r\n";
#
# Sincronizza orario con il server
#
print LOGON "NET TIME \\\\ARCHI /SET /YES\r\n";
#
# Se piattaforma PC in lista $DELMAP cancella i vecchi mappaggi
#
if (index($DELMAP,"-".lc($ARGV[5])."-") &gt;=0)
 {
       print LOGON "NET USE * /DEL /YES\r\n";
 }
#
# Esci se utente in lista $NOLOGON altrimenti applica i mappaggi comuni
#
if (index($NOLOGON,"-".lc($ARGV[0])."-") == -1)
 {
   # Disco L: (PUBLIC)
   print LOGON "NET USE L: \\\\ARCHI\\public /YES\r\n";
   # Disco K: (HOME)
   print LOGON "NET USE K: \\\\ARCHI\\$ARGV[0] /YES\r\n";
  
   # Disco X: (APPS)
   if (index($APPS,"-".lc($ARGV[0])."-") &gt;=0)
     {
       print LOGON "NET USE X: \\\\ARCHI\\apps /YES\r\n";
     }
 }
# Chiudi il file.
close LOGON;
</pre>
<p>Possiamo vedere che <i>condizioniamo</i> la creazione dello script in base a delle variabili in testa. Ad esempio solo la lista degli utenti specificata in <i>$APPS</i> (tecnico1 e tecnico2 separati con "-") avranno la mappatura X:, e gli utenti listati in <i>$NOLOGON</i> (administrator) non avranno alcuno script. Tutto chiaro ?
Questo script può essere modificato ed esteso con semplicità seguendo questo schema di esempio, e ha il pregio di semplificare la gestione degli script di logon. Voglio che anche l'utente "commerciale1" mappi la X: per \\archi\apps ? Basta aggiungerlo nella lista <i>$APPS</i> e la prossima volta che si collega al server avrà il suo script aggiornato "al volo". In più ho anche un file di log in <i>/var/log/samba/netlogon.log</i> che mi informa dell'orario di collegamento degli utenti.
</p>
<p>Wow. A volte le cose semplici sono le più importanti. Come compito a casa mi fate lo script che scrive nel log l'orario in cui si scollegano usando il parametro <i>root postexec</i>. ;)
</p>
<p>Tengo a precisare che i parametri <i>root preexec</i> (e <i>root postexec</i> che viene eseguito allo "scollegamento") non sono una prerogativa di <i>netlogon</i>. Possono essere usati con <i>qualunque</i> condivisione per eseguire "qualcosa" al momento del collegamento (e/o dello scollegamento).
</p>
<p>Ricordiamoci di rendere eseguibile lo script perl :
</p>
<pre>sudo chmod 775 /etc/samba/logon.pl
</pre>
<h2><span class="mw-headline" id="smb.conf_completo">smb.conf completo</span></h2>
<p>E <i>dulcis in fundo</i> ecco il file di configurazione completo da <i>spulciare</i> e studiare. Posso, ad esempio, notare che ho gestito il cestino anche sulle <i>home</i> e autorizzato solo i membri del gruppo "Domain Admins" ad accedere alla condivisione di "servizio" <i>rootdir</i>.
</p>
<pre>[global]
       workgroup = MEDE
       netbios name = ARCHI
       server string = %h PDC (%v)
       interfaces = eth1, lo
       bind interfaces only = Yes
       passdb backend = ldapsam:ldap://archi.mede.it
       enable privileges = yes
       log level = 0
       log file = /var/log/samba/%m
       max log size = 50
       smb ports = 139 445
       hide dot files = yes
       name resolve order = wins host dns bcast
       time server = Yes
       guest account = guest
       show add printer wizard = No
       add user script = /bin/netuseradd -a -m '%u'
       delete user script = /bin/netuserdel '%u'
       add group script = /bin/netgroupadd -a -p '%g'
       delete group script = /bin/netgroupdel '%g'
       add user to group script = /bin/netgroupmod -m '%u' '%g'
       delete user from group script = /bin/netgroupmod -x '%u' '%g'
       # Disabilitare quando a fare il join al dominio è un Windows NT
       set primary group script = /bin/netusermod -g '%g' '%u'
       add machine script = /bin/netuseradd -w '%u'
       logon script = %U.bat
       # Profili Roaming
       #logon path = \\%L\profiles\%U
       logon path =
       logon home =
       logon drive = K:
       domain logons = Yes
       domain master = yes
       preferred master = Yes
       os level = 65
       wins support = Yes
       # LDAP
       ldap suffix = dc=mede,dc=it
       ldap user suffix = ou=Users
       ldap machine suffix = ou=Computers
       ldap group suffix = ou=Groups
       ldap idmap suffix = ou=Idmap
       ldap admin dn = cn=Manager,dc=mede,dc=it
       idmap backend = ldap:ldap://archi.mede.it
       idmap uid = 10000-20000
       idmap gid = 10000-20000
       ldap passwd sync = Yes
      #ldap ssl = start tls
       ldap ssl = no
       map acl inherit = Yes
       #printing = cups
       lock directory = /var/lock/samba
       winbind use default domain = yes
       winbind enum users = yes
       winbind enum groups = yes
       security = user
       template shell = /bin/false
[public]
       comment = "L: - Cartella Pubblica Utenti"
       path = /samba/public
       writeable = yes
       browseable = Yes
       hide unreadable = Yes
       directory mask = 0775
       create mask = 0775
       force create mode = 0775
       force directory mode = 6775
       security mask = 0777
       force security mode = 0
       directory security mask = 0777
       force directory security mode = 0
       #inherit acls = yes
       #inherit permissions = yes
       vfs objects = recycle
       recycle:repository = .cestino/%U
       recycle:keeptree = yes
       recycle:touch = yes
       recycle:versions= yes
       recycle:exclude = *.tmp *.bak ~$*
       recycle:exclude_dir = /tmp /temp /cache
       recycle:noversions = *.doc *.xls *.ppt
[homes]
       comment = "K: - Cartella privata di %U, %u"
       writeable = yes
       create mask = 0700
       directory mask = 0775
       browseable = No
       force user = %U
       vfs objects = recycle
       recycle:repository = .cestino
       recycle:keeptree = yes
       recycle:touch = yes
       recycle:versions= yes
       recycle:exclude = *.tmp *.bak ~$*
       recycle:exclude_dir = /tmp /temp /cache
       recycle:noversions = *.doc *.xls *.ppte_dir = /tmp /temp /cache
       recycle:noversions = *.doc *.xls *.ppt
[rootdir]
       comment = Cartella globale, solo per amministrazione e backup
       path = /samba
       writeable = yes
       browseable = yes
       directory mask = 0770
       create mask = 0775
       force create mode = 0775
       force directory mode = 6775
       security mask = 0777
       force security mode = 0
       directory security mask = 0777
       admin users = Administrator
       valid users = "@Domain Admins"
       force create mode = 0644
       force directory mode = 6775
[apps]
       comment = "Y: - Applicazioni"
       path = /samba/apps
       writeable = yes
       browseable = Yes
       directory mask = 0770
       create mask = 0775
       security mask = 0777
       force security mode = 0
       directory security mask = 0777
       force directory security mode = 0
       hide unreadable = Yes
       force create mode = 0775
       force directory mode = 6775
[netlogon]
       comment = Network Logon Service
       path = /samba/netlogon
       guest ok = Yes
       locking = No
       browseable = No
       root preexec = /etc/samba/logon.pl "%U" "%G" "%L" "%T" "%m" "%a"
       #root postexec = /etc/samba/logoff.pl "%U" "%G" "%L" "%T"
[profiles]
       comment = Profile Share
       path = /samba/profiles
       writeable = yes
       profile acls = Yes
       browsable = No
</pre>
<h1><span class="mw-headline" id="Avvio_del_servizio">Avvio del servizio</span></h1>
<p>Quasi me ne dimenticavo :)
</p>
<pre>sudo /etc/rc.d/samba start
</pre>
<p>e mettiamolo nella lista dei nostri daemons:
</p>
<pre>DAEMONS=(... ... ... ... ... samba ... ... ...) 
</pre>
<h1><span class="mw-headline" id="Join_al_dominio_e_scripts_di_manutenzione">Join al dominio e scripts di manutenzione</span></h1>
<p>Ora che finalmente abbiamo avviato Samba, facciamo la <i>join</i> del server al nostro dominio nuovo fiammante, controlliamo che funzioni e creiamo un paio di script bash utili per la manutenzione del sistema
</p>
<h2><span class="mw-headline" id="Join_al_dominio">Join al dominio</span></h2>
<p>Per prima cosa dobbiamo unire il nostro server al dominio (che traduzione orrenda: diciamo che dobbiamo fare la <i>join</i>...), con il comando :
</p>
<pre>sudo net rpc join -S ARCHI -U Administrator
</pre>
<p>dopo aver digitato la password dovreste vedere il messaggio:
</p>
<pre>Joined domain MEDE.
</pre>
<p>In questa fase Samba ha creato l'account workstation per il vostro server nel suo backend LDAP nel formato <i>nomemacchina$</i>. Andiamo a vedere se è vero con il comando <i>getent</i>:
</p>
<pre>sudo getent passwd
</pre>
<p>Alla fine dovrei vedere il mio server :
</p>
<pre>archi$:*:5004:515:Computer:/dev/null:/bin/false
</pre>
<p>Ottimo. Passiamo oltre.
</p>
<h2><span class="mw-headline" id="Funziona_.3F">Funziona ?</span></h2>
<p>Controlliamo subito. Facciamolo con i comandi di Samba, così siamo sicuri che sia lui a rispondere alle nostre richeste:
</p>
<pre>sudo pdbedit -L
</pre>
<p>Dovrebbe mostrarmi la lista degli utenti, tipo questa:
</p>
<pre>Administrator:0:Administrator
guest:5000:guest
commerciale1:5001:commerciale1
tecnico1:5002:tecnico1
archi$:5004:Computer
</pre>
<p>e ora controlliamo anche le condivisioni :
</p>
<pre>sudo smbclient -L localhost -U administrator
</pre>
<p>e dopo la password dovrei vedere una cosa del tipo :
</p>
<pre>Domain=[MEDE] OS=[Unix] Server=[Samba 3.0.28]
        Sharename       Type      Comment
        ---------       ----      -------
        IPC$            IPC       IPC Service (archi PDC (3.0.28))
        print$          Disk      Printer Drivers
        apps            Disk      Y: - Applicazioni
        rootdir         Disk      Cartella globale, solo per amministrazione e backup
        public          Disk      L: - Cartella Pubblica Utenti
        Administrator   Disk      K: - Cartella privata di administrator, Administrator
Domain=[MEDE] OS=[Unix] Server=[Samba 3.0.28]
        Server               Comment
        ---------            -------
        ARCHI                archi PDC (3.0.28)
        Workgroup            Master
        ---------            -------
        MEDE                 ARCHI
</pre>
<p>Wow! Ce l'abbiamo fatta, il nostro domain controller è pronto ad accogliere le vostre workstation Windows (e Linux off course) tra le sue forti braccia.
</p>
<h2><span class="mw-headline" id="Scripts_di_manutenzione">Scripts di manutenzione</span></h2>
<h3><span class="mw-headline" id="purge">purge</span></h3>
<p>Predentemente abbiamo abilitato il plugin Samba per gestire il <i>cestino</i> del server: ogni utente che cancella i file in realtà li sposta nella cartella <i>.cestino/nomeutente</i> che abbiamo definito. Capirete anche voi che non possiamo lasciarli lì per sempre ma abbiamo bisogno di <i>purgare</i> i cestini di tanto in tanto per mantenere il sistema pulito dalla spazzatura.
Chi ha conosciuto <i>Novell Netware</i> non può non ricordare il comando <i>purge</i> che svolgeva egregiamente questa funzione, purtroppo qui non abbiamo niente di simile, e dobbiamo arrangiarci con bash. Tranquilli, ci ho già pensato io qualche anno fa, niente di eclatante  ma svolge la sua funzione in modo preciso. Creiamo il file:
</p>
<pre>sudo nano /bin/purge
</pre>
<p>e inseriamoci quanto segue:
</p>
<pre>#!/bin/bash
# purge
# Vuota il cestino degli utenti e di sistema
# by steno 2005-2007
#
# Controlla i parametri
if [ $# = 0 ]
 then
   echo "uso: purge {all|&lt;username&gt;}"
   exit;
 else
  if [ $1 = 'all' ]
   then
    DIR=`ls /home -F | awk '/\/$/ {sub( /\/$/,""); print}'`; 
   else
    DIR=$1;
  fi;
fi;
#
# Vuota il cestino privato degli utenti
#
for user in $DIR; do
  if [ -e /home/$user/.cestino ];
   then
    X="`(cd /home/$user/.cestino ; echo *)`";
    if [ ! "$X" = "*" ] ; then
                echo "Elimina file dal cestino utente &lt;$user&gt;";
                rm /home/$user/.cestino/* -r;
    else
                echo "Cestino personale utente &lt;$user&gt; vuoto";
    fi;
  fi;
done;
#
# Vuota il cestino globale di "public"
#
DIR=`ls /samba/public/.cestino -F | awk '/\/$/ {sub( /\/$/,""); print}'`;
for user in $DIR; do
 X="`(cd /samba/public/.cestino/$user ; echo *)`";
 if [ ! "$X" = "*" ] ; then
  echo "Elimina file dal cestino globale utente &lt;$user&gt;" ;
  rm /samba/public/.cestino/$user -R;
 else
  echo "Cestino globale utente &lt;$user&gt; vuoto";
 fi 
done;
</pre>
<p>Come vedete possiamo "purgare" tutto con il parametro <i>all</i> o limitarci ad uno specifico utente. Lo script è poi suddiviso in due parti, la prima si occupa del cestino di ogni singola <i>home/user</i>, la seconda del cestino della share principale <i>public</i>.
Rendiamo eseguibile lo script:
</p>
<pre>sudo chmod 755 /bin/purge
</pre>
<p>e creiamo il Cestino globale dando i permessi corretti alla cartella:
</p>
<pre>sudo mkdir /samba/public/.cestino
sudo chmod 770  /samba/public/.cestino 
sudo chgrp "Domain Users" /samba/public/.cestino
</pre>
<p>Ora basta digitare <i>purge all</i> da shell per avviare le pulizie di primavera :), <i>purge tecnico1</i> per il cestino del solo utente <i>tecnico1</i>. Prendiamo anche in considerazione la possibilità di schedularlo con <i>crontab</i> per avviarlo automaticamente al "calar della notte". 
</p>
<h3><span class="mw-headline" id="setchown">setchown</span></h3>
<p>Questo script si usa meno del precedente, ma in alcuni casi è molto utile. Cosa fà lo script ? Semplice, <i>corregge i permessi su file e directory delle home degli utenti</i>. A volte magari, come amministratore,  si ripristinano, copiano o spostano dei file da una cartella di un utente ad un altro e poi dobbiamo manualmente lavorare di <i>chown</i> e <i>chmod</i> per sistemare il tutto. Lo script <i>setchown</i> lo fa da solo spazzolando tutte le home degli utenti (con i parametro <i>all</i>) correggendo permessi e proprietà.  Creiamo il file:
</p>
<pre>sudo nano /bin/setchown 
</pre>
<p>e inseriamoci quanto segue:
</p>
<pre>#!/bin/bash
# setchown
# Setta il proprietario della home dir e dei file allo user
# escludi dal processo le home listate nella var "exclude"
exclude="httpd ftp amavis";
# Controlla i parametri
if [ $# = 0 ]
 then
   echo "uso: setchown {all|&lt;username&gt;}"
   exit;
 else
  if [ $1 = 'all' ]
   then
    DIR=`ls /home -F | awk '/\/$/ {sub( /\/$/,""); print}'`;
   else
    DIR=$1;
  fi;
fi; 
#
for user in $DIR; do
    mask=${exclude#*$user};
    if [ "$mask" = "$exclude" ]
     then
      chown $user /home/$user -R
      chmod 700 /home/$user
      echo "Permessi corretti in /home/$user";
    fi
done
</pre>
<p>Anche qui vediamo che possiamo digitare <i>setchown all</i> per tutte le home oppure <i>setchown tecnico1</i> per la singola home.
Non dimentichiamoci di rendere eseguibile lo script:
</p>
<pre>sudo chmod 755 /bin/setchown
</pre>
<p>Tenete presente anche la variabile <i>$exclude</i> nello script, in cui dobbiamo inserire la lista delle cartelle in home da non processare. Ho messo  "httpd","ftp" e "amavis" che Archlinux ha la malaugurata idea di creare in home (ma <i>/var</i> faceva schifo ?).
</p>
<h2><span class="mw-headline" id="Firewall">Firewall</span></h2>
<p>Ora possiamo riabilitare il firewall. Prima modifichiamo il file <i>rules</i>:
</p>
<pre>sudo nano /etc/shorewall/rules
</pre>
<p>e aggiungiamo le nuove regole:
</p>
<pre>SMB/ACCEPT      $FW             loc
SMB/ACCEPT      loc             $FW
</pre>
<p>Per riavviare il servizio usiamo il comando <i>shorewall</i>, così vediamo se abbiamo commesso sbagli:
</p>
<pre>sudo shorewall start
</pre>
<h2><span class="mw-headline" id="Abbiamo_finito_.3F">Abbiamo finito ?</span></h2>
<p>In teoria sì, in pratica no. Per domini semplici da pochi utenti potreste essere già ok, ma la realtà è ben diversa dalla teoria e nel proseguo scoprirete uno dei perché con un semplice esempio.
</p>
<h1><span class="mw-headline" id="Gestione_dei_permessi">Gestione dei permessi</span></h1>
<p>Seeee, abbiamo il nostro nuovo <i>scintillante</i> domain controller Samba su Archlinux, abbiamo sottomesso i creduloni client windows (avete fatto la join al dominio da windows ? Questo non ve lo spiego mica ...) facendoli illudere di giocare in casa. Ah! Con il petto in fuori ci fregiamo a pieno titolo del grado di "sysnetworksuperexpertadmin". Wow, e cosa ci ferma più? --- <b>Vi fermo io, e con un esempio semplice semplice</b>. Ecco un caso pratico che dimostra ancora una volta, se ce ne fosse bisogno, come fra la teoria e la pratica ... ci sia di mezzo il vostro zelante capo ufficio tecnico. 
</p>
<p>Raccontiamo una storia.
</p>
<h2><span class="mw-headline" id="Gli_utenti_Windows">Gli utenti Windows</span></h2>
<p>Tutti abbiamo abbiamo usato o usiamo tuttora (e perchè no?) Windows. Voglia o no questo sistema operativo rappresenta il <i>motore</i> del 92%-98% (a seconda degli studi) dei PC in questo pianeta. Impossibile non farci i conti.
Un tipico utente di questo sistema operativo (e per tipico intendo chi lo usa per lavoro o per gioco senza conoscenze tecniche informatiche) non ha mai avuto a che fare con <i>diritti di accesso e permessi</i> su file o attività del computer. Probabilmente non sanno nemmeno che esistono dato che il 99% dei PC con windows lavorano con <i>Administrator</i> o con un utente equivalente. (Spesso se ci si sottrae a questa regola addirittura certi software non funzionano, quindi candidamente ammetto che <i>pure io</i> in Windows lavoro come <i>Administrator</i>).
</p>
<p>Ma quando però scoprono che esistono è la fine, specie se hanno qualche autorità in azienda. "Io voglio vedere i file di Antonio che può vedere quelli Giovanni che però non può cancellare quelli di Lucia. Ok ? " 
Vengono da voi "sysnetworksuperexpertadmin" e cominciano con queste richieste cambiando idea ogni 2 minuti circa. Vi assicuro che capita, capita...
</p>
<h2><span class="mw-headline" id="Un_caso_pratico">Un caso pratico</span></h2>
<p>Senza andare sul paradossale presentiamo un caso molto frequente e per niente ingiustificato, e vediamo se riusciamo a risolverlo con Samba.
Come dicevo all'inizio, il Responsabile dell'Ufficio Tecnico viene da voi e vi dice:
</p>
<p><i>"Antonio e Giovanni disegnano e amministrano le schede tecniche dei prodotti. Vorrei che salvassero i disegni su L:\prodotti e che Lucia e Maria potessero visualizzarle o inviarle ai clienti senza però poterle cancellare o modificare."</i>
</p>
<p>Bhe, richiesta ragionevole direi. Sufficente, però, a metterci in crisi. Vediamo perchè.
</p>
<h2><span class="mw-headline" id="Mettamoci_la_lavoro">Mettamoci la lavoro</span></h2>
<p>Allora, noi abbiamo la condivisione <i>"public"</i> (che i nostri utenti chiamano L:\), creiamo gli utenti, la cartella "prodotti" e un gruppo "Prodotti" che come membri ha Antonio e Giovanni. Cosa già vista, facciamolo il fretta:
</p>
<pre>sudo netuseradd -a -m Antonio
sudo netpasswd Antonio
sudo netuseradd -a -m Giovanni
sudo netpasswd Giovanni 
sudo netgroupadd -a Prodotti
sudo netgroupmod -m Antonio,Giovanni Prodotti
sudo mkdir /samba/public/prodotti
sudo chmod 770 /samba/public/prodotti
sudo chgrp Prodotti /samba/public/prodotti
sudo chmod g+s /samba/public/prodotti
</pre>
<p>Bene. Ora <i>Antonio</i> e <i>Giovanni</i> hanno a disposizione <i>L:\prodotti</i> su cui possono leggere e scrivere liberamente senza aver minimamente modificato la configurazione di Samba, ho solo agito su utenti gruppi e permessi sul file system.
Andiamo avanti. Per <i>Lucia</i> e <i>Maria</i> creiamo un gruppo "Prodotti-RO" (Read Only):
</p>
<pre>sudo netuseradd -a -m Lucia
sudo netpasswd Lucia
sudo netuseradd -a -m Maria
sudo netpasswd Maria
sudo netgroupadd -a Prodotti-RO
sudo netgroupmod -m Lucia,Maria Prodotti-RO
</pre>
<p>E adesso ? Cosa faccio ?
</p>
<ol>
<li> <i>Cambio permessi a /samba/public/prodotti in 775 così gli "altri" possono leggerci ma non scriverci.</i> Sbagliato. Così anche gli utenti del gruppo "Commerciale" che non c'entrano nulla possono leggerci.</li>
<li> <i>Uso i parametri di smb.conf "Read List" e "Write List".</i> Sbagliato. I parametri agiscono su tutta la share/condivisione "public" e hanno la precedenza su quelle del file system. Lucia e Maria non potrebbero scrivere nemmeno su L:\COMUNE.</li>
<li> <i>Faccio una share "prodotti" apposita slegata da "public".</i>Ok, funziona ma a me non piace. Se per ogni caso del genere devo fare una share nuova in breve esaurisco le lettere dell'alfabeto per mapparle e il mio <i>smb.conf</i> diventa un libro. E poi ci hanno richiesto "L:\prodotti", non vorrete mica deluderli ? Con Windows si faceva in due secondi.</li>
</ol>
<p>Prima che buttiate dalla finestra la vostra spilla di Samba vi dico che la soluzione c'e'. Poco usata e pubblicizzata ma c'e'.
</p>
<h2><span class="mw-headline" id="Samba_non_c.27entra">Samba non c'entra</span></h2>
<p>E sì. Samba non c'entra con questa limitazione. Samba poggia i suoi servizi sul file system che trova (ext3 nel mio caso) e fà il possibile per "mascherarlo" ma in questo caso non può nulla.
Semplicemente abbiamo scoperto la forte limitazione del meccanismo "tripletta" rwxrwxrwx tipico di unix. Fanno quasi tenerezza se confrontati con la granularità di permessi che riesco a raggiungere con NTFS. Inadeguati. Completamente inadeguati.
Ma non penserete mica che nessuno ci abbia fatto caso a questo ? Naturalmente sì, e un bel po' di anni fà.
</p>
<h2><span class="mw-headline" id="ACL_POSIX">ACL POSIX</span></h2>
<p>La soluzione al nostro problema passa attraverso una estensione della gestione dei permessi chiamate <b>ACL POSIX</b>. Ancora una bozza, non facili da capire e gestire ma perfettamente funzionanti su Linux.
La cosa simpatica è che sulla nostra Arch (su tutte le distro che io sappia) sono già installate e supportate, basta solo attivarle.
Editiamo il nostro /etc/fstab :
</p>
<pre>sudo nano /etc/fstab
</pre>
<p>e abilitamole specificando il flag "acl" nel mount del nostro file system:
</p>
<pre>/dev/sda3 / ext3 defaults,<b>acl</b> 0 1
</pre>
<p>Riavviamo e siamo a posto. Abbiamo le estensioni attivate.
</p>
<h4><span class="mw-headline" id="setfacl_.26_getfacl">setfacl &amp; getfacl</span></h4>
<p>Questi sono i nostri due nuovi amici, <i>setfacl</i> per settare i permessi estesi e <i>getfacl</i> per visualizzarli. Non stò a spiegare come funzionano in dettaglio le acl posix, c'e' chi lo ha già fatto in modo ottimale. Per approfondire leggete ad esempio <a rel="nofollow" class="external text" href="http://www.suse.de/~agruen/acl/linux-acls/online/">qui</a>, oppure <a rel="nofollow" class="external text" href="http://a2.pluto.it/a2218.htm">qui</a> se preferite la lingua italiana.
Questa è la nostra situazione:
</p>
<pre>drwxrws---  2 root Prodotti     4096 21 dic 15:46 prodotti
</pre>
<p>Visualizziamola con :
</p>
<pre>sudo getfacl /samba/public/prodotti
</pre>
<p>e ottengo questo, non ho attivato alcuna estensione e quindi corrispondono ai normali flag che tutti conosciamo :
</p>
<pre># file: samba/public/prodotti
# owner: root
# group: Prodotti
user::rwx
group::rwx
other::---
</pre>
<p>Ora impostamo i nostri sospirati permessi al gruppo "Prodotti-RO":
</p>
<pre>sudo setfacl -d -m group:Prodotti-RO:r-x /samba/public/prodotti
sudo setfacl -m group:Prodotti-RO:r-x /samba/public/prodotti
</pre>
<p>Visualizziamo di nuovo:
</p>
<pre>sudo getfacl /samba/public/prodotti
</pre>
<p>e stavolta ottengo questo:
</p>
<pre># file: prodotti
# owner: root
# group: Prodotti
user::rwx
group::rwx
group:Prodotti-RO:r-x
mask::rwx
other::---
default:user::rwx
default:group::rwx
default:group:Prodotti-RO:r-x
default:mask::rwx
default:other::---
</pre>
<p>Bene. Abbiamo dato i permessi di lettura al gruppo "Permessi-RO", impostandoli anche come default. Riappuntiamoci sul petto la nostra spilla di "sysnetworksuperexpertadmin" :).
Se adesso riguardiamo la situazione con <i>ls -al</i> vedo questo :
</p>
<pre>drwxrws---+  2 root Prodotti     4096 21 dic 15:46 prodotti
</pre>
<p>Il segno '+' alla fine indica che nella cartella <i>prodotti</i> sono attive le estensioni acl posix.
</p>
<p>Questa parte non è proprio specifica di Arch, ma serve sopratutto per capire come anche problemi semplici a volte possono farci traballare e desistere se non si hanno delle basi. E se ne potrebbe fare una montagna di esempi come questo, anche qualcuno da cui non se ne esce ... 
I manuali di Samba in PDF hanno oltre 1200 pagine, e nessuna scritta per niente.  La cosa divertente è che leggendoli e studiandoli capite pure come funziona Windows meglio di molti altri.
Le ACL Posix sono importanti e hanno un piacevole effetto collaterale (voluto ovviamente): 'possiamo gestire e cambiare i permessi sulle cartelle anche direttamente da Windows<i>.</i>
Basta collegarsi con "Administrator" sul dominio da una macchina Windows e con pulsante destro-&gt;proprieta-&gt;protezione sulla cartella "prodotti" vedo le permissions ACL Posix che posso pure cambiare: Samba si occuperà del comando <i>setfacl</i> corrispondente.
</p>
<p>Ma voi preferite la shell vero ?
</p>
<h1><span class="mw-headline" id="Conclusioni">Conclusioni</span></h1>
<p>Terminiamo qui la parte <i>File Server</i>. Si potrebbe continuare per non sò quanto, ma tutto quello che potremmo dire sarebbe "Off Topic" in questa guida incentrata su ArchLinux. Tutto "il di più" sarebbe qualcosa di <i>cross distro</i> (sì può dire ?) ed esistono già valide guide sul web. Limitiamoci allora ad una lista di cose che potrebbero risultare utili e su cui magari sarebbe oppurtuno approfondire in modo autonomo.
</p>
<h2><span class="mw-headline" id="Print_services">Print services</span></h2>
<p>Non abbiamo minimamente parlato delle condivisioni delle stampanti. Qui si aprirebbe un altro fronte che coinvolge CUPS e la distribuzione automatica dei drivers stampante ai client Windows. Samba supporta questa funzionalità, e il posto migliore dove apprendere questa tecnica sono le guide ufficiali.
Io personalmente non l'ho mai implementato non per pigrizia ma per le oramai onnipresenti stampanti con scheda di rete integrata a cui i client inviano direttamente le stampe. Tuttavia una sbirciatina non fà male.
</p>
<h2><span class="mw-headline" id="Client_grafici_di_amministrazione">Client grafici di amministrazione</span></h2>
<p>Abbiamo già visto come sia possibile da Windows amministrare le <i>permissions</i> sulle share Samba. Esistono anche delle GUI che ci permettono di gestire utenti e password in modo semplice, specie se le opzioni da settare sono un po' <i>esotiche</i>, tipo la scadenza della password o la lista delle workstation da cui un utente può fare il logon. Ne esistono diversi, dall'ufficale <a rel="nofollow" class="external text" href="http://de.samba.org/samba/docs/man/Samba-HOWTO-Collection/SWAT.html">Samba Web Adiministration Tool (SWAT)</a> all' <a rel="nofollow" class="external text" href="http://lam.sourceforge.net/">LDAP Account Manager</a>. Possiamo usarne anche da Windows, ad esempio dal mio preferito (forse perchè fatto con Delphi ?) <a rel="nofollow" class="external text" href="http://ldapadmin.sourceforge.net/">LDAP Admin</a>, allo <a rel="nofollow" class="external text" href="http://www.microsoft.com/downloads/details.aspx?FamilyID=C0011AB8-3178-4701-A791-EAFBA0F42DE2&amp;displaylang=en">User Manager for Domains</a> "ufficiale" fornito da Microsoft (non è uno scherzo) per amministrare i vari aspetti e flag.
</p>
<h2><span class="mw-headline" id="Quota">Quota</span></h2>
<p>Altro aspetto interessante è la gestione delle <i>Disk Quota</i> da assegnare ad utenti e gruppi. Questo, come per le ACL Posix, è un "affare" anche del file system, oltre che di Samba con il <i>vfs objects = default_quota</i>.
</p>
<p>Per installare le utility di gestione usate :
</p>
<pre>sudo pacman -S quota-tools
</pre>
<p>Potete trovare informazioni sulla parte file system su come amministrarli e configurarli in giro per la rete, ad esempio <a rel="nofollow" class="external text" href="http://a2.pluto.it/a2204.htm">qui</a>. Per la parte Samba naturalmente la solita "bibbia" rappresentata dalle guide ufficiali.
</p>
<h2><span class="mw-headline" id="Comandi_Samba">Comandi Samba</span></h2>
<p>Samba viene fornito con una serie di comandi utili all'amministratore, da <i>pdbedit</i> per amministrare utenti e gruppi alla pletora dei comandi <i>net</i> disponibili. Facciamo un paio di esempi, con il comando:
</p>
<pre>sudo net rpc rights list -U Administrator
</pre>
<p>ottengo questo:
</p>
<pre>    SeMachineAccountPrivilege  Add machines to domain
     SeTakeOwnershipPrivilege  Take ownership of files or other objects
            SeBackupPrivilege  Back up files and directories
           SeRestorePrivilege  Restore files and directories
    SeRemoteShutdownPrivilege  Force shutdown from a remote system
     SePrintOperatorPrivilege  Manage printers
          SeAddUsersPrivilege  Add users and groups to the domain
      SeDiskOperatorPrivilege  Manage disk shares
</pre>
<p>e vedo i permessi dell'utente Administrator. Potrei voler assegnare una "right" di amministrazione a qualche altro utente, e questo si fà con i comandi <i>net rpc right</i>.
</p>
<p>Se digito :
</p>
<pre>sudo pdbedit -L -v Antonio
</pre>
<p>Ottengo
</p>
<pre>Unix username:        antonio
NT username:          antonio
Account Flags:        [UX         ]
User SID:             S-1-5-21-1491279793-2809991009-2777690449-11012
Primary Group SID:    S-1-5-21-1491279793-2809991009-2777690449-513
Full Name:            antonio
Home Directory:
HomeDir Drive:        K:
Logon Script:         antonio.bat
Profile Path:
Domain:               MEDE
Account desc:
Workstations:
Munged dial:
Logon time:           0
Logoff time:          never
Kickoff time:         never
Password last set:    0
Password can change:  0
Password must change: 0
Last bad password   : 0
Bad password count  : 0
Logon hours         : FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
</pre>
<p>che sono tutte le impostazioni assegnate all'utente <i>Antonio</i> e che posso variare con <i>pdbedit</i>. Gran parte di queste le posso anche  amministrare con il nostro <i>netusermod</i>, ma sicuramente il comando standard è più completo essendo parte di Samba.
</p>
<p>I comandi <i>man net</i> e <i>man pdbedit</i> forniscono le informazioni di cui si ha bisogno.
</p>
<h2><span class="mw-headline" id="Lock_sui_file">Lock sui file</span></h2>
<p>Stiamo amministrando un server con dei file condivisi, quindi il lock dei file è cosa vitale. In genere non ci sono problemi, Samba "standard" ci risolve già gran parte dei problemi, ma in alcuni casi (tipo il "solito" file access mdb condiviso) dovete metter manina voi.
Vi scontrerete ad esempio con il concetto di <i>"Opportunistic Locking"</i> inventato da Microsoft per aumentare le performance in rete, ma che in alcuni casi con Samba non produce gli effetti desiderati. Niente paura, vanno solo gestiti.
Anche in questo caso (son stufo di scriverlo) vi rimando alla guida ufficiale.
</p>
<h2><span class="mw-headline" id="Sicurezza">Sicurezza</span></h2>
<p>Non abbiamo nemmeno discusso della messa in sicurezza del colloquio tra Samba e OpenLDAP che adesso avviene in chiaro. Essendo entrambi i servizi nella stessa macchina magari il problema e minimo, ma se cominciate ad avere più server Samba che "puntano" allo stesso server LDAP o più server LDAP replicati magari in remoto tra sedi diverse è una opzione da prendere in seria considerazione.
</p>
<h2><span class="mw-headline" id="Client_Linux">Client Linux</span></h2>
<p>O perbacco ! E i client Linux ? Qualcuno comincerà ad arrivare...
Per le autenticazioni LDAP e le share non credo sia un problema (anche se devo ogni volta digitare utente e password), ma il logon ad un dominio Microsoft ? Ho visto solo due distro che lo fanno: SLED e la sua controparte libera OpenSUSE. Quindi è possibile ma mi sento proprio impreparato sull'argomento. Fatemi sapere voi magari.
</p>
<h2><span class="mw-headline" id="Concludiamo_managgia_.21">Concludiamo managgia !</span></h2>
<p>Dite la verità: <i>Pensavate fosse più semplice</i>. O almeno è quello che ho pensato io la prima volta che mi sono imbattuto in questi argomenti. Spero di aver acceso l'interesse di qualcuno che abbia la voglia di <i>studiare</i>, la rete offre tutto di cui si ha bisogno. E credetemi, se imparate bene ad amministrare LOS (<b>L</b>inux <b>O</b>penldap <b>S</b>amba) amigos (senza dimenticare DNS/DHCP) domani (quasi) potete installare una rete con Windows, perchè i concetti li conoscete (anche più in profondità di altri), dovete solo scoprire dove fare "click" con il mouse (uaaaah, questa forse è grossa ma suona bene :)).
</p>
<p>Ma che bello era fare "Pulsante destro sulla cartella -&gt; convidi con nome -&gt; ok " ?
</p>
</div>
<div id="catlinks" class="catlinks"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../../it/Category:Small_Business_Server.html" title="Category:Small Business Server (Italiano)">Small Business Server (Italiano)</a></li></ul>
</div></div>					<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
						<ul id="f-list" style="margin: 0 2em">
									<li>
Retrieved from "<a dir="ltr" href="https://wiki.archlinux.org/index.php?title=Small_Business_Server_(Italiano)/File_Server_Domain_Controller&amp;oldid=422958">https://wiki.archlinux.org/index.php?title=Small_Business_Server_(Italiano)/File_Server_Domain_Controller&amp;oldid=422958</a>"</li>
					<li id="lastmod"> This page was last modified on 27 February 2016, at 23:01.</li>
									<li id="copyright">Content is available under <a class="external" rel="nofollow" href="http://www.gnu.org/copyleft/fdl.html">GNU Free Documentation License 1.3 or later</a> unless otherwise noted.</li>
									<br><li id="privacy"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:Privacy policy">Privacy policy</a></li>
									<li id="about"><a href="../../en/ArchWiki:About.html" title="ArchWiki:About">About ArchWiki</a></li>
									<li id="disclaimer"><a href="../../en/ArchWiki:General_disclaimer.html" title="ArchWiki:General disclaimer">Disclaimers</a></li>
							</ul>
		</div>
		</div>
		</body>
</html>
