<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8">
<title>ZFS - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<style></style>
<meta name="generator" content="MediaWiki 1.26.4">
<meta name="robots" content="noindex,follow">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-ZFS skin-archlinux action-view">

		<div id="globalWrapper" style="width: 100%">
		<div id="column-content">
			<div id="content" class="mw-body" role="main" style="margin: 0.5em; margin-bottom:0; margin-top:0">
				<a id="top"></a>
				
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">ZFS</h1>
				
				<div id="bodyContent" class="mw-body-content">
					<div id="contentSub"></div>
										<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div style="width:45%; margin: 0 0 0.5em 0.5em;">
<p style="background:#333; color:white; padding:0.2em; border-bottom:5px #08c solid; margin:0; text-align:center; font-weight:bold;">Related articles</p>
<ul style="list-style-type:none; margin:0; padding:0.3em;">
<li style="padding:0.4em 0; line-height:1;"><a href="../en/File_systems.html" title="File systems">File systems</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/ZFS/Virtual_disks.html" title="Experimenting with ZFS" class="mw-redirect">Experimenting with ZFS</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Installing_Arch_Linux_on_ZFS.html" title="Installing Arch Linux on ZFS">Installing Arch Linux on ZFS</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/ZFS.html" title="ZFS on FUSE" class="mw-redirect">ZFS on FUSE</a></li>
</ul>
</div>
<p><a href="https://en.wikipedia.org/wiki/ZFS" class="extiw" title="wikipedia:ZFS">ZFS</a> is an advanced filesystem created by <a href="https://en.wikipedia.org/wiki/Sun_Microsystems" class="extiw" title="wikipedia:Sun Microsystems">Sun Microsystems</a> (now owned by Oracle) and released for OpenSolaris in November 2005.  
</p>
<p>Features of ZFS include: pooled storage (integrated volume management â€“ zpool), <a href="https://en.wikipedia.org/wiki/Copy-on-write" class="extiw" title="wikipedia:Copy-on-write">Copy-on-write</a>, <a href="https://en.wikipedia.org/wiki/Snapshot_(computer_storage)" class="extiw" title="wikipedia:Snapshot (computer storage)">snapshots</a>, data integrity verification and automatic repair (scrubbing), <a href="https://en.wikipedia.org/wiki/RAID-Z" class="extiw" title="wikipedia:RAID-Z">RAID-Z</a>, a maximum <a href="https://en.wikipedia.org/wiki/Exabyte" class="extiw" title="wikipedia:Exabyte">16 Exabyte</a> file size, and a maximum 256 Quadrillion <a href="https://en.wikipedia.org/wiki/Zettabyte" class="extiw" title="wikipedia:Zettabyte">Zettabytes</a> storage with no limit on number of filesystems (datasets) or files<a rel="nofollow" class="external autonumber" href="http://docs.oracle.com/cd/E19253-01/819-5461/zfsover-2/index.html">[1]</a>. ZFS is licensed under the <a href="https://en.wikipedia.org/wiki/CDDL" class="extiw" title="wikipedia:CDDL">Common Development and Distribution License</a> (CDDL).
</p>
<p>Described as <a rel="nofollow" class="external text" href="http://web.archive.org/web/20060428092023/http://www.sun.com/2004-0914/feature/">"The last word in filesystems"</a> ZFS is stable, fast, secure, and future-proof.  Being licensed under the CDDL, and thus incompatible with GPL, it is not possible for ZFS to be distributed along with the Linux Kernel. This requirement, however, does not prevent a native Linux kernel module from being developed and distributed by a third party, as is the case with <a rel="nofollow" class="external text" href="http://zfsonlinux.org/">zfsonlinux.org</a> (ZOL).
</p>
<p>ZOL is a project funded by the <a rel="nofollow" class="external text" href="https://www.llnl.gov/">Lawrence Livermore National Laboratory</a> to develop a native Linux kernel module for its massive storage requirements and super computers.
</p>
<div id="toc" class="toc">
<div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1">
<a href="#Installation"><span class="tocnumber">1</span> <span class="toctext">Installation</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#General"><span class="tocnumber">1.1</span> <span class="toctext">General</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#Root_on_ZFS"><span class="tocnumber">1.2</span> <span class="toctext">Root on ZFS</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#DKMS"><span class="tocnumber">1.3</span> <span class="toctext">DKMS</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-5"><a href="#Experimenting_with_ZFS"><span class="tocnumber">2</span> <span class="toctext">Experimenting with ZFS</span></a></li>
<li class="toclevel-1 tocsection-6">
<a href="#Configuration"><span class="tocnumber">3</span> <span class="toctext">Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-7"><a href="#Automatic_Start"><span class="tocnumber">3.1</span> <span class="toctext">Automatic Start</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8">
<a href="#Create_a_storage_pool"><span class="tocnumber">4</span> <span class="toctext">Create a storage pool</span></a>
<ul>
<li class="toclevel-2 tocsection-9"><a href="#Advanced_format_disks"><span class="tocnumber">4.1</span> <span class="toctext">Advanced format disks</span></a></li>
<li class="toclevel-2 tocsection-10"><a href="#Verifying_pool_creation"><span class="tocnumber">4.2</span> <span class="toctext">Verifying pool creation</span></a></li>
<li class="toclevel-2 tocsection-11"><a href="#GRUB-compatible_pool_creation"><span class="tocnumber">4.3</span> <span class="toctext">GRUB-compatible pool creation</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#Importing_a_pool_created_by_id"><span class="tocnumber">4.4</span> <span class="toctext">Importing a pool created by id</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-13">
<a href="#Tuning"><span class="tocnumber">5</span> <span class="toctext">Tuning</span></a>
<ul>
<li class="toclevel-2 tocsection-14"><a href="#General_2"><span class="tocnumber">5.1</span> <span class="toctext">General</span></a></li>
<li class="toclevel-2 tocsection-15"><a href="#SSD_Caching"><span class="tocnumber">5.2</span> <span class="toctext">SSD Caching</span></a></li>
<li class="toclevel-2 tocsection-16"><a href="#Database"><span class="tocnumber">5.3</span> <span class="toctext">Database</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#.2Ftmp"><span class="tocnumber">5.4</span> <span class="toctext">/tmp</span></a></li>
<li class="toclevel-2 tocsection-18">
<a href="#ZVOLs"><span class="tocnumber">5.5</span> <span class="toctext">ZVOLs</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#RAIDZ_and_Advanced_Format_physical_disks"><span class="tocnumber">5.5.1</span> <span class="toctext">RAIDZ and Advanced Format physical disks</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-20">
<a href="#Usage"><span class="tocnumber">6</span> <span class="toctext">Usage</span></a>
<ul>
<li class="toclevel-2 tocsection-21"><a href="#Scrub"><span class="tocnumber">6.1</span> <span class="toctext">Scrub</span></a></li>
<li class="toclevel-2 tocsection-22"><a href="#Check_zfs_pool_status"><span class="tocnumber">6.2</span> <span class="toctext">Check zfs pool status</span></a></li>
<li class="toclevel-2 tocsection-23"><a href="#Destroy_a_storage_pool"><span class="tocnumber">6.3</span> <span class="toctext">Destroy a storage pool</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#Export_a_storage_pool"><span class="tocnumber">6.4</span> <span class="toctext">Export a storage pool</span></a></li>
<li class="toclevel-2 tocsection-25"><a href="#Rename_a_Zpool"><span class="tocnumber">6.5</span> <span class="toctext">Rename a Zpool</span></a></li>
<li class="toclevel-2 tocsection-26"><a href="#Setting_a_Different_Mount_Point"><span class="tocnumber">6.6</span> <span class="toctext">Setting a Different Mount Point</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Swap_volume"><span class="tocnumber">6.7</span> <span class="toctext">Swap volume</span></a></li>
<li class="toclevel-2 tocsection-28">
<a href="#Automatic_snapshots"><span class="tocnumber">6.8</span> <span class="toctext">Automatic snapshots</span></a>
<ul>
<li class="toclevel-3 tocsection-29"><a href="#ZFS_Automatic_Snapshot_Service_for_Linux"><span class="tocnumber">6.8.1</span> <span class="toctext">ZFS Automatic Snapshot Service for Linux</span></a></li>
<li class="toclevel-3 tocsection-30"><a href="#ZFS_Snapshot_Manager"><span class="tocnumber">6.8.2</span> <span class="toctext">ZFS Snapshot Manager</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-31">
<a href="#Troubleshooting"><span class="tocnumber">7</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-32"><a href="#ZPool_creation_fails"><span class="tocnumber">7.1</span> <span class="toctext">ZPool creation fails</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#ZFS_is_using_too_much_RAM"><span class="tocnumber">7.2</span> <span class="toctext">ZFS is using too much RAM</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Does_not_contain_an_EFI_label"><span class="tocnumber">7.3</span> <span class="toctext">Does not contain an EFI label</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#No_hostid_found"><span class="tocnumber">7.4</span> <span class="toctext">No hostid found</span></a></li>
<li class="toclevel-2 tocsection-36">
<a href="#On_boot_the_zfs_pool_does_not_mount_stating:_.22pool_may_be_in_use_from_other_system.22"><span class="tocnumber">7.5</span> <span class="toctext">On boot the zfs pool does not mount stating: "pool may be in use from other system"</span></a>
<ul>
<li class="toclevel-3 tocsection-37"><a href="#Unexported_pool"><span class="tocnumber">7.5.1</span> <span class="toctext">Unexported pool</span></a></li>
<li class="toclevel-3 tocsection-38"><a href="#Incorrect_hostid"><span class="tocnumber">7.5.2</span> <span class="toctext">Incorrect hostid</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-39"><a href="#Devices_have_different_sector_alignment"><span class="tocnumber">7.6</span> <span class="toctext">Devices have different sector alignment</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-40">
<a href="#Tips_and_tricks"><span class="tocnumber">8</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-41"><a href="#Embed_the_archzfs_packages_into_an_archiso"><span class="tocnumber">8.1</span> <span class="toctext">Embed the archzfs packages into an archiso</span></a></li>
<li class="toclevel-2 tocsection-42"><a href="#Encryption_in_ZFS_on_linux"><span class="tocnumber">8.2</span> <span class="toctext">Encryption in ZFS on linux</span></a></li>
<li class="toclevel-2 tocsection-43"><a href="#Emergency_chroot_repair_with_archzfs"><span class="tocnumber">8.3</span> <span class="toctext">Emergency chroot repair with archzfs</span></a></li>
<li class="toclevel-2 tocsection-44">
<a href="#Bindmount"><span class="tocnumber">8.4</span> <span class="toctext">Bindmount</span></a>
<ul>
<li class="toclevel-3 tocsection-45"><a href="#fstab"><span class="tocnumber">8.4.1</span> <span class="toctext">fstab</span></a></li>
<li class="toclevel-3 tocsection-46"><a href="#systemd_mount_unit"><span class="tocnumber">8.4.2</span> <span class="toctext">systemd mount unit</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1 tocsection-47"><a href="#See_also"><span class="tocnumber">9</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Installation">Installation</span></h2>
<h3><span class="mw-headline" id="General">General</span></h3>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-git/">zfs-linux-git</a></span><sup><small>AUR</small></sup> from the <a href="../en/Arch_User_Repository.html" title="Arch User Repository">Arch User Repository</a> or the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository. This package has <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-utils-linux-git/">zfs-utils-linux-git</a></span><sup><small>AUR</small></sup> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/spl-linux-git/">spl-linux-git</a></span><sup><small>AUR</small></sup> as a dependency, which in turn has <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/spl-utils-linux-git/">spl-utils-linux-git</a></span><sup><small>AUR</small></sup> as dependency. SPL (Solaris Porting Layer) is a Linux Kernel module implementing Solaris APIs for ZFS compatibility.
</p>
<p>For users that desire ZFS builds from stable releases, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-linux-lts/">zfs-linux-lts</a></span><sup><small>AUR</small></sup> is available from the <a href="../en/Arch_User_Repository.html" title="Arch User Repository">Arch User Repository</a> or the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository. A script to build ZFS and its dependencies automatically can be found <a href="#Automated_build_script">here</a><sup>[<a href="../en/ArchWiki:Requests.html#Broken_section_links" title="ArchWiki:Requests">broken link</a>: invalid section]</sup>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>The ZFS and SPL kernel modules are tied to a specific kernel version. It would not be possible to apply any kernel updates until updated packages are uploaded to AUR or the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository.</div>
<p>Test the installation by issuing <code>zpool status</code> on the command line. If an "insmod" error is produced, try <code>depmod -a</code>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong> You can <a href="../en/Downgrading_packages.html" title="Downgrade" class="mw-redirect">downgrade</a> your linux version to the one from <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repo if your current kenel is newer.</div>
<h3><span class="mw-headline" id="Root_on_ZFS">Root on ZFS</span></h3>
<p>When performing an Arch install on ZFS, <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-git/">zfs-git</a></span><sup><small>AUR</small></sup><sup>[<a href="../en/ArchWiki:Requests.html#Broken_package_links" title="ArchWiki:Requests">broken link</a>: archived in <a rel="nofollow" class="external text" href="https://github.com/felixonmars/aur3-mirror/tree/master/zfs-git">aur-mirror</a>]</sup> and its dependencies can be installed in the archiso environment as outlined in the previous section.
</p>
<p>It may be useful to prepare a <a href="#Embed_the_archzfs_packages_into_an_archiso">customized archiso</a> with ZFS support builtin. For a much more detailed guide on installing Arch with ZFS as its root file system, see <a href="../en/Installing_Arch_Linux_on_ZFS.html" title="Installing Arch Linux on ZFS">Installing Arch Linux on ZFS</a>.
</p>
<h3><span class="mw-headline" id="DKMS">DKMS</span></h3>
<p>Users can make use of DKMS <a href="../en/Dynamic_Kernel_Module_Support.html" title="Dynamic Kernel Module Support">Dynamic Kernel Module Support</a> to rebuild the ZFS modules automatically with every kernel upgrade. 
</p>
<p>Install <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms/">zfs-dkms</a></span><sup><small>AUR</small></sup> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-dkms-git/">zfs-dkms-git</a></span><sup><small>AUR</small></sup> and apply the post-install instructions given by these packages.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Add an <code>IgnorePkg</code> entry to <a href="../en/Pacman.html#Configuration" title="Pacman.conf" class="mw-redirect">pacman.conf</a> to prevent these packages from upgrading when doing a regular update.</div>
<h2><span class="mw-headline" id="Experimenting_with_ZFS">Experimenting with ZFS</span></h2>
<p>Users wishing to experiment with ZFS on <i>virtual block devices</i> (known in ZFS terms as VDEVs) which can be simple files like <code>~/zfs0.img</code> <code>~/zfs1.img</code> <code>~/zfs2.img</code> etc. with no possibility of real data loss are encouraged to see the <a href="../en/ZFS/Virtual_disks.html" title="Experimenting with ZFS" class="mw-redirect">Experimenting with ZFS</a> article.  Common tasks like building a RAIDZ array, purposefully corrupting data and recovering it, snapshotting datasets, etc. are covered.
</p>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<p>ZFS is considered a "zero administration" filesystem by its creators; therefore, configuring ZFS is very straight forward. Configuration is done primarily with two commands: <code>zfs</code> and <code>zpool</code>.
</p>
<h3><span class="mw-headline" id="Automatic_Start">Automatic Start</span></h3>
<p>For ZFS to live by its "zero administration" namesake, the zfs daemon must be loaded at startup. A benefit to this is that it is not necessary to mount the zpool in <code>/etc/fstab</code>; the zfs daemon can import and mount zfs pools automatically. The daemon mounts the zfs pools reading the file <code>/etc/zfs/zpool.cache</code>.
</p>
<p>For each pool you want automatically mounted by the zfs daemon execute:
</p>
<pre># zpool set cachefile=/etc/zfs/zpool.cache &lt;pool&gt;
</pre>
<p>Enable the service so it is automatically started at boot time:
</p>
<pre># systemctl enable zfs.target
</pre>
<p>To manually start the daemon:
</p>
<pre># systemctl start zfs.target
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If <code>zfs-mount.service</code> fails on boot due to running before the kernel module is loaded, you may have to manually enable the <code>zfs-import-cache.service</code>. 
<pre># systemctl enable zfs-import-cache.service
</pre>
</div>
<h2><span class="mw-headline" id="Create_a_storage_pool">Create a storage pool</span></h2>
<p>Use <code> # parted --list</code> to see a list of all available drives. It is not necessary nor recommended to partition the drives before creating the zfs filesystem.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If some or all device have been used in a software RAID set it is paramount to erase any old RAID configuration information. (<a href="../en/RAID.html#Prepare_the_Devices" title="Mdadm" class="mw-redirect">Mdadm#Prepare_the_Devices</a>) </div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>For Advanced Format Disks with 4KB sector size, an ashift of 12 is recommended for best performance. Advanced Format disks emulate a sector size of 512 bytes for compatibility with legacy systems, this causes ZFS to sometimes use an ashift option number that is not ideal. Once the pool has been created, the only way to change the ashift option is to recreate the pool. Using an ashift of 12 would also decrease available capacity. See <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq#performance-considerations">1.10 Whatâ€™s going on with performance?</a>, <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq#advanced-format-disks">1.15 How does ZFS on Linux handle Advanced Format disks?</a>, and <a rel="nofollow" class="external text" href="http://wiki.illumos.org/display/illumos/ZFS+and+Advanced+Format+disks">ZFS and Advanced Format disks</a>.</div>
<p>Having identified the list of drives, it is now time to get the id's of the drives to add to the zpool.  The <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq#selecting-dev-names-when-creating-a-pool">zfs on Linux developers recommend</a> using device ids when creating ZFS storage pools of less than 10 devices. To find the id's, simply:
</p>
<pre># ls -lh /dev/disk/by-id/
</pre>
<p>The ids should look similar to the following:
</p>
<pre>lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0JKRR -&gt; ../../sdc
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0JTM1 -&gt; ../../sde
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0KBP8 -&gt; ../../sdd
lrwxrwxrwx 1 root root  9 Aug 12 16:26 ata-ST3000DM001-9YN166_S1F0KDGY -&gt; ../../sdb
</pre>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" width="48" height="48"></a><b>This article or section needs language, wiki syntax or style improvements.</b><a href="../File:Tango-edit-clear.png" class="image"><img alt="Tango-edit-clear.png" src="../File:Tango-edit-clear.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Missing references to <a href="../en/Persistent_block_device_naming.html" title="Persistent block device naming">Persistent block device naming</a>, it is useless to explain the differences (or even what they are) here. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:ZFS">Talk:ZFS#</a>)</div>
</div>
<p>Disk labels and UUID can also be used for ZFS mounts by using <a href="../en/Partitioning.html#GUID_Partition_Table" title="GUID Partition Table" class="mw-redirect">GPT</a> partitions. ZFS drives have labels but Linux is unable to read them at boot. Unlike <a href="../en/Partitioning.html#Master_Boot_Record" title="Master Boot Record" class="mw-redirect">MBR</a> partitions, GPT partitions directly support both UUID and labels independent of the format inside the partition. Partitioning rather than using the whole disk for ZFS offers two additional advantages. The OS does not generate bogus partition numbers from whatever unpredictable data ZFS has written to the partition sector, and if desired, you can easily over provision SSD drives, and slightly over provision spindle drives to ensure that different models with slightly different sector counts can zpool replace into your mirrors. This is a lot of organization and control over ZFS using readily available tools and techniques at almost zero cost.
</p>
<p>Use <a href="../en/Partitioning.html#GUID_Partition_Table" title="GUID Partition Table" class="mw-redirect">gdisk</a> to partition the all or part of the drive as a single partition. gdisk does not automatically name partitions so if partition labels are desired use gdisk command "c" to label the partitions. Some reasons you might prefer labels over UUID are: labels are easy to control, labels can be titled to make the purpose of each disk in your arrangement readily apparent, and labels are shorter and easier to type. These are all advantages when the server is down and the heat is on. GPT partition labels have plenty of space and can store most international characters <a href="https://en.wikipedia.org/wiki/GUID_Partition_Table#Partition_entries" class="extiw" title="wikipedia:GUID Partition Table">wikipedia:GUID_Partition_Table#Partition_entries</a> allowing large data pools to be labeled in an organized fashion.
</p>
<p>Drives partitioned with GPT have labels and UUID that look like this. 
</p>
<pre># ls -l /dev/disk/by-partlabel
# lrwxrwxrwx 1 root root 10 Apr 30 01:44 zfsdata1 -&gt; ../../sdd1
# lrwxrwxrwx 1 root root 10 Apr 30 01:44 zfsdata2 -&gt; ../../sdc1
# lrwxrwxrwx 1 root root 10 Apr 30 01:59 zfsl2arc -&gt; ../../sda1
</pre>
<pre># ls -l /dev/disk/by-partuuid
# lrwxrwxrwx 1 root root 10 Apr 30 01:44 148c462c-7819-431a-9aba-5bf42bb5a34e -&gt; ../../sdd1
# lrwxrwxrwx 1 root root 10 Apr 30 01:59 4f95da30-b2fb-412b-9090-fc349993df56 -&gt; ../../sda1
# lrwxrwxrwx 1 root root 10 Apr 30 01:44 e5ccef58-5adf-4094-81a7-3bac846a885f -&gt; ../../sdc1
</pre>
<p>Now, finally, create the ZFS pool:
</p>
<pre># zpool create -f -m &lt;mount&gt; &lt;pool&gt; raidz &lt;ids&gt;
</pre>
<ul><li> <b>create</b>: subcommand to create the pool.</li></ul>
<ul><li> <b>-f</b>: Force creating the pool. This is to overcome the "EFI label error". See <a href="#Does_not_contain_an_EFI_label">#Does not contain an EFI label</a>.</li></ul>
<ul><li> <b>-m</b>: The mount point of the pool. If this is not specified, then the pool will be mounted to <code>/&lt;pool&gt;</code>.</li></ul>
<ul><li> <b>pool</b>: This is the name of the pool.</li></ul>
<ul><li> <b>raidz</b>: This is the type of virtual device that will be created from the pool of devices. Raidz is a special implementation of raid5. See <a rel="nofollow" class="external text" href="https://blogs.oracle.com/bonwick/entry/raid_z">Jeff Bonwick's Blog -- RAID-Z</a> for more information about raidz.</li></ul>
<ul><li> <b>ids</b>: The names of the drives or partitions that to include into the pool. Get it from <code>/dev/disk/by-id</code>.</li></ul>
<p>Here is an example for the full command:
</p>
<pre># zpool create -f -m /mnt/data bigdata \
               raidz \
                  ata-ST3000DM001-9YN166_S1F0KDGY \
                  ata-ST3000DM001-9YN166_S1F0JKRR \
                  ata-ST3000DM001-9YN166_S1F0KBP8 \
                  ata-ST3000DM001-9YN166_S1F0JTM1
</pre>
<h3><span class="mw-headline" id="Advanced_format_disks">Advanced format disks</span></h3>
<p>In case Advanced Format disks are used which have a native sector size of 4096 bytes instead of 512 bytes, the automated sector size detection algorithm of ZFS might detect 512 bytes because the backwards compatibility with legacy systems. This would result in degraded performance. To make sure a correct sector size is used, the <code>ashift=12</code> option should be used (See the <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq#advanced-format-disks">ZFS on Linux FAQ</a>). The full command would in this case be:
</p>
<pre># zpool create -f -o ashift=12 -m /mnt/data bigdata \
               raidz \
                  ata-ST3000DM001-9YN166_S1F0KDGY \
                  ata-ST3000DM001-9YN166_S1F0JKRR \
                  ata-ST3000DM001-9YN166_S1F0KBP8 \
                  ata-ST3000DM001-9YN166_S1F0JTM1
</pre>
<h3><span class="mw-headline" id="Verifying_pool_creation">Verifying pool creation</span></h3>
<p>If the command is successful, there will be no output. Using the <code>$ mount</code> command will show that the pool is mounted. Using <code># zpool status</code> will show that the pool has been created.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
  pool: bigdata
 state: ONLINE
 scan: none requested
config:

        NAME                                       STATE     READ WRITE CKSUM
        bigdata                                    ONLINE       0     0     0
          -0                                       ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KDGY-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JKRR-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KBP8-part1  ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JTM1-part1  ONLINE       0     0     0

errors: No known data errors
</pre>
<p>At this point it would be good to reboot the machine to ensure that the ZFS pool is mounted at boot. It is best to deal with all errors before transferring data.
</p>
<h3><span class="mw-headline" id="GRUB-compatible_pool_creation">GRUB-compatible pool creation</span></h3>
<p>By default, <i>zpool</i> will enable all features on a pool. If <code>/boot</code> resides on ZFS and when using <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you must only enable read-only, or non-read-only features supported by GRUB, otherwise GRUB will not be able to read the pool. As of GRUB 2.02.beta3, GRUB supports all features in ZFS-on-Linux 0.6.5.7. However, the Git master branch of ZoL contains one extra feature, <code>large_dnodes</code> that is not yet supported by GRUB.
</p>
<p>This example line is only necessary if you are using the Git branch of ZoL:
</p>
<pre> # zpool create -f -d \
                -o feature@async_destroy=enabled \
                -o feature@empty_bpobj=enabled \
                -o feature@lz4_compress=enabled \
                -o feature@spacemap_histogram=enabled \
                -o feature@enabled_txg=enabled \
                -o feature@hole_birth=enabled \
                -o feature@bookmarks=enabled \
                -o feature@filesystem_limits \
                -o feature@embedded_data=enabled \
                -o feature@large_blocks=enabled \
                &lt;pool_name&gt; &lt;vdevs&gt;
</pre>
<h3><span class="mw-headline" id="Importing_a_pool_created_by_id">Importing a pool created by id</span></h3>
<p>Eventually a pool may fail to auto mount and you need to import to bring your pool back. Take care to avoid the most obvious solution.
</p>
<pre># ###zpool import zfsdata # Do not do this! Always use -d
</pre>
<p>This will import your pools using <code>/dev/sd?</code> which will lead to problems the next time you rearrange your drives. This may be as simple as rebooting with a USB drive left in the machine, which harkens back to a time when PC's would not boot when a floppy disk was left in a machine. Adapt one of the following commands to import your pool so that pool imports retain the persistence they were created with.
</p>
<pre># zpool import -d /dev/disk/by-id zfsdata
# zpool import -d /dev/disk/by-partlabel zfsdata
# zpool import -d /dev/disk/by-partuuid zfsdata
</pre>
<h2><span class="mw-headline" id="Tuning">Tuning</span></h2>
<h3><span class="mw-headline" id="General_2">General</span></h3>
<p>Many parameters are available for zfs file systems, you can view a full list with <code>zfs get all &lt;pool&gt;</code>. Two common ones to adjust are <b>atime</b> and <b>compression</b>.
</p>
<p>Atime is enabled by default but for most users, it represents superfluous writes to the zpool and it can be disabled using the zfs command:
</p>
<pre># zfs set atime=off &lt;pool&gt;
</pre>
<p>As an alternative to turning off atime completely, <b>relatime</b> is available. This brings the default ext4/xfs atime semantics to ZFS, where access time is only updated if the modified time or changed time changes, or if the existing access time has not been updated within the past 24 hours. It is a compromise between atime=off and atime=on. This property <i>only</i> takes effect if <b>atime</b> is <b>on</b>:
</p>
<pre># zfs set relatime=on &lt;pool&gt;
</pre>
<p>Compression is just that, transparent compression of data.  ZFS supports a few different algorithms, presently lz4 is the default.  <b>gzip</b> is also available for seldom-written yet highly-compressable data; consult the man page for more details.  Enable compression using the zfs command:
</p>
<pre># zfs set compression=on &lt;pool&gt;
</pre>
<p>Other options for zfs can be displayed again, using the zfs command:
</p>
<pre># zfs get all &lt;pool&gt;
</pre>
<h3><span class="mw-headline" id="SSD_Caching">SSD Caching</span></h3>
<p>You can also add SSD devices as a write intent log (external ZIL or SLOG) and also as a layer 2 adaptive replacement cache (l2arc). The process to add them is very similar to creating a new VDEV.
</p>
<p>All of the below references to device-id are the IDs from /dev/disk/by-id/*
</p>
<p>To add a ZIL:
</p>
<pre> zpool add &lt;pool&gt; log &lt;device-id&gt;
</pre>
<p>or to add a mirrored ZIL:
</p>
<pre> zpool add &lt;pool&gt; log mirror &lt;device-id-1&gt; &lt;device-id-2&gt;
</pre>
<p><br>
To add an l2arc:
</p>
<pre> zpool add &lt;pool&gt; cache &lt;device-id&gt;
</pre>
<p>or to add a mirrored l2arc:
</p>
<pre> zpool add &lt;pool&gt; cache mirror &lt;device-id-1&gt; &lt;device-id-2&gt;
</pre>
<h3><span class="mw-headline" id="Database">Database</span></h3>
<p>ZFS, unlike most other file systems, has a variable record size, or what is commonly referred to as a block size. By default, the recordsize on ZFS is 128KiB, which means it will dynamically allocate blocks of any size from 512B to 128KiB depending on the size of file being written. This can often help fragmentation and file access, at the cost that ZFS would have to allocate new 128KiB blocks each time only a few bytes are written to.
</p>
<p>Most RDBMSes work in 8KiB-sized blocks by default. Although the block size is tunable for <a href="../en/MySQL.html" title="MySQL">MySQL/MariaDB</a>, <a href="../en/PostgreSQL.html" title="PostgreSQL">PostgreSQL</a>, and <a href="../en/Oracle.html" title="Oracle">Oracle</a>, all three of them use an 8KiB block size <i>by default</i>. For both performance concerns and keeping snapshot differences to a minimum (for backup purposes, this is helpful), it is usually desirable to tune ZFS instead to accommodate the databases, using a command such as:
</p>
<pre># zfs set recordsize=8K &lt;pool&gt;/postgres
</pre>
<p>These RDBMSes also tend to implement their own caching algorithm, often similar to ZFS's own ARC. In the interest of saving memory, it is best to simply disable ZFS's caching of the database's file data and let the database do its own job:
</p>
<pre># zfs set primarycache=metadata &lt;pool&gt;/postgres
</pre>
<p>If your pool has no configured log devices, ZFS reserves space on the pool's data disks for its intent log (the ZIL). ZFS uses this for crash recovery, but databases are often syncing their data files to the file system on their own transaction commits anyway. The end result of this is that ZFS will be committing data <b>twice</b> to the data disks, and it can severely impact performance. You can tell ZFS to prefer to not use the ZIL, and in which case, data is only committed to the file system once. Setting this for non-database file systems, or for pools with configured log devices, can actually <i>negatively</i> impact the performance, so beware:
</p>
<pre># zfs set logbias=throughput &lt;pool&gt;/postgres
</pre>
<p>These can also be done at file system creation time, for example:
</p>
<pre># zfs create -o recordsize=8K \
             -o primarycache=metadata \
             -o mountpoint=/var/lib/postgres \
             -o logbias=throughput \
              &lt;pool&gt;/postgres
</pre>
<p>Please note: these kinds of tuning parameters are ideal for specialized applications like RDBMSes. You can easily <i>hurt</i> ZFS's performance by setting these on a general-purpose file system such as your /home directory.
</p>
<h3><span class="mw-headline" id=".2Ftmp">/tmp</span></h3>
<p>If you would like to use ZFS to store your /tmp directory, which may be useful for storing arbitrarily-large sets of files or simply keeping your RAM free of idle data, you can generally improve performance of certain applications writing to /tmp by disabling file system sync. This causes ZFS to ignore an application's sync requests (eg, with <code>fsync</code> or <code>O_SYNC</code>) and return immediately. While this has severe application-side data consistency consequences (never disable sync for a database!), files in /tmp are less likely to be important and affected. Please note this does <i>not</i> affect the integrity of ZFS itself, only the possibility that data an application expects on-disk may not have actually been written out following a crash.
</p>
<pre># zfs set sync=disabled &lt;pool&gt;/tmp
</pre>
<p>Additionally, for security purposes, you may want to disable <b>setuid</b> and <b>devices</b> on the /tmp file system, which prevents some kinds of privilege-escalation attacks or the use of device nodes:
</p>
<pre># zfs set setuid=off &lt;pool&gt;/tmp
# zfs set devices=off &lt;pool&gt;/tmp
</pre>
<p>Combining all of these for a create command would be as follows:
</p>
<pre># zfs create -o setuid=off -o devices=off -o sync=disabled -o mountpoint=/tmp &lt;pool&gt;/tmp
</pre>
<p>Please note, also, that if you want /tmp on ZFS, you will need to mask (disable) <a href="../en/Systemd.html" title="Systemd">systemd</a>'s automatic tmpfs-backed /tmp, else ZFS will be unable to mount your dataset at boot-time or import-time:
</p>
<pre># systemctl mask tmp.mount
</pre>
<h3><span class="mw-headline" id="ZVOLs">ZVOLs</span></h3>
<p>ZFS volumes (ZVOLs) can suffer from the same block size-related issues as RDBMSes, but it is worth noting that the default recordsize for ZVOLs is 8KiB already. If possible, it is best to align any partitions contained in a ZVOL to your recordsize (current versions of fdisk and gdisk by default automatically align at 1MiB segments, which works), and file system block sizes to the same size. Other than this, you might tweak the <b>recordsize</b> to accommodate the data inside the ZVOL as necessary (though 8KiB tends to be a good value for most file systems, even when using 4KiB blocks on that level).
</p>
<h4><span class="mw-headline" id="RAIDZ_and_Advanced_Format_physical_disks">RAIDZ and Advanced Format physical disks</span></h4>
<p>Each block of a ZVOL gets its own parity disks, and if you have physical media with logical block sizes of 4096B, 8192B, or so on, the parity needs to be stored in whole physical blocks, and this can drastically increase the space requirements of a ZVOL, requiring 2Ã— or more physical storage capacity than the ZVOL's logical capacity.  Setting the <b>recordsize</b> to 16k or 32k can help reduce this footprint drastically.
</p>
<p>See <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/issues/1807">ZFS on Linux issue #1807 for details</a>
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<p>Users can optionally create a dataset under the zpool as opposed to manually creating directories under the zpool.  Datasets allow for an increased level of control (quotas for example) in addition to snapshots.  To be able to create and mount a dataset, a directory of the same name must not pre-exist in the zpool. To create a dataset, use:
</p>
<pre># zfs create &lt;nameofzpool&gt;/&lt;nameofdataset&gt;
</pre>
<p>It is then possible to apply ZFS specific attributes to the dataset. For example, one could assign a quota limit to a specific directory within a dataset:
</p>
<pre># zfs set quota=20G &lt;nameofzpool&gt;/&lt;nameofdataset&gt;/&lt;directory&gt;
</pre>
<p>To see all the commands available in ZFS, useÂ :
</p>
<pre>$ man zfs
</pre>
<p>or:
</p>
<pre>$ man zpool
</pre>
<h3><span class="mw-headline" id="Scrub">Scrub</span></h3>
<p>ZFS pools should be scrubbed at least once a week. To scrub the pool:
</p>
<pre># zpool scrub &lt;pool&gt;
</pre>
<p>To do automatic scrubbing once a week, set the following line in the root crontab:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># crontab -e</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
...
30 19 * * 5 zpool scrub &lt;pool&gt;
...
</pre>
<p>Replace <code>&lt;pool&gt;</code> with the name of the ZFS pool.
</p>
<h3><span class="mw-headline" id="Check_zfs_pool_status">Check zfs pool status</span></h3>
<p>To print a nice table with statistics about the ZFS pool, including and read/write errors, use
</p>
<pre># zpool status -v
</pre>
<h3><span class="mw-headline" id="Destroy_a_storage_pool">Destroy a storage pool</span></h3>
<p>ZFS makes it easy to destroy a mounted storage pool, removing all metadata about the ZFS device. This command destroys any data contained in the pool:
</p>
<pre># zpool destroy &lt;pool&gt;
</pre>
<p>And now when checking the status:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">no pools available</pre>
<p>To find the name of the pool, see <a href="#Check_zfs_pool_status">#Check zfs pool status</a>.
</p>
<h3><span class="mw-headline" id="Export_a_storage_pool">Export a storage pool</span></h3>
<p>If a storage pool is to be used on another system, it will first need to be exported. It is also necessary to export a pool if it has been imported from the archiso as the hostid is different in the archiso as it is in the booted system. The zpool command will refuse to import any storage pools that have not been exported. It is possible to force the import with the <code>-f</code> argument, but this is considered bad form.
</p>
<p>Any attempts made to import an un-exported storage pool will result in an error stating the storage pool is in use by another system. This error can be produced at boot time abruptly abandoning the system in the busybox console and requiring an archiso to do an emergency repair by either exporting the pool, or adding the <code>zfs_force=1</code> to the kernel boot parameters (which is not ideal). See <a href="#On_boot_the_zfs_pool_does_not_mount_stating:_.22pool_may_be_in_use_from_other_system.22">#On boot the zfs pool does not mount stating: "pool may be in use from other system"</a>
</p>
<p>To export a pool,
</p>
<pre># zpool export bigdata
</pre>
<h3><span class="mw-headline" id="Rename_a_Zpool">Rename a Zpool</span></h3>
<p>Renaming a zpool that is already created is accomplished in 2 steps:
</p>
<pre># zpool export oldname
# zpool import oldname newname
</pre>
<h3><span class="mw-headline" id="Setting_a_Different_Mount_Point">Setting a Different Mount Point</span></h3>
<p>The mount point for a given zpool can be moved at will with one command:
</p>
<pre># zfs set mountpoint=/foo/bar poolname
</pre>
<h3><span class="mw-headline" id="Swap_volume">Swap volume</span></h3>
<p>ZFS does not allow to use swapfiles, but users can use a ZFS volume (ZVOL) as swap.  It is importart to set the ZVOL block size to match the system page size, which can be obtained by the <code>getconf PAGESIZE</code> command (default on x86_64 is 4KiB).  Another option useful for keeping the system running well in low-memory situations is not caching the ZVOL data.
</p>
<p>Create a 8GiB zfs volume:
</p>
<pre># zfs create -V 8G -b $(getconf PAGESIZE) \
              -o primarycache=metadata \
              -o com.sun:auto-snapshot=false &lt;pool&gt;/swap
</pre>
<p>Prepare it as swap partition:
</p>
<pre># mkswap -f /dev/zvol/&lt;pool&gt;/swap
# swapon /dev/zvol/&lt;pool&gt;/swap
</pre>
<p>To make it permanent, edit <code>/etc/fstab</code>.  ZVOLs support discard, which can potentially help ZFS's block allocator and reduce fragmentation for all other datasets when/if swap is not full.
</p>
<p>Add a line to <code>/etc/fstab</code>:
</p>
<pre>/dev/zvol/&lt;pool&gt;/swap none swap discard 0 0
</pre>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> The hibernate hook is deprecated. Does the limitation still apply? (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:ZFS">Talk:ZFS#</a>)</div>
</div>
<p>Keep in mind the Hibernate hook must be loaded before filesystems, so using ZVOL as swap will not allow to use hibernate function. If you need hibernate, keep a partition for it.
</p>
<p>Make sure to unmount all ZFS filesystems before rebooting the machine, otherwise any ZFS pools will refuse to be imported:
</p>
<pre># zfs umount -a
</pre>
<h3><span class="mw-headline" id="Automatic_snapshots">Automatic snapshots</span></h3>
<h4><span class="mw-headline" id="ZFS_Automatic_Snapshot_Service_for_Linux">ZFS Automatic Snapshot Service for Linux</span></h4>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-auto-snapshot-git/">zfs-auto-snapshot-git</a></span><sup><small>AUR</small></sup> package from <a href="../en/Arch_User_Repository.html" title="Arch User Repository">AUR</a> provides a shell script to automate the management of snapshots, with each named by date and label (hourly, daily, etc), giving quick and convenient snapshotting of all ZFS datasets.  The package also installs cron tasks for quarter-hourly, hourly, daily, weekly, and monthly snapshots.  Optionally adjust the --keep parameter from the defaults depending on how far back the snapshots are to go (the monthly script by default keeps data for up to a year).
</p>
<p>To prevent a dataset from being snapshotted at all, set <code>com.sun:auto-snapshot=false</code> on it.  Likewise, set more fine-grained control as well by label, if, for example, no monthlies are to be kept on a snapshot, for example, set <code>com.sun:auto-snapshot:monthly=false</code>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>zfs-auto-snapshot-git will not create snapshots during scrubbing (<a href="../en/ZFS.html#Scrub" title="ZFS">scrub</a>). It is possible to override this by editing provided systemd unit (<a href="../en/Systemd.html#Editing_provided_units" title="Systemd">Systemd#Editing_provided_units</a>) and removing `--skip-scrub` from `ExecStart` line. Consequences not known, someone please edit.
</div>
<h4><span class="mw-headline" id="ZFS_Snapshot_Manager">ZFS Snapshot Manager</span></h4>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/zfs-snap-manager/">zfs-snap-manager</a></span><sup><small>AUR</small></sup> package from <a href="../en/Arch_User_Repository.html" title="Arch User Repository">AUR</a> provides a python service that takes daily snapshots from a configurable set of ZFS datasets and cleans them out in a <a href="https://en.wikipedia.org/wiki/Backup_rotation_scheme#Grandfather-father-son" class="extiw" title="wikipedia:Backup rotation scheme">"Grandfather-father-son"</a> scheme. It can be configured to e.g. keep 7 daily, 5 weekly, 3 monthly and 2 yearly snapshots. 
</p>
<p>The package also supports configurable replication to other machines running ZFS by means of <code>zfs send</code> and <code>zfs receive</code>. If the destination machine runs this package as well, it could be configured to keep these replicated snapshots for a longer time. This allows a setup where a source machine has only a few daily snapshots locally stored, while on a remote storage server a much longer retention is available.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<h3><span class="mw-headline" id="ZPool_creation_fails">ZPool creation fails</span></h3>
<p>If the following error occurs then it can be fixed.
</p>
<pre># the kernel failed to rescan the partition table: 16
# cannot label 'sdc': try using parted(8) and then provide a specific slice: -1
</pre>
<p>One reason this can occur is because <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/issues/2582">ZFS expects pool creation to take less than 1 second</a>. This is a reasonable assumption under ordinary conditions, but in many situations it may take longer. Each drive will need to be cleared again before another attempt can be made.
</p>
<pre># parted /dev/sda rm 1
# parted /dev/sda rm 1
# dd if=/dev/zero of=/dev/sdb bs=512 count=1
# zpool labelclear /dev/sda
</pre>
<p>A brute force creation can be attempted over and over again, and with some luck the ZPool creation will take less than 1 second.
Once cause for creation slowdown can be slow burst read writes on a drive. By reading from the disk in parallell to ZPool creation, it may be possible to increase burst speeds.
</p>
<pre># dd if=/dev/sda of=/dev/null
</pre>
<p>This can be done with multiple drives by saving the above command for each drive to a file on separate lines and running 
</p>
<pre># cat $FILE | parallel
</pre>
<p>Then run ZPool creation at the same time.
</p>
<h3><span class="mw-headline" id="ZFS_is_using_too_much_RAM">ZFS is using too much RAM</span></h3>
<p>By default, ZFS caches file operations (<a href="https://en.wikipedia.org/wiki/Adaptive_replacement_cache" class="extiw" title="wikipedia:Adaptive replacement cache">ARC</a>) using up to two-thirds of available system memory on the host. To adjust the ARC size, add the following to the <a href="../en/Kernel_parameters.html" title="Kernel parameters">Kernel parameters</a> list:
</p>
<pre>zfs.zfs_arc_max=536870912 # (for 512MB)
</pre>
<p>For a more detailed description, as well as other configuration options, see <a rel="nofollow" class="external text" href="http://wiki.gentoo.org/wiki/ZFS#ARC">gentoo-wiki:zfs#arc</a>.
</p>
<h3><span class="mw-headline" id="Does_not_contain_an_EFI_label">Does not contain an EFI label</span></h3>
<p>The following error will occur when attempting to create a zfs filesystem,
</p>
<pre>/dev/disk/by-id/&lt;id&gt; does not contain an EFI label but it may contain partition
</pre>
<p>The way to overcome this is to use <code>-f</code> with the zfs create command.
</p>
<h3><span class="mw-headline" id="No_hostid_found">No hostid found</span></h3>
<p>An error that occurs at boot with the following lines appearing before initscript output:
</p>
<pre>ZFS: No hostid found on kernel command line or /etc/hostid.
</pre>
<p>This warning occurs because the ZFS module does not have access to the spl hosted. There are two solutions, for this. Either place the spl hostid in the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> in the boot loader. For example, adding <code>spl.spl_hostid=0x00bab10c</code>.
</p>
<p>The other solution is to make sure that there is a hostid in <code>/etc/hostid</code>, and then regenerate the initramfs image. Which will copy the hostid into the initramfs image.
</p>
<pre># mkinitcpio -p linux
</pre>
<h3><span class="mw-headline" id="On_boot_the_zfs_pool_does_not_mount_stating:_.22pool_may_be_in_use_from_other_system.22">On boot the zfs pool does not mount stating: "pool may be in use from other system"</span></h3>
<h4><span class="mw-headline" id="Unexported_pool">Unexported pool</span></h4>
<p>If the new installation does not boot because the zpool cannot be imported, chroot into the installation and properly export the zpool. See <a href="#Emergency_chroot_repair_with_archzfs">#Emergency chroot repair with archzfs</a>.
</p>
<p>Once inside the chroot environment, load the ZFS module and force import the zpool,
</p>
<pre># zpool import -a -f
</pre>
<p>now export the pool:
</p>
<pre># zpool export &lt;pool&gt;
</pre>
<p>To see the available pools, use,
</p>
<pre># zpool status
</pre>
<p>It is necessary to export a pool because of the way ZFS uses the hostid to track the system the zpool was created on. The hostid is generated partly based on the network setup. During the installation in the archiso the network configuration could be different generating a different hostid than the one contained in the new installation. Once the zfs filesystem is exported and then re-imported in the new installation, the hostid is reset. See <a rel="nofollow" class="external text" href="http://osdir.com/ml/zfs-discuss/2011-06/msg00227.html">Re: Howto zpool import/export automatically? - msg#00227</a>.
</p>
<p>If ZFS complains about "pool may be in use" after every reboot, properly export pool as described above, and then rebuild ramdisk in normally booted system:
</p>
<pre># mkinitcpio -p linux
</pre>
<h4><span class="mw-headline" id="Incorrect_hostid">Incorrect hostid</span></h4>
<p>Double check that the pool is properly exported. Exporting the zpool clears the hostid marking the ownership. So during the first boot the zpool should mount correctly. If it does not there is some other problem.
</p>
<p>Reboot again, if the zfs pool refuses to mount it means the hostid is not yet correctly set in the early boot phase and it confuses zfs. Manually tell zfs the correct number, once the hostid is coherent across the reboots the zpool will mount correctly.
</p>
<p>Boot using zfs_force and write down the hostid. This one is just an example.
</p>
<pre>% hostid
0a0af0f8
</pre>
<p>This number have to be added to the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a> as <code>spl.spl_hostid=0x0a0af0f8</code>. Another solution is writing the hostid inside the initram image, see the <a href="../en/Installing_Arch_Linux_on_ZFS.html#After_the_first_boot" title="Installing Arch Linux on ZFS">installation guide</a> explanation about this.
</p>
<p>Users can always ignore the check adding <code>zfs_force=1</code> in the <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>, but it is not advisable as a permanent solution.
</p>
<h3><span class="mw-headline" id="Devices_have_different_sector_alignment">Devices have different sector alignment</span></h3>
<p>Once a drive has become faulted it should be replaced A.S.A.P. with an identical drive.
</p>
<pre># zpool replace bigdata ata-ST3000DM001-9YN166_S1F0KDGY ata-ST3000DM001-1CH166_W1F478BD -f
</pre>
<p>but in this instance, the following error is produced:
</p>
<pre>cannot replace ata-ST3000DM001-9YN166_S1F0KDGY with ata-ST3000DM001-1CH166_W1F478BD: devices have different sector alignment
</pre>
<p>ZFS uses the ashift option to adjust for physical block size. When replacing the faulted disk, ZFS is attempting to use <code>ashift=12</code>, but the faulted disk is using a different ashift (probably <code>ashift=9</code>) and this causes the resulting error. 
</p>
<p>For Advanced Format Disks with 4KB blocksize, an ashift of 12 is recommended for best performance. See <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq#performance-considerations">1.10 Whatâ€™s going on with performance?</a> and <a rel="nofollow" class="external text" href="http://wiki.illumos.org/display/illumos/ZFS+and+Advanced+Format+disks">ZFS and Advanced Format disks</a>.
</p>
<p>Use zdb to find the ashift of the zpool: <code>zdb </code>, then use the <code>-o</code> argument to set the ashift of the replacement drive:
</p>
<pre># zpool replace bigdata ata-ST3000DM001-9YN166_S1F0KDGY ata-ST3000DM001-1CH166_W1F478BD -o ashift=9 -f
</pre>
<p>Check the zpool status for confirmation:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># zpool status -v</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
pool: bigdata
state: DEGRADED
status: One or more devices is currently being resilvered.  The pool will
        continue to function, possibly in a degraded state.
action: Wait for the resilver to complete.
scan: resilver in progress since Mon Jun 16 11:16:28 2014
    10.3G scanned out of 5.90T at 81.7M/s, 20h59m to go
    2.57G resilvered, 0.17% done
config:

        NAME                                   STATE     READ WRITE CKSUM
        bigdata                                DEGRADED     0     0     0
        raidz1-0                               DEGRADED     0     0     0
            replacing-0                        OFFLINE      0     0     0
            ata-ST3000DM001-9YN166_S1F0KDGY    OFFLINE      0     0     0
            ata-ST3000DM001-1CH166_W1F478BD    ONLINE       0     0     0  (resilvering)
            ata-ST3000DM001-9YN166_S1F0JKRR    ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0KBP8    ONLINE       0     0     0
            ata-ST3000DM001-9YN166_S1F0JTM1    ONLINE       0     0     0

errors: No known data errors</pre>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Embed_the_archzfs_packages_into_an_archiso">Embed the archzfs packages into an archiso</span></h3>
<p>Follow the <a href="../en/Archiso.html" title="Archiso">Archiso</a> steps for creating a fully functional Arch Linux live CD/DVD/USB image.
</p>
<p>Enable the <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/archlive/pacman.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
...
[archzfs]
Server = http://archzfs.com/$repo/x86_64
</pre>
<p>Add the <code>archzfs-linux</code> group to the list of packages to be installed (the <code>archzfs</code> repository provides packages for the x86_64 architecture only).
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">~/archlive/packages.x86_64</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
...
archzfs-linux
</pre>
<p>Complete <a href="../en/Archiso.html#Build_the_ISO" title="Archiso">Build the ISO</a> to finally build the iso.
</p>
<h3><span class="mw-headline" id="Encryption_in_ZFS_on_linux">Encryption in ZFS on linux</span></h3>
<p>ZFS on linux does not support encryption directly, but zpools can be created in dm-crypt block devices. Since the zpool is created on the plain-text
abstraction it is possible to have the data encrypted while having all the advantages of ZFS like deduplication, compression, and data robustness.
</p>
<p>dm-crypt, possibly via LUKS, creates devices in <code>/dev/mapper</code> and their name is fixed. So you just need to change <code>zpool create</code> commands to
point to that names. The idea is configuring the system to create the <code>/dev/mapper</code> block devices and import the zpools from there.
Since zpools can be created in multiple devices (raid, mirroring, striping, ...), it is important all the devices are encrypted otherwise the protection
might be partially lost.
</p>
<p>For example, an encrypted zpool can be created using plain dm-crypt (without LUKS) with:
</p>
<pre># cryptsetup --hash=sha512 --cipher=twofish-xts-plain64 --offset=0 \
             --key-file=/dev/sdZ --key-size=512 open --type=plain /dev/sdX enc
# zpool create zroot /dev/mapper/enc
</pre>
<p>In the case of a root filesystem pool, the <code>mkinicpio.conf</code> HOOKS line will enable the keyboard for the password, create the devices, and load the pools. It will contain something like:
</p>
<pre>HOOKS="... keyboard encrypt zfs ..."
</pre>
<p>Since the <code>/dev/mapper/enc</code> name is fixed no import errors will occur.
</p>
<p>Creating encrypted zpools works fine. But if you need encrypted directories, for example to protect your users' homes, ZFS loses some functionality.
</p>
<p>ZFS will see the encrypted data, not the plain-text abstraction, so compression and deduplication will not work. The reason is that encrypted data has always high entropy making compression ineffective and even from the same input you get different output (thanks to salting) making deduplication impossible.
To reduce the unnecessary overhead it is possible to create a sub-filesystem for each encrypted directory and use <a href="../en/ECryptfs.html" title="ECryptfs">eCryptfs</a> on it.
</p>
<p>For example to have an encrypted home: (the two passwords, encryption and login, must be the same)
</p>
<pre># zfs create -o compression=off \
             -o dedup=off \
             -o mountpoint=/home/&lt;username&gt; \
             &lt;zpool&gt;/&lt;username&gt;
# useradd -m &lt;username&gt;
# passwd &lt;username&gt;
# ecryptfs-migrate-home -u &lt;username&gt;
&lt;log in user and complete the procedure with ecryptfs-unwrap-passphrase&gt;
</pre>
<h3><span class="mw-headline" id="Emergency_chroot_repair_with_archzfs">Emergency chroot repair with archzfs</span></h3>
<p>To get into the ZFS filesystem from live system for maintenance, there are two options:
</p>
<ol>
<li> Build custom archiso with ZFS as described in <a href="#Embed_the_archzfs_packages_into_an_archiso">#Embed the archzfs packages into an archiso</a>.</li>
<li> Boot the latest official archiso and bring up the network. Then enable <a href="../en/Unofficial_user_repositories.html#archzfs" title="Unofficial user repositories">archzfs</a> repository inside the live system as usual, sync the pacman package database and install the <i>archzfs-archiso-linux</i> package.</li>
</ol>
<p>To start the recovery, load the ZFS kernel modules:
</p>
<pre># modprobe zfs
</pre>
<p>Import the pool:
</p>
<pre># zpool import -a -R /mnt
</pre>
<p>Mount the boot partitions (if any):
</p>
<pre># mount /dev/sda2 /mnt/boot
# mount /dev/sda1 /mnt/boot/efi
</pre>
<p>Chroot into the ZFS filesystem:
</p>
<pre># arch-chroot /mnt /bin/bash
</pre>
<p>Check the kernel version:
</p>
<pre># pacman -Qi linux
# uname -r
</pre>
<p>uname will show the kernel version of the archiso. If they are different, run depmod (in the chroot) with the correct kernel version of the chroot installation:
</p>
<pre># depmod -a 3.6.9-1-ARCH (version gathered from pacman -Qi linux but using the matching kernel modules directory name under the chroot's /lib/modules)
</pre>
<p>This will load the correct kernel modules for the kernel version installed in the chroot installation.
</p>
<p>Regenerate the ramdisk:
</p>
<pre># mkinitcpio -p linux
</pre>
<p>There should be no errors.
</p>
<h3><span class="mw-headline" id="Bindmount">Bindmount</span></h3>
<p>Here a bind mount from /mnt/zfspool to /srv/nfs4/music is created. The configuration ensures that the zfs pool is ready before the bind mount is created.
</p>
<h4><span class="mw-headline" id="fstab">fstab</span></h4>
<p>See <a rel="nofollow" class="external text" href="http://www.freedesktop.org/software/systemd/man/systemd.mount.html">systemd.mount</a> for more information on how systemd converts fstab into mount unit files with <a rel="nofollow" class="external text" href="http://www.freedesktop.org/software/systemd/man/systemd-fstab-generator.html">systemd-fstab-generator</a>.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/fstab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
/mnt/zfspool		/srv/nfs4/music		none	bind,defaults,nofail,x-systemd.requires=zfs-mount.service	0 0
</pre>
<h4><span class="mw-headline" id="systemd_mount_unit">systemd mount unit</span></h4>
<p>If it is not possible to bindmount a directory residing on zfs onto another directory using fstab, because the fstab is read before the zfs pool is ready, you can overcome this limitation with a systemd mount unit can be used for the bind mount. The name of the mount unit must be equal to the directory mentioned after "Where", replace slashes with minuses. See [<a rel="nofollow" class="external autonumber" href="http://utcc.utoronto.ca/~cks/space/blog/linux/SystemdAndBindMounts">[2]</a>] and [<a rel="nofollow" class="external autonumber" href="http://utcc.utoronto.ca/~cks/space/blog/linux/SystemdBindMountUnits">[3]</a>] for more details.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">srv-nfs4-music.mount</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[Mount]
What=/mnt/zfspool
Where=/srv/nfs4/music
Type=none
Options=bind

[Unit]
DefaultDependencies=no
Conflicts=umount.target
Before=local-fs.target umount.target
After=zfs-mount.service
Requires=zfs-mount.service
ConditionPathIsDirectory=/mnt/zfspool

[Install]
WantedBy=local-fs.target
</pre>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li> <a href="../en/Installing_Arch_Linux_on_ZFS.html" title="Installing Arch Linux on ZFS">Installing Arch Linux on ZFS</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://zfsonlinux.org/">ZFS on Linux</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://github.com/zfsonlinux/zfs/wiki/faq">ZFS on Linux FAQ</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/zfs.html">FreeBSD Handbook -- The Z File System</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://docs.oracle.com/cd/E19253-01/819-5461/index.html">Oracle Solaris ZFS Administration Guide</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.solarisinternals.com/wiki/index.php/ZFS_Troubleshooting_Guide">Solaris Internals -- ZFS Troubleshooting Guide</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://royal.pingdom.com/2013/06/04/zfs-backup/">Pingdom details how it backs up 5TB of MySQL data every day with ZFS</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://www.linuxquestions.org/questions/linux-from-scratch-13/%5Bhow-to%5D-add-zfs-to-the-linux-kernel-4175514510/">Tutorial on adding the modules to a custom kernel</a>
</li>
</ul>
<dl><dt> Aaron Toponce has authored a 17-part blog on ZFS which is an excellent read.</dt></dl>
<ol>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/04/zfs-administration-part-i-vdevs/">VDEVs</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/05/zfs-administration-part-ii-raidz/">RAIDZ Levels</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/06/zfs-administration-part-iii-the-zfs-intent-log/">The ZFS Intent Log</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/07/zfs-administration-part-iv-the-adjustable-replacement-cache/">The ARC</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/10/zfs-administration-part-v-exporting-and-importing-zpools/">Import/export zpools</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/11/zfs-administration-part-vi-scrub-and-resilver/">Scrub and Resilver</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/12/zfs-administration-part-vii-zpool-properties/">Zpool Properties</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/13/zfs-administration-part-viii-zpool-best-practices-and-caveats/">Zpool Best Practices</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/14/zfs-administration-part-ix-copy-on-write/">Copy on Write</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/17/zfs-administration-part-x-creating-filesystems/">Creating Filesystems</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/18/zfs-administration-part-xi-compression-and-deduplication/">Compression and Deduplication</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/19/zfs-administration-part-xii-snapshots-and-clones/">Snapshots and Clones</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/20/zfs-administration-part-xiii-sending-and-receiving-filesystems/">Send/receive Filesystems</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/21/zfs-administration-part-xiv-zvols/">ZVOLs</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2012/12/31/zfs-administration-part-xv-iscsi-nfs-and-samba/">iSCSI, NFS, and Samba</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2013/01/02/zfs-administration-part-xvi-getting-and-setting-properties/">Get/Set Properties</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://pthree.org/2013/01/03/zfs-administration-part-xvii-best-practices-and-caveats/">ZFS Best Practices</a>
</li>
</ol>

</div>
<div id="catlinks" class="catlinks">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_with_broken_section_links.html" title="Category:Pages with broken section links">Pages with broken section links</a></li>
<li><a href="../en/Category:Pages_with_broken_package_links.html" title="Category:Pages with broken package links">Pages with broken package links</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Style.html" title="Category:Pages or sections flagged with Template:Style">Pages or sections flagged with Template:Style</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
</ul>
</div>
</div>					<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
Extracted from <a href="https://wiki.archlinux.org"> ArchWiki </a> and licensed under <a href="http://www.gnu.org/copyleft/fdl.html"> GDL >= 1.3</a>
		</div>
		</div>
		</body>
</html>
