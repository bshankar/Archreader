<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8">
<title>Btrfs - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<style></style>
<meta name="generator" content="MediaWiki 1.26.4">
<meta name="robots" content="noindex,follow">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Btrfs skin-archlinux action-view">

		<div id="globalWrapper" style="width: 100%">
		<div id="column-content">
			<div id="content" class="mw-body" role="main" style="margin: 0.5em; margin-bottom:0; margin-top:0">
				<a id="top"></a>
				
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">Btrfs</h1>
				
				<div id="bodyContent" class="mw-body-content">
					<div id="contentSub"></div>
										<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div style="width:45%; margin: 0 0 0.5em 0.5em;">
<p style="background:#333; color:white; padding:0.2em; border-bottom:5px #08c solid; margin:0; text-align:center; font-weight:bold;">Related articles</p>
<ul style="list-style-type:none; margin:0; padding:0.3em;">
<li style="padding:0.4em 0; line-height:1;"><a href="../en/File_systems.html" title="File systems">File systems</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Mkinitcpio.html" title="Mkinitcpio-btrfs" class="mw-redirect">Mkinitcpio-btrfs</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Snapper.html" title="Snapper">Snapper</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Dm-crypt/Encrypting_an_entire_system.html#Btrfs_subvolumes_with_swap" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Btrfs subvolumes with swap</a></li>
</ul>
</div>
<p>From <a href="https://en.wikipedia.org/wiki/Btrfs" class="extiw" title="wikipedia:Btrfs">Wikipedia:Btrfs</a>:
</p>
<dl><dd>Btrfs (B-tree file system, pronounced as "butter F S", "better F S", "b-tree F S", or simply by spelling it out) is a file system based on the copy-on-write (COW) principle, initially designed at Oracle Corporation for use in Linux. The development of Btrfs began in 2007, and by August 2014, the file system's on-disk format has been marked as stable.</dd></dl>
<p>From <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Main_Page">Btrfs Wiki</a>:
</p>
<dl><dd>Btrfs is a new copy on write (CoW) filesystem for Linux aimed at implementing advanced features while focusing on fault tolerance, repair and easy administration. Jointly developed at Oracle, Red Hat, Fujitsu, Intel, SUSE, STRATO and many others, Btrfs is licensed under the GPL and open for contribution from anyone.</dd></dl>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong> Btrfs has some features that are considered experimental. See the Btrfs Wiki's <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Status">Status</a>, <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/FAQ#Is_btrfs_stable.3F">Is Btrfs stable?</a> and <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Getting_started">Getting started</a> for more detailed information. See the <a href="#Known_issues">#Known issues</a> section.
</div>
<div id="toc" class="toc">
<div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Preparation"><span class="tocnumber">1</span> <span class="toctext">Preparation</span></a></li>
<li class="toclevel-1 tocsection-2"><a href="#Partitionless_Btrfs_disk"><span class="tocnumber">2</span> <span class="toctext">Partitionless Btrfs disk</span></a></li>
<li class="toclevel-1 tocsection-3">
<a href="#File_system_creation"><span class="tocnumber">3</span> <span class="toctext">File system creation</span></a>
<ul>
<li class="toclevel-2 tocsection-4">
<a href="#Creating_a_new_file_system"><span class="tocnumber">3.1</span> <span class="toctext">Creating a new file system</span></a>
<ul>
<li class="toclevel-3 tocsection-5"><a href="#File_system_on_a_single_device"><span class="tocnumber">3.1.1</span> <span class="toctext">File system on a single device</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#Multi-device_file_system"><span class="tocnumber">3.1.2</span> <span class="toctext">Multi-device file system</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-7"><a href="#Ext3.2F4_to_Btrfs_conversion"><span class="tocnumber">3.2</span> <span class="toctext">Ext3/4 to Btrfs conversion</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-8">
<a href="#Configuring_the_file_system"><span class="tocnumber">4</span> <span class="toctext">Configuring the file system</span></a>
<ul>
<li class="toclevel-2 tocsection-9">
<a href="#Copy-On-Write_.28CoW.29"><span class="tocnumber">4.1</span> <span class="toctext">Copy-On-Write (CoW)</span></a>
<ul>
<li class="toclevel-3 tocsection-10"><a href="#Disabling_CoW"><span class="tocnumber">4.1.1</span> <span class="toctext">Disabling CoW</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#Forcing_CoW"><span class="tocnumber">4.1.2</span> <span class="toctext">Forcing CoW</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-12"><a href="#Compression"><span class="tocnumber">4.2</span> <span class="toctext">Compression</span></a></li>
<li class="toclevel-2 tocsection-13">
<a href="#Subvolumes"><span class="tocnumber">4.3</span> <span class="toctext">Subvolumes</span></a>
<ul>
<li class="toclevel-3 tocsection-14"><a href="#Creating_a_subvolume"><span class="tocnumber">4.3.1</span> <span class="toctext">Creating a subvolume</span></a></li>
<li class="toclevel-3 tocsection-15"><a href="#Listing_subvolumes"><span class="tocnumber">4.3.2</span> <span class="toctext">Listing subvolumes</span></a></li>
<li class="toclevel-3 tocsection-16"><a href="#Deleting_a_subvolume"><span class="tocnumber">4.3.3</span> <span class="toctext">Deleting a subvolume</span></a></li>
<li class="toclevel-3 tocsection-17">
<a href="#Mounting_subvolumes"><span class="tocnumber">4.3.4</span> <span class="toctext">Mounting subvolumes</span></a>
<ul>
<li class="toclevel-4 tocsection-18"><a href="#Mount_options"><span class="tocnumber">4.3.4.1</span> <span class="toctext">Mount options</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-19"><a href="#Changing_the_default_sub-volume"><span class="tocnumber">4.3.5</span> <span class="toctext">Changing the default sub-volume</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-20"><a href="#Commit_Interval"><span class="tocnumber">4.4</span> <span class="toctext">Commit Interval</span></a></li>
<li class="toclevel-2 tocsection-21"><a href="#SSD_TRIM"><span class="tocnumber">4.5</span> <span class="toctext">SSD TRIM</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-22">
<a href="#Usage"><span class="tocnumber">5</span> <span class="toctext">Usage</span></a>
<ul>
<li class="toclevel-2 tocsection-23"><a href="#Displaying_used.2Ffree_space"><span class="tocnumber">5.1</span> <span class="toctext">Displaying used/free space</span></a></li>
<li class="toclevel-2 tocsection-24"><a href="#Defragmentation"><span class="tocnumber">5.2</span> <span class="toctext">Defragmentation</span></a></li>
<li class="toclevel-2 tocsection-25">
<a href="#RAID"><span class="tocnumber">5.3</span> <span class="toctext">RAID</span></a>
<ul>
<li class="toclevel-3 tocsection-26">
<a href="#Scrub"><span class="tocnumber">5.3.1</span> <span class="toctext">Scrub</span></a>
<ul>
<li class="toclevel-4 tocsection-27"><a href="#Start_manually"><span class="tocnumber">5.3.1.1</span> <span class="toctext">Start manually</span></a></li>
<li class="toclevel-4 tocsection-28"><a href="#Start_with_a_service_or_timer"><span class="tocnumber">5.3.1.2</span> <span class="toctext">Start with a service or timer</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-29"><a href="#Balance"><span class="tocnumber">5.3.2</span> <span class="toctext">Balance</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-30"><a href="#Snapshots"><span class="tocnumber">5.4</span> <span class="toctext">Snapshots</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Send.2Freceive"><span class="tocnumber">5.5</span> <span class="toctext">Send/receive</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-32">
<a href="#Known_issues"><span class="tocnumber">6</span> <span class="toctext">Known issues</span></a>
<ul>
<li class="toclevel-2 tocsection-33"><a href="#Encryption"><span class="tocnumber">6.1</span> <span class="toctext">Encryption</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Swap_file"><span class="tocnumber">6.2</span> <span class="toctext">Swap file</span></a></li>
<li class="toclevel-2 tocsection-35"><a href="#Linux-rt_kernel"><span class="tocnumber">6.3</span> <span class="toctext">Linux-rt kernel</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-36">
<a href="#Tips_and_tricks"><span class="tocnumber">7</span> <span class="toctext">Tips and tricks</span></a>
<ul>
<li class="toclevel-2 tocsection-37"><a href="#Corruption_recovery"><span class="tocnumber">7.1</span> <span class="toctext">Corruption recovery</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#Booting_into_snapshots_with_GRUB"><span class="tocnumber">7.2</span> <span class="toctext">Booting into snapshots with GRUB</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Use_Btrfs_subvolumes_with_systemd-nspawn"><span class="tocnumber">7.3</span> <span class="toctext">Use Btrfs subvolumes with systemd-nspawn</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-40">
<a href="#Troubleshooting"><span class="tocnumber">8</span> <span class="toctext">Troubleshooting</span></a>
<ul>
<li class="toclevel-2 tocsection-41">
<a href="#GRUB"><span class="tocnumber">8.1</span> <span class="toctext">GRUB</span></a>
<ul>
<li class="toclevel-3 tocsection-42"><a href="#Partition_offset"><span class="tocnumber">8.1.1</span> <span class="toctext">Partition offset</span></a></li>
<li class="toclevel-3 tocsection-43"><a href="#Missing_root"><span class="tocnumber">8.1.2</span> <span class="toctext">Missing root</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-44"><a href="#BTRFS:_open_ctree_failed"><span class="tocnumber">8.2</span> <span class="toctext">BTRFS: open_ctree failed</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="#btrfs_check"><span class="tocnumber">8.3</span> <span class="toctext">btrfs check</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-46"><a href="#See_also"><span class="tocnumber">9</span> <span class="toctext">See also</span></a></li>
</ul>
</div>

<h2><span class="mw-headline" id="Preparation">Preparation</span></h2>
<p>The official kernels <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=linux">linux</a></span> and <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=linux-lts">linux-lts</a></span> include support for Btrfs. If you want to boot from a Btrfs file system, check if your <a href="../en/Boot_loader.html" title="Boot loader" class="mw-redirect">boot loader</a> supports Btrfs.
</p>
<p>User space utilities are available by <a href="../en/Help:Reading.html#Installation_of_packages" title="Installing" class="mw-redirect">installing</a> the <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package.
</p>
<h2><span class="mw-headline" id="Partitionless_Btrfs_disk">Partitionless Btrfs disk</span></h2>
<p>Btrfs can occupy an entire data storage device, replacing the <a href="../en/Partitioning.html#Master_Boot_Record" title="MBR" class="mw-redirect">MBR</a> or <a href="../en/Partitioning.html#GUID_Partition_Table" title="GPT" class="mw-redirect">GPT</a> partitioning schemes, using <a href="#Subvolumes">subvolumes</a> to simulate partitions. However, using a partitionless setup is not required to simply <a href="#Creating_a_new_file_system">create a Btrfs filesystem</a> on an existing <a href="../en/Partitioning.html" title="Partition" class="mw-redirect">partition</a> that was created using another method. There are some limitations to partitionless single disk setups:
</p>
<ul>
<li> Cannot use different <a href="../en/File_systems.html" title="File systems">file systems</a> for different <a href="../en/Fstab.html" title="Fstab">mount points</a>.</li>
<li> Cannot use <a href="../en/Swap.html" title="Swap">swap area</a> as Btrfs does not support <a href="../en/Swap.html#Swap_file" title="Swap">swap files</a> and there is no place to create <a href="../en/Swap.html#Swap_partition" title="Swap">swap partition</a>. This also limits the use of hibernation/resume, which needs a swap area to store the hibernation image.</li>
<li> Cannot use <a href="../en/Unified_Extensible_Firmware_Interface.html" title="UEFI" class="mw-redirect">UEFI</a> to boot.</li>
</ul>
<p>To overwrite the existing partition table with Btrfs, run the following command:
</p>
<pre># mkfs.btrfs /dev/sd<i>X</i>
</pre>
<p>For example, use <code>/dev/sda</code> rather than <code>/dev/sda1</code>. The latter would format an existing partition instead of replacing the entire partitioning scheme.
</p>
<p>Install the <a href="../en/Boot_loader.html" title="Boot loader" class="mw-redirect">boot loader</a> like you would for a data storage device with a <a href="../en/Partitioning.html#Master_Boot_Record" title="Master Boot Record" class="mw-redirect">Master Boot Record</a>. See <a href="../en/Syslinux.html#Manual_install" title="Syslinux">Syslinux#Manual install</a> or  <a href="../en/GRUB.html#Install_to_partition_or_partitionless_disk" title="GRUB">GRUB#Install to partition or partitionless disk</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>GRUB strongly discourages installation to a partitionless disk.</div>
<h2><span class="mw-headline" id="File_system_creation">File system creation</span></h2>
<p>A Btrfs file system can either be newly created or have one converted.
</p>
<h3><span class="mw-headline" id="Creating_a_new_file_system">Creating a new file system</span></h3>
<h4><span class="mw-headline" id="File_system_on_a_single_device">File system on a single device</span></h4>
<p>To format a partition do:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> /dev/<i>partition</i>
</pre>
<p>The Btrfs default blocksize is 16KB. To use a larger blocksize for data/metadata, specify a value for the <code>nodesize</code> via the <code>-n</code> switch as shown in this example using 16KB blocks:
</p>
<pre># mkfs.btrfs -L <i>mylabel</i> -n 16k /dev/<i>partition</i>
</pre>
<h4><span class="mw-headline" id="Multi-device_file_system">Multi-device file system</span></h4>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>
<ul>
<li> As of August 2016, the RAID 5, RAID 6 mode of Btrfs is considered <i>fatally flawed</i>, and shouldn't be used for "anything but testing with throw-away data." <a rel="nofollow" class="external autonumber" href="https://www.mail-archive.com/linux-btrfs@vger.kernel.org/msg55161.html">[1]</a>
</li>
<li> Some <a href="../en/Boot_loader.html" title="Boot loader" class="mw-redirect">boot loaders</a> such as <a href="../en/Syslinux.html" title="Syslinux">Syslinux</a> do not support multi-device file systems.</li>
</ul>
</div>
<p>Multiple devices can be entered to create a RAID. Supported RAID levels include RAID 0, RAID 1, RAID 10, RAID 5 and RAID 6. The RAID levels can be configured separately for data and metadata using the <code>-d</code> and <code>-m</code> options respectively. By default the data is striped (<code>raid0</code>) and the metadata is mirrored (<code>raid1</code>). See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices">Using Btrfs with Multiple Devices</a> for more information about how to create a Btrfs RAID volume as well as the manpage for <code>mkfs.btrfs</code>.
</p>
<pre># mkfs.btrfs -d raid0 -m raid1 /dev/<i>part1</i> /dev/<i>part2</i> ...
</pre>
<p>You <b>must</b> include either the <code>udev</code> hook or the <code>btrfs</code> hook in <code>/etc/mkinitcpio.conf</code> in order to use multiple btrfs devices in a pool. See the <a href="../en/Mkinitcpio.html#Common_hooks" title="Mkinitcpio">Mkinitcpio#Common hooks</a> article for more information.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If the disks in your multi-disk array have different sizes, this may not use the full capacity of all drives. In order to utilize the full capacity of all disks, use <code>-d single</code> instead of <code>-d raid0 -m raid1</code> (metadata mirrored, data not mirrored and not striped)</div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>Mounting such a filesystem may result in all but one of the according <i>.device</i>-jobs getting stuck and systemd never finishing startup due to a <a rel="nofollow" class="external text" href="https://github.com/systemd/systemd/issues/1921">bug</a> in handling this type of filesystem.</div>
<p>See <a href="#RAID">#RAID</a> for advice on maintenance specific to multi-device Btrfs file systems.
</p>
<h3><span class="mw-headline" id="Ext3.2F4_to_Btrfs_conversion">Ext3/4 to Btrfs conversion</span></h3>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong> As of mid-to-late 2015, there are many reports on the btrfs mailing list about incomplete/corrupt/broken conversions. The situation is improving as patches are being submitted, but proceed very carefully. Make sure you have <i>working</i> backups of any data you cannot afford to lose. See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Conversion_from_Ext3">Conversion from Ext3</a> on the btrfs wiki.</div>
<p>Boot from an install CD, then convert by doing:
</p>
<pre># btrfs-convert /dev/<i>partition</i>
</pre>
<p>Mount the partion and test the conversion by checking the files.  Be sure to change the <code>/etc/fstab</code> to reflect the change (<b>type</b> to <code>btrfs</code> and <b>fs_passno</b> [the last field] to <code>0</code> as Btrfs does not do a file system check on boot). Also note that the UUID of the partition will have changed, so update fstab accordingly when using UUIDs. <code>chroot</code> into the system and rebuild the GRUB menu list (see <a href="../en/Install_from_existing_Linux.html" title="Install from existing Linux">Install from existing Linux</a> and <a href="../en/GRUB.html" title="GRUB">GRUB</a> articles). If converting a root filesystem, while still chrooted run <code>mkinitcpio -p linux</code> to regenerate the initramfs or the system will not successfully boot. If you get stuck in grub with 'unknown filesystem' try reinstalling grub with <code>grub-install /dev/<i>partition</i></code> and regenerate the config as well <code>grub-mkconfig -o /boot/grub/grub.cfg</code>.
</p>
<p>After confirming that there are no problems, complete the conversion by deleting the backup <code>ext2_saved</code> sub-volume. Note that you cannot revert back to ext3/4 without it.
</p>
<pre># btrfs subvolume delete /ext2_saved
</pre>
<p>Finally <a href="#Balance">balance</a> the file system to reclaim the space.
</p>
<h2><span class="mw-headline" id="Configuring_the_file_system">Configuring the file system</span></h2>
<h3><span class="mw-headline" id="Copy-On-Write_.28CoW.29">Copy-On-Write (CoW)</span></h3>
<p>By default, Btrfs uses <a href="https://en.wikipedia.org/wiki/copy-on-write" class="extiw" title="wikipedia:copy-on-write">Wikipedia:copy-on-write</a> for all files all the time. See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Copy_on_Write_.28CoW.29">the Btrfs Sysadmin Guide section</a> for implementation details, as well as advantages and disadvantages.
</p>
<h4><span class="mw-headline" id="Disabling_CoW">Disabling CoW</span></h4>
<p>To disable copy-on-write for newly created files in a mounted subvolume, use the <code>nodatacow</code> mount option. This will only affect newly created files. Copy-on-write will still happen for existing files.
</p>
<p>To disable copy-on-write for single files/directories do:
</p>
<pre>$ chattr +C <i>/dir/file</i>
</pre>
<p>This will disable copy-on-write for those operation in which there is only one reference to the file. If there is more than one reference (e.g. through <code>cp --reflink=always</code> or because of a filesystem snapshot), copy-on-write still occurs.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>From chattr man page: "For btrfs, the 'C' flag should be set on new or empty files. If it is set on a file which already has data blocks, it is undefined when the blocks assigned to the file will be fully stable. If the 'C' flag is set on a directory, it will have no effect on the directory, but new files created in that directory will have the No_COW attribute."</div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>In accordance with the note above, you can use the following trick to disable copy-on-write on existing files in a directory:
<pre>$ mv <i>/path/to/dir</i> <i>/path/to/dir</i>_old
$ mkdir <i>/path/to/dir</i>
$ chattr +C <i>/path/to/dir</i>
$ cp -a <i>/path/to/dir</i>_old/* <i>/path/to/dir</i>
$ rm -rf <i>/path/to/dir</i>_old
</pre>
<p>Make sure that the data are not used during this process. Also note that <code>mv</code> or <code>cp --reflink</code> as described below will not work.
</p>
</div>
<h4><span class="mw-headline" id="Forcing_CoW">Forcing CoW</span></h4>
<p>To force copy-on-write when copying files use:
</p>
<pre>$ cp --reflink <i>source</i> <i>dest</i> 
</pre>
<p>This would only be required if CoW was disabled for the file to be copied (as implemented above). See the man page on <code>cp</code> for more details on the <code>--reflink</code> flag.
</p>
<h3><span class="mw-headline" id="Compression">Compression</span></h3>
<p>Btrfs supports transparent compression, meaning every file on the partition is automatically compressed. This not only reduces the size of files, but also <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=btrfs_compress_2635&amp;num=1">improves performance</a>, in particular if using the <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=btrfs_lzo_2638&amp;num=1">lzo algorithm</a>, in some specific use cases (e.g. single thread with heavy file IO), while obviously harming performance on other cases (e.g. multithreaded and/or cpu intensive tasks with large file IO).
</p>
<p>Compression is enabled using the <code>compress=zlib</code> or <code>compress=lzo</code> mount options. Only files created or modified after the mount option is added will be compressed. However, it can be applied quite easily to existing files (e.g. after a conversion from ext3/4) using the <code>btrfs filesystem defragment -c<i>alg</i></code> command, where <code><i>alg</i></code> is either <code>zlib</code> or <code>lzo</code>. In order to re-compress the whole file system with <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=lzo">lzo</a></span>, run the following command:
</p>
<pre># btrfs filesystem defragment -r -v -clzo /
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Compression can also be enabled per-file without using the <code>compress</code> mount option; simply apply <code>chattr +c</code> to the file. When applied to directories, it will cause new files to be automatically compressed as they come.</div>
<p>When installing Arch to an empty Btrfs partition, use the <code>compress</code> option when <a href="../en/File_systems.html#Mount_a_file_system" title="Mount" class="mw-redirect">mounting</a> the file system: <code>mount -o compress=lzo /dev/sd<i>xY</i> /mnt/</code>. During configuration, add <code>compress=lzo</code> to the mount options of the root file system in <a href="../en/Fstab.html" title="Fstab">fstab</a>.
</p>
<h3><span class="mw-headline" id="Subvolumes">Subvolumes</span></h3>
<p>"A btrfs subvolume is not a block device (and cannot be treated as one) instead, a btrfs subvolume can be thought of as a POSIX file namespace. This namespace can be accessed via the top-level subvolume of the filesystem, or it can be mounted in its own right." <a rel="nofollow" class="external autonumber" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">[2]</a>
</p>
<p>Each Btrfs file system has a top-level subvolume with ID 5. It can be mounted as <code>/</code> (by default), or another subvolume can be <a href="#Mounting_subvolumes">mounted</a> instead.
</p>
<p>See the following links for more details:
</p>
<ul>
<li> <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Subvolumes">Btrfs Wiki SysadminGuide#Subvolumes</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Getting_started#Basic_Filesystem_Commands">Btrfs Wiki Getting started#Basic Filesystem Commands</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Trees">Btrfs Wiki Trees</a> </li>
</ul>
<h4><span class="mw-headline" id="Creating_a_subvolume">Creating a subvolume</span></h4>
<p>To create a subvolume:
</p>
<pre># btrfs subvolume create <i>/path/to/subvolume</i>
</pre>
<h4><span class="mw-headline" id="Listing_subvolumes">Listing subvolumes</span></h4>
<p>To see a list of current subvolumes under <code><i>path</i></code>:
</p>
<pre># btrfs subvolume list -p <i>path</i>
</pre>
<h4><span class="mw-headline" id="Deleting_a_subvolume">Deleting a subvolume</span></h4>
<p>To delete a subvolume:
</p>
<pre># btrfs subvolume delete <i>/path/to/subvolume</i>
</pre>
<p>Attempting to remove the directory <code><i>/path/to/subvolume</i></code> without using the above command will not delete the subvolume.
</p>
<h4><span class="mw-headline" id="Mounting_subvolumes">Mounting subvolumes</span></h4>
<p>Subvolumes can be mounted like file system partitions using the <code>subvol=<i>/path/to/subvolume</i></code> or <code>subvolid=<i>objectid</i></code> mount flags. For example, you could have a subvolume named <code>subvol_root</code> and mount it as <code>/</code>.  One can mimic traditional file system partitions by creating various subvolumes under the top level of the file system and then mounting them at the appropriate mount points. Thus one can easily restore a file system (or part of it) to a previous state easily using <a href="#Snapshots">#Snapshots</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDFFDD; border: thin solid #BBDDBB; overflow: hidden;">
<strong> Tip: </strong>Changing subvolume layouts is made simpler by not using the toplevel subvolume (ID=5) as <code>/</code> (which is done by default). Instead, consider creating a subvolume to house your actual data and mounting it as <code>/</code>.</div>
<p>See <a href="../en/Snapper.html#Suggested_filesystem_layout" title="Snapper">Snapper#Suggested filesystem layout</a>, <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Managing_Snapshots">Btrfs SysadminGuide#Managing Snapshots</a>, and <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Layout">Btrfs SysadminGuide#Layout</a> for example file system layouts using subvolumes.
</p>
<h5><span class="mw-headline" id="Mount_options">Mount options</span></h5>
<p>When mounting subvolumes with <code>subvol=</code> several mount options are available. For example, mount options that affect <a href="#Compression">#Compression</a> or <a href="#Copy-On-Write_.28CoW.29">#Copy-On-Write (CoW)</a> can be used.
</p>
<p>See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Mount_options">Btrfs Wiki Mount options</a> and <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Gotchas">Btrfs Wiki Gotchas</a> for more information. In addition to configurations that can be made during or after file system creation, the various mount options for Btrfs can drastically change its performance characteristics. As this is a file system that is still in active development, changes and regressions should be expected. See links in the <a href="#See_also">#See also</a> section for some benchmarks.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>Specific mount options can disable safety features and increase the risk of complete file system corruption.</div>
<h4><span class="mw-headline" id="Changing_the_default_sub-volume">Changing the default sub-volume</span></h4>
<p>The default sub-volume is mounted if no <code>subvol=</code> mount option is provided. To change the default subvolume, do:
</p>
<pre># btrfs subvolume set-default <i>subvolume-id</i> /
</pre>
<p>where <i>subvolume-id</i> can be found by <a href="#Listing_subvolumes">listing</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>After changing the default subvolume on a system with <a href="../en/GRUB.html" title="GRUB">GRUB</a>, you should run <code>grub-install</code> again to notify the bootloader of the changes. See <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?pid=1615373">this forum thread</a>.</div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>Changing the default subvolume with <code>btrfs subvolume set-default</code> will make the top level of the filesystem inaccessible when the default subvolume is mounted . Reference: <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide">Btrfs Wiki Sysadmin Guide</a>.</div>
<h3><span class="mw-headline" id="Commit_Interval">Commit Interval</span></h3>
<p>The resolution at which data are written to the filesystem is dictated by Btrfs itself and by system-wide settings. Btrfs defaults to a 30 seconds checkpoint interval in which new data are committed to the filesystem. This can be changed by appending the <code>commit</code> mount option in <code>/etc/fstab</code> for the btrfs partition.
</p>
<pre>LABEL=arch64 / btrfs defaults,noatime,ssd,compress=lzo,commit=120 0 0
</pre>
<p>System-wide settings also affect commit intervals. They include the files under <code>/proc/sys/vm/*</code> and are out-of-scope of this wiki article. The kernel documentation for them resides in <code>Documentation/sysctl/vm.txt</code>.
</p>
<h3><span class="mw-headline" id="SSD_TRIM">SSD TRIM</span></h3>
<p>A Btrfs filesystem will automatically free unused blocks from an SSD drive supporting the TRIM command.
</p>
<p>More information about enabling and using TRIM can be found in <a href="../en/Solid_State_Drives.html#TRIM" title="Solid State Drives">Solid State Drives#TRIM</a>.
</p>
<h2><span class="mw-headline" id="Usage">Usage</span></h2>
<h3><span class="mw-headline" id="Displaying_used.2Ffree_space">Displaying used/free space</span></h3>
<p>General linux userspace tools such as <code>/usr/bin/df</code> will inaccurately report free space on a Btrfs partition since it does not take into account space allocated for and used by the metadata. It is recommended to use <code>/usr/bin/btrfs</code> to query a Btrfs partition. Below is an illustration of this effect, first querying using <code>df -h</code>, and then using <code>btrfs filesystem df</code>:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ df -h /</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda3       119G  3.0G  116G   3% /
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">$ btrfs filesystem df /</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">Data: total=3.01GB, used=2.73GB
System: total=4.00MB, used=16.00KB
Metadata: total=1.01GB, used=181.83MB</pre>
<p>Notice that <code>df -h</code> reports 3.0GB used but <code>btrfs filesystem df</code> reports 2.73GB for the data. This is due to the way Btrfs allocates space into the pool. The true disk usage is the sum of all three 'used' values which is inferior to 3.0GB as reported by <code>df -h</code>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If you see an entry of type <code>unknown</code> in the output of <code>btrfs filesystem df</code> at kernel &gt;= 3.15, this is a display bug. As of <a rel="nofollow" class="external text" href="http://thread.gmane.org/gmane.comp.file-systems.btrfs/34419">this patch</a>, the entry means GlobalReserve, which is kind of a buffer for changes not yet flushed. This entry is displayed as <code>unknown, single</code> in RAID setups and is not possible to re-balance.</div>
<p>Another useful command to show a less verbose readout of used space is <code>btrfs filesystem show</code>:
</p>
<pre># btrfs filesystem show /dev/sda3
</pre>
<p>The newest command to get information on free/used space of a is <code>btrfs filesystem usage</code>:
</p>
<pre># btrfs filesystem usage
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>The <code>btrfs filesystem usage</code> command does not currently work correctly with <code>RAID5/RAID6</code> RAID levels.</div>
<h3><span class="mw-headline" id="Defragmentation">Defragmentation</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" width="48" height="48"></a><b>This article or section needs expansion.</b><a href="../File:Tango-view-fullscreen.png" class="image"><img alt="Tango-view-fullscreen.png" src="../File:Tango-view-fullscreen.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> Caveat from <a rel="nofollow" class="external autonumber" href="https://btrfs.wiki.kernel.org/index.php/UseCases#How_do_I_defragment_many_files.3F">[3]</a> plus the solution. (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Btrfs">Talk:Btrfs#</a>)</div>
</div>
<p>Btrfs supports online defragmentation. To defragment the metadata of the root folder:
</p>
<pre># btrfs filesystem defragment /
</pre>
<p>This <i>will not</i> defragment the entire file system. For more information read <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Problem_FAQ#Defragmenting_a_directory_doesn.27t_work">this page</a> on the Btrfs wiki.
</p>
<p>To defragment the entire file system verbosely:
</p>
<pre># btrfs filesystem defragment -r -v /
</pre>
<h3><span class="mw-headline" id="RAID">RAID</span></h3>
<p>Btrfs offers native "RAID" for <a href="#Multi-device_file_system">#Multi-device file systems</a>. Notable features which set btrfs RAID apart from <a href="../en/RAID.html" title="Mdadm" class="mw-redirect">mdadm</a> are self-healing redundant arrays and online balancing. See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Using_Btrfs_with_Multiple_Devices">the Btrfs wiki page</a> for more information. The Btrfs sysadmin page also <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#RAID_and_data_replication">has a section</a> with some more technical background.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong> Parity RAID (RAID 5/6) code has multiple serious data-loss bugs in it. See the Btrfs Wiki's <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/RAID56">RAID5/6 page</a> and a bug report on <a rel="nofollow" class="external text" href="https://www.mail-archive.com/linux-btrfs@vger.kernel.org/msg55161.html">linux-btrfs mailing list</a> for more detailed information.</div>
<h4><span class="mw-headline" id="Scrub">Scrub</span></h4>
<p>The <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Glossary">Btrfs Wiki Glossary</a> says that Btrfs scrub is "[a]n online filesystem checking tool. Reads all the data and metadata on the filesystem, and uses checksums and the duplicate copies from RAID storage to identify and repair any corrupt data."
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>A running scrub process will prevent the system from suspending, see <a rel="nofollow" class="external text" href="http://comments.gmane.org/gmane.comp.file-systems.btrfs/33106">this thread</a> for details.</div>
<h5><span class="mw-headline" id="Start_manually">Start manually</span></h5>
<p>To start a scrub for the subvolume mounted at root do:
</p>
<pre># btrfs scrub start /
</pre>
<p>To check the status of the scrub do:
</p>
<pre># btrfs scrub status /
</pre>
<h5><span class="mw-headline" id="Start_with_a_service_or_timer">Start with a service or timer</span></h5>
<p>The <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=btrfs-progs">btrfs-progs</a></span> package brings the <code>btrfs-scrub@.timer</code> unit for monthly scrubbing the specified mountpoint. <a href="../en/Systemd.html#Using_units" title="Enable" class="mw-redirect">Enable</a> the timer with an escaped path, e.g. <code>btrfs-scrub@-.timer</code> for <code>/</code> and <code>btrfs-scrub@home.timer</code> for <code>/home</code>. You can use the <i>systemd-escape</i> tool to escape a given string, see <code>systemd-escape(1)</code> for examples.
</p>
<p>You can also run the scrub by <a href="../en/Systemd.html#Using_units" title="Starting" class="mw-redirect">starting</a> <code>btrfs-scrub@.service</code> (with the same encoded path). The advantage of this over <code># btrfs scrub</code> is that the results of the scrub will be logged in the <a href="../en/Systemd.html#Journal" title="Systemd journal" class="mw-redirect">systemd journal</a>.
</p>
<h4><span class="mw-headline" id="Balance">Balance</span></h4>
<p>"A balance passes all data in the filesystem through the allocator again. It is primarily intended to rebalance the data in the filesystem across the devices when a device is added or removed. A balance will regenerate missing copies for the redundant RAID levels, if a device has failed." <a rel="nofollow" class="external autonumber" href="https://btrfs.wiki.kernel.org/index.php/Glossary">[4]</a> See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/FAQ#What_does_.22balance.22_do.3F">Upstream FAQ page</a>.
</p>
<pre># btrfs balance start /
# btrfs balance status /
</pre>
<h3><span class="mw-headline" id="Snapshots">Snapshots</span></h3>
<p>"A snapshot is simply a subvolume that shares its data (and metadata) with some other subvolume, using btrfs's COW capabilities." See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/SysadminGuide#Snapshots">Btrfs Wiki SysadminGuide#Snapshots</a> for details.
</p>
<p>To create a snapshot:
</p>
<pre># btrfs subvolume snapshot <i>source</i> [<i>dest</i>/]<i>name</i>
</pre>
<p>To create a readonly snapshot add the <code>-r</code> flag. To create writable version of a readonly snapshot, simply create a snapshot of it.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>Snapshots are not recursive. Every sub-volume inside sub-volume will be an empty directory inside the snapshot.</div>
<h3><span class="mw-headline" id="Send.2Freceive">Send/receive</span></h3>
<p>A subvolume can be sent to stdout or a file using the <code>send</code> command. This is usually most useful when piped to a Btrfs <code>receive</code> command. For example, to send a snapshot named <code>/root_backup</code> (perhaps of a snapshot you made of <code>/</code> earlier) to <code>/backup</code> you would do the following:
</p>
<pre> # btrfs send /root_backup | btrfs receive /backup
</pre>
<p>The snapshot that is sent <i>must</i> be readonly. The above command is useful for copying a subvolume to an external device (<i>e.g.</i>, a USB disk mounted at <code>/backup</code> above).
</p>
<p>You can also send only the difference between two snapshots. For example, if you have already sent a copy of <code>root_backup</code> above and have made a new readonly snapshot on your system named <code>root_backup_new</code>, then to send only the incremental difference to <code>/backup</code> do:
</p>
<pre> # btrfs send -p /root_backup /root_backup_new | btrfs receive /backup
</pre>
<p>Now a new subvolume named <code>root_backup_new</code> will be present in <code>/backup</code>.
</p>
<p>See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Incremental_Backup">Btrfs Wiki's Incremental Backup page</a> on how to use this for an incremental backup and for tools that automate the process.
</p>
<h2><span class="mw-headline" id="Known_issues">Known issues</span></h2>
<p>A few limitations should be known before trying.
</p>
<h3><span class="mw-headline" id="Encryption">Encryption</span></h3>
<p>Btrfs has no built-in encryption support, but this may come in future. Users can encrypt the partition before running <code>mkfs.btrfs</code>. See <a href="../en/Dm-crypt/Encrypting_an_entire_system.html#Btrfs_subvolumes_with_swap" title="Dm-crypt/Encrypting an entire system">dm-crypt/Encrypting an entire system#Btrfs subvolumes with swap</a>. 
</p>
<p>Existing Btrfs file systems can use something like <a href="../en/EncFS.html" title="EncFS">EncFS</a> or <a href="../en/TrueCrypt.html" title="TrueCrypt">TrueCrypt</a>, though perhaps without some of Btrfs' features.
</p>
<h3><span class="mw-headline" id="Swap_file">Swap file</span></h3>
<p>Btrfs does not yet support <a href="../en/Swap.html#Swap_file" title="Swap">swap files</a>. This is due to swap files requiring a function that Btrfs does not have for possibility of file system corruption <a rel="nofollow" class="external autonumber" href="https://btrfs.wiki.kernel.org/index.php/FAQ#Does_btrfs_support_swap_files.3F">[5]</a>. Patches for swapfile support are already available <a rel="nofollow" class="external autonumber" href="https://lkml.org/lkml/2014/12/9/718">[6]</a> and may be included in an upcoming kernel release. As an alternative a swap file can be mounted on a loop device with poorer performance but will not be able to hibernate. Install the package <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=systemd-swap">systemd-swap</a></span> to automate this.
</p>
<h3><span class="mw-headline" id="Linux-rt_kernel">Linux-rt kernel</span></h3>
<div class="noprint archwiki-template-message">
<p><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" width="48" height="48"></a><b>This article or section is out of date.</b><a href="../File:Tango-view-refresh-red.png" class="image"><img alt="Tango-view-refresh-red.png" src="../File:Tango-view-refresh-red.png" width="48" height="48"></a></p>
<div>
<b>Reason:</b> We're on 4.6.4. Is this still an issue? (Discuss in <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php/Talk:Btrfs">Talk:Btrfs#</a>)</div>
</div>
<p>As of version 3.14.12_rt9, the <a href="../en/Kernels.html#-rt" title="Kernel" class="mw-redirect">linux-rt</a> kernel does not boot with the Btrfs file system. This is due to the slow development of the <i>rt</i> patchset.
</p>
<h2><span class="mw-headline" id="Tips_and_tricks">Tips and tricks</span></h2>
<h3><span class="mw-headline" id="Corruption_recovery">Corruption recovery</span></h3>
<p><i>btrfs-check</i> cannot be used on a mounted file system. To be able to use <i>btrfs-check</i> without booting from a live USB, add it to the initial ramdisk:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/mkinitcpio.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">BINARIES="/usr/bin/btrfs"</pre>
<p>Regenerate the initial ramdisk using <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a>.
</p>
<p>Then if there is a problem booting, the utility is available for repair.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If the fsck process has to invalidate the space cache (and/or other caches?) then it is normal for a subsequent boot to hang up for a while (it may give console messages about btrfs-transaction being hung). The system should recover from this after a while.</div>
<p>See the <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Btrfsck">Btrfs Wiki page</a> for more information.
</p>
<h3><span class="mw-headline" id="Booting_into_snapshots_with_GRUB">Booting into snapshots with GRUB</span></h3>
<p>You can manually create a <a href="../en/GRUB.html#GNU.2FLinux_menu_entry" title="GRUB">GRUB#GNU/Linux menu entry</a> with the <code>rootflags=subvol=</code> argument. The <code>subvol=</code> mount options in <code>/etc/fstab</code> of the snapshot to boot into also have to be specified correctly. 
</p>
<p>Alternatively, you can automatically populate your GRUB menu with btrfs snapshots when regenerating the GRUB configuration file by using <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/grub-btrfs/">grub-btrfs</a></span><sup><small>AUR</small></sup> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://aur.archlinux.org/packages/grub-btrfs-git/">grub-btrfs-git</a></span><sup><small>AUR</small></sup>.
</p>
<h3><span class="mw-headline" id="Use_Btrfs_subvolumes_with_systemd-nspawn">Use Btrfs subvolumes with systemd-nspawn</span></h3>
<p>See the <a href="../en/Systemd-nspawn.html#Use_Btrfs_subvolume_as_container_root" title="Systemd-nspawn">Systemd-nspawn#Use Btrfs subvolume as container root</a> and <a href="../en/Systemd-nspawn.html#Use_temporary_Btrfs_snapshot_of_container" title="Systemd-nspawn">Systemd-nspawn#Use temporary Btrfs snapshot of container</a> articles.
</p>
<h2><span class="mw-headline" id="Troubleshooting">Troubleshooting</span></h2>
<p>See the <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Problem_FAQ">Btrfs Problem FAQ</a> for general troubleshooting.
</p>
<h3><span class="mw-headline" id="GRUB">GRUB</span></h3>
<h4><span class="mw-headline" id="Partition_offset">Partition offset</span></h4>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>The offset problem may happen when you try to embed <code>core.img</code> into a partitioned disk. It means that <a rel="nofollow" class="external text" href="https://wiki.archlinux.org/index.php?title=Talk:Btrfs&amp;diff=319474&amp;oldid=292530">it is OK</a> to embed grub's <code>core.img</code> into a Btrfs pool on a partitionless disk (e.g. <code>/dev/sd<i>X</i></code>) directly.</div>
<p><a href="../en/GRUB.html" title="GRUB">GRUB</a> can boot Btrfs partitions however the module may be larger than other <a href="../en/File_systems.html" title="File systems">file systems</a>. And the <code>core.img</code> file made by <code>grub-install</code> may not fit in the first 63 sectors (31.5KiB) of the drive between the MBR and the first partition. Up-to-date partitioning tools such as <code>fdisk</code> and <code>gdisk</code> avoid this issue by offsetting the first partition by roughly 1MiB or 2MiB.
</p>
<h4><span class="mw-headline" id="Missing_root">Missing root</span></h4>
<p>Users experiencing the following: <code>error no such device: root</code> when booting from a RAID style setup then edit /usr/share/grub/grub-mkconfig_lib and remove both quotes from the line <code>echo "  search --no-floppy --fs-uuid --set=root ${hints} ${fs_uuid}"</code>. Regenerate the config for grub and the system should boot without an error.
</p>
<h3><span class="mw-headline" id="BTRFS:_open_ctree_failed">BTRFS: open_ctree failed</span></h3>
<p>As of November 2014 there seems to be a bug in <a href="../en/Systemd.html" title="Systemd">systemd</a> or <a href="../en/Mkinitcpio.html" title="Mkinitcpio">mkinitcpio</a> causing the following error on systems with multi-device Btrfs filesystem using the <code>btrfs</code> hook in <code>mkinitcpio.conf</code>:
</p>
<pre>
BTRFS: open_ctree failed
mount: wrong fs type, bad option, bad superblock on /dev/sdb2, missing codepage or helper program, or other error

In some cases useful info is found in syslog - try dmesg|tail or so.

You are now being dropped into an emergency shell.
</pre>
<p>A workaround is to remove <code>btrfs</code> from the <code>HOOKS</code> array in <code>/etc/mkinitcpio.conf</code> and instead add <code>btrfs</code> to the <code>MODULES</code> array. Then regenerate the initramfs with <code>mkinitcpio -p linux</code> (adjust the preset if needed) and reboot.
</p>
<p>See the <a rel="nofollow" class="external text" href="https://bbs.archlinux.org/viewtopic.php?id=189845">original forums thread</a> and <a rel="nofollow" class="external text" href="https://bugs.archlinux.org/task/42884">FS#42884</a> for further information and discussion.
</p>
<p>You will get the same error if you try to mount a raid array without one of the devices. In that case you must add the <code>degraded</code> mount option to <code>/etc/fstab</code>. If your root resides on the array, you must also add <code>rootflags=degraded</code> to your <a href="../en/Kernel_parameters.html" title="Kernel parameters">kernel parameters</a>.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>As of August 2016, a potential workaround for this bug is to mount the array by a single drive only in <code>/etc/fstab</code>, and allow btrfs to discover and append the other drives automatically. Group-based identifiers such as UUID and LABEL appear to contribute to the failure. For example, a two-device RAID1 array consisting of 'disk1' and disk2' will have a UUID allocated to it, but instead of using the UUID, use only <code>/dev/mapper/disk1</code> in <code>/etc/fstab</code>.
<p>For a more detailed explanation, see the following <a rel="nofollow" class="external text" href="https://blog.samcater.com/fix-for-btrfs-open_ctree-failed-when-running-root-fs-on-raid-1-or-raid10-arch-linux/">blog post.</a>
</p>
</div>
<h3><span class="mw-headline" id="btrfs_check">btrfs check</span></h3>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>Since Btrfs is under heavy development, especially the <code>btrfs check</code> command, it is highly recommended to create a <b>backup</b> and consult the following Btfrs documentation before executing <code>btrfs check</code> with the <code>--repair</code> switch.</div>
<p>The <i><a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Manpage/btrfs-check">btrfs check</a></i> command can be used to check or repair an unmounted Btrfs filesystem. However, this repair tool is still immature and not able to repair certain filesystem errors even those that do not render the filesystem unmountable.
</p>
<p>See <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/Btrfsck">Btrfsck</a> for more information.
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li> <b>Official site</b>
<ul><li> <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/">Btrfs Wiki</a>
</li></ul>
</li>
<li> <b>Performance related</b>
<ul>
<li> <a rel="nofollow" class="external text" href="http://superuser.com/questions/432188/should-i-put-my-multi-device-btrfs-filesystem-on-disk-partitions-or-raw-devices">Btrfs on raw disks?</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://comments.gmane.org/gmane.comp.file-systems.btrfs/19440">Varying leafsize and nodesize in Btrfs</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://comments.gmane.org/gmane.comp.file-systems.btrfs/15646">Btrfs support for efficient SSD operation (data blocks alignment)</a>
</li>
<li> <a rel="nofollow" class="external text" href="https://btrfs.wiki.kernel.org/index.php/FAQ#Is_Btrfs_optimized_for_SSD.3F">Is Btrfs optimized for SSDs?</a>
</li>
<li> <b>Phoronix mount option benchmarking</b>
<ul>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=linux_314_btrfs">Linux 3.14</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=linux_btrfs_311&amp;num=1">Linux 3.11</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=news_item&amp;px=MTM0OTU">Linux 3.9</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=btrfs_linux37_mounts&amp;num=1">Linux 3.7</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=article&amp;item=linux_btrfs_options&amp;num=1">Linux 3.2</a>
</li>
</ul>
</li>
<li> <a rel="nofollow" class="external text" href="http://blog.erdemagaoglu.com/post/4605524309/lzo-vs-snappy-vs-lzf-vs-zlib-a-comparison-of">Lzo vs. zLib</a>
</li>
</ul>
</li>
<li> <b>Miscellaneous</b>
<ul>
<li> <a rel="nofollow" class="external text" href="http://www.funtoo.org/wiki/BTRFS_Fun">Funtoo Wiki Btrfs Fun</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=news_item&amp;px=MTA0ODU">Avi Miller presenting Btrfs</a> at SCALE 10x, January 2012.</li>
<li> <a rel="nofollow" class="external text" href="http://www.phoronix.com/scan.php?page=news_item&amp;px=MTA4Mzc">Summary of Chris Mason's talk</a> from LFCS 2012</li>
<li> <a rel="nofollow" class="external text" href="http://git.kernel.org/?p=linux/kernel/git/torvalds/linux-2.6.git;a=commit;h=35054394c4b3cecd52577c2662c84da1f3e73525">Btrfs: stop providing a bmap operation to avoid swapfile corruptions</a> 2009-01-21</li>
<li> <a rel="nofollow" class="external text" href="http://marc.merlins.org/perso/btrfs/post_2014-03-22_Btrfs-Tips_-Doing-Fast-Incremental-Backups-With-Btrfs-Send-and-Receive.html">Doing Fast Incremental Backups With Btrfs Send and Receive</a>
</li>
</ul>
</li>
</ul>

</div>
<div id="catlinks" class="catlinks">
<div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:File_systems.html" title="Category:File systems">File systems</a></li></ul>
</div>
<div id="mw-hidden-catlinks" class="mw-hidden-catlinks mw-hidden-cats-hidden">Hidden categories: <ul>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Expansion.html" title="Category:Pages or sections flagged with Template:Expansion">Pages or sections flagged with Template:Expansion</a></li>
<li><a href="../en/Category:Pages_or_sections_flagged_with_Template:Out_of_date.html" title="Category:Pages or sections flagged with Template:Out of date">Pages or sections flagged with Template:Out of date</a></li>
</ul>
</div>
</div>					<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
Extracted from <a href="https://wiki.archlinux.org"> ArchWiki </a> and licensed under <a href="http://www.gnu.org/copyleft/fdl.html"> GDL >= 1.3</a>
		</div>
		</div>
		</body>
</html>
