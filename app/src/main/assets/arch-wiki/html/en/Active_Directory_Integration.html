<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">
<head>
<meta charset="UTF-8">
<title>Active Directory Integration - ArchWiki</title>
<link rel="stylesheet" href="../ArchWikiOffline.css">
<meta name="ResourceLoaderDynamicStyles" content="">
<style></style>
<meta name="generator" content="MediaWiki 1.26.4">
<meta name="robots" content="noindex,follow">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="search" type="application/opensearchdescription+xml" href="/opensearch_desc.php" title="ArchWiki (en)">
<link rel="EditURI" type="application/rsd+xml" href="https://wiki.archlinux.org/api.php?action=rsd">
<link rel="copyright" href="http://www.gnu.org/copyleft/fdl.html">
<link rel="alternate" type="application/atom+xml" title="ArchWiki Atom feed" href="/index.php?title=Special:RecentChanges&amp;feed=atom">
</head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Active_Directory_Integration skin-archlinux action-view">

		<div id="globalWrapper" style="width: 100%">
		<div id="column-content">
			<div id="content" class="mw-body" role="main" style="margin: 0.5em; margin-bottom:0; margin-top:0">
				<a id="top"></a>
				
				<div class="mw-indicators">
</div>
				<h1 id="firstHeading" class="firstHeading" lang="en">Active Directory Integration</h1>
				
				<div id="bodyContent" class="mw-body-content">
					<div id="contentSub"></div>
										<div id="mw-content-text" lang="en" dir="ltr" class="mw-content-ltr">
<div style="width:45%; margin: 0 0 0.5em 0.5em;">
<p style="background:#333; color:white; padding:0.2em; border-bottom:5px #08c solid; margin:0; text-align:center; font-weight:bold;">Related articles</p>
<ul style="list-style-type:none; margin:0; padding:0.3em;">
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Samba.html" title="Samba">Samba</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/Samba/Active_Directory_domain_controller.html" title="Samba/Active Directory domain controller">Samba/Active Directory domain controller</a></li>
<li style="padding:0.4em 0; line-height:1;"><a href="../en/SOGo.html" title="SOGo">SOGo</a></li>
</ul>
</div>
<div style="padding: 5px; margin: 0.50em 0; background-color: #FFDDDD; border: thin solid #DDBBBB; overflow: hidden;">
<strong> Warning: </strong>Because Arch Linux is a rolling release distribution, it is possible that some of the information in this article could be outdated due to package or configuration changes made by the maintainers. Never blindly follow these or any other instructions. When the instructions say to edit or change a file, consider making a backup copy. Check the date of the last revision of this article.</div>
<p>A key challenge for system administrators of any datacenter is trying to coexisting in Heterogeneous environments. By this we mean the mixing of different server operating system technologies (typically Microsoft Windows &amp; Unix/Linux). User management and authentication is by far the most difficult of these to solve. The most common way of solving this problem is to use a Directory Server. There are a number of open-source and commercial solutions for the various flavors of *NIX; however, few solve the problem of interoperating with Windows. Active Directory (AD) is a directory service created by Microsoft for Windows domain networks. It is included in most Windows Server operating systems. Server computers on which Active Directory is running are called domain controllers. 
</p>
<p><a href="https://en.wikipedia.org/wiki/Active_Directory" class="extiw" title="wikipedia:Active Directory">Active Directory</a> serves as a central location for network administration and security. It is responsible for authenticating and authorizing all users and computers within a network of Windows domain type, assigning and enforcing security policies for all computers in a network and installing or updating software on network computers. For example, when a user logs into a computer that is part of a Windows domain, it is Active Directory that verifies his or her password and specifies whether he or she is a system administrator or normal user.
</p>
<p>Active Directory uses <a href="https://en.wikipedia.org/wiki/Ldap" class="extiw" title="wikipedia:Ldap">Lightweight Directory Access Protocol (LDAP)</a> versions 2 and 3, <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)" class="extiw" title="wikipedia:Kerberos (protocol)">Kerberos</a> and DNS. These same standards are available as linux, but piecing them together is not an easy task. Following these steps will help you configure an ArchLinux host to authenticate against an AD domain.
</p>
<p>This guide explains how to integrate an Arch Linux host with an existing Windows Active Directory domain. 
Before continuing, you must have an existing Active Directory domain, and have a user with the appropriate rights within the domain to: query users and add computer accounts (Domain Join). 
</p>
<p>This document is not an intended as a complete guide to Active Directory nor Samba. Refer to the resources section for additional information.
</p>
<div id="toc" class="toc">
<div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Terminology"><span class="tocnumber">1</span> <span class="toctext">Terminology</span></a></li>
<li class="toclevel-1 tocsection-2">
<a href="#Configuration"><span class="tocnumber">2</span> <span class="toctext">Configuration</span></a>
<ul>
<li class="toclevel-2 tocsection-3">
<a href="#Active_Directory_Configuration"><span class="tocnumber">2.1</span> <span class="toctext">Active Directory Configuration</span></a>
<ul>
<li class="toclevel-3 tocsection-4"><a href="#Updating_the_GPO"><span class="tocnumber">2.1.1</span> <span class="toctext">Updating the GPO</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-5"><a href="#Linux_Host_Configuration"><span class="tocnumber">2.2</span> <span class="toctext">Linux Host Configuration</span></a></li>
<li class="toclevel-2 tocsection-6"><a href="#Installation"><span class="tocnumber">2.3</span> <span class="toctext">Installation</span></a></li>
<li class="toclevel-2 tocsection-7"><a href="#Updating_DNS"><span class="tocnumber">2.4</span> <span class="toctext">Updating DNS</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Configuring_NTP"><span class="tocnumber">2.5</span> <span class="toctext">Configuring NTP</span></a></li>
<li class="toclevel-2 tocsection-9">
<a href="#Kerberos"><span class="tocnumber">2.6</span> <span class="toctext">Kerberos</span></a>
<ul>
<li class="toclevel-3 tocsection-10"><a href="#Creating_a_Kerberos_Ticket"><span class="tocnumber">2.6.1</span> <span class="toctext">Creating a Kerberos Ticket</span></a></li>
<li class="toclevel-3 tocsection-11"><a href="#Validating_the_Ticket"><span class="tocnumber">2.6.2</span> <span class="toctext">Validating the Ticket</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-12"><a href="#pam_winbind.conf"><span class="tocnumber">2.7</span> <span class="toctext">pam_winbind.conf</span></a></li>
<li class="toclevel-2 tocsection-13"><a href="#Samba"><span class="tocnumber">2.8</span> <span class="toctext">Samba</span></a></li>
<li class="toclevel-2 tocsection-14"><a href="#Join_the_Domain"><span class="tocnumber">2.9</span> <span class="toctext">Join the Domain</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-15">
<a href="#Starting_and_testing_services"><span class="tocnumber">3</span> <span class="toctext">Starting and testing services</span></a>
<ul>
<li class="toclevel-2 tocsection-16"><a href="#Starting_Samba"><span class="tocnumber">3.1</span> <span class="toctext">Starting Samba</span></a></li>
<li class="toclevel-2 tocsection-17"><a href="#Testing_Winbind"><span class="tocnumber">3.2</span> <span class="toctext">Testing Winbind</span></a></li>
<li class="toclevel-2 tocsection-18"><a href="#Testing_nsswitch"><span class="tocnumber">3.3</span> <span class="toctext">Testing nsswitch</span></a></li>
<li class="toclevel-2 tocsection-19"><a href="#Testing_Samba_commands"><span class="tocnumber">3.4</span> <span class="toctext">Testing Samba commands</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-20">
<a href="#Configuring_PAM"><span class="tocnumber">4</span> <span class="toctext">Configuring PAM</span></a>
<ul>
<li class="toclevel-2 tocsection-21">
<a href="#system-auth"><span class="tocnumber">4.1</span> <span class="toctext">system-auth</span></a>
<ul>
<li class="toclevel-3 tocsection-22"><a href="#.22auth.22_section.22"><span class="tocnumber">4.1.1</span> <span class="toctext">"auth" section"</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#.22account.22_section"><span class="tocnumber">4.1.2</span> <span class="toctext">"account" section</span></a></li>
<li class="toclevel-3 tocsection-24"><a href="#.22password.22_section"><span class="tocnumber">4.1.3</span> <span class="toctext">"password" section</span></a></li>
<li class="toclevel-3 tocsection-25"><a href="#.22session.22_section"><span class="tocnumber">4.1.4</span> <span class="toctext">"session" section</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-26"><a href="#Testing_login"><span class="tocnumber">4.2</span> <span class="toctext">Testing login</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-27"><a href="#Configuring_Shares"><span class="tocnumber">5</span> <span class="toctext">Configuring Shares</span></a></li>
<li class="toclevel-1 tocsection-28">
<a href="#Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine"><span class="tocnumber">6</span> <span class="toctext">Adding a machine keytab file and activating password-free kerberized ssh to the machine</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="#Creating_a_machine_key_tab_file"><span class="tocnumber">6.1</span> <span class="toctext">Creating a machine key tab file</span></a></li>
<li class="toclevel-2 tocsection-30"><a href="#Enabling_keytab_authentication"><span class="tocnumber">6.2</span> <span class="toctext">Enabling keytab authentication</span></a></li>
<li class="toclevel-2 tocsection-31"><a href="#Preparing_sshd_on_server"><span class="tocnumber">6.3</span> <span class="toctext">Preparing sshd on server</span></a></li>
<li class="toclevel-2 tocsection-32"><a href="#Adding_necessary_options_on_client"><span class="tocnumber">6.4</span> <span class="toctext">Adding necessary options on client</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#Testing_the_setup"><span class="tocnumber">6.5</span> <span class="toctext">Testing the setup</span></a></li>
<li class="toclevel-2 tocsection-34"><a href="#Nifty_fine-tuning_for_complete_password-free_kerberos_handling."><span class="tocnumber">6.6</span> <span class="toctext">Nifty fine-tuning for complete password-free kerberos handling.</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-35">
<a href="#Generating_user_Keytabs_which_are_accepted_by_AD"><span class="tocnumber">7</span> <span class="toctext">Generating user Keytabs which are accepted by AD</span></a>
<ul>
<li class="toclevel-2 tocsection-36"><a href="#Nice_to_know"><span class="tocnumber">7.1</span> <span class="toctext">Nice to know</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-37">
<a href="#See_also"><span class="tocnumber">8</span> <span class="toctext">See also</span></a>
<ul>
<li class="toclevel-2 tocsection-38"><a href="#Commercial_Solutions"><span class="tocnumber">8.1</span> <span class="toctext">Commercial Solutions</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Terminology">Terminology</span></h2>
<p>If you are not familiar with Active Directory, there are a few keywords that are helpful to know.
</p>
<ul>
<li> <b>Domain</b> : The name used to group computers and accounts. </li>
<li> <b>SID</b> : Each computer that joins the domain as a member must have a unique SID or System Identifier.</li>
<li> <b>SMB</b> : Server Message Block.</li>
<li> <b>NETBIOS</b>: Network naming protocol used as an alternative to DNS. Mostly legacy, but still used in Windows Networking.</li>
<li> <b>WINS</b>: Windows Information Naming Service. Used for resolving Netbios names to windows hosts.</li>
<li> <b>Winbind</b>: Protocol for windows authentication.</li>
</ul>
<h2><span class="mw-headline" id="Configuration">Configuration</span></h2>
<h3><span class="mw-headline" id="Active_Directory_Configuration">Active Directory Configuration</span></h3>
<p>This section works with the default configuration of Windows Server 2012 R2.
</p>
<h4><span class="mw-headline" id="Updating_the_GPO">Updating the GPO</span></h4>
<p>It may be necessary to disable <i>Digital Sign Communication (Always)</i> in the AD group policies. Dive into:
</p>
<p><code>Local policies</code> -&gt; <code>Security policies</code> -&gt; <code>Microsoft Network Server</code> -&gt; <code>Digital sign communication (Always)</code> -&gt; activate <code>define this policy</code> and use the <code>disable</code> radio button.
</p>
<p>If you use Windows Server 2008 R2, you need to modify that in GPO for Default Domain Controller Policy -&gt; Computer Setting -&gt; Policies -&gt; Windows Setting -&gt; Security Setting -&gt; Local Policies -&gt; Security Option -&gt; <i>Microsoft network client: Digitally sign communications (always)</i>
</p>
<h3><span class="mw-headline" id="Linux_Host_Configuration">Linux Host Configuration</span></h3>
<p>The next few steps will begin the process of configuring the Host. You will need root or sudo access to complete these steps.
</p>
<h3><span class="mw-headline" id="Installation">Installation</span></h3>
<p><a href="../en/Help:Reading.html#Installation_of_packages" title="Install" class="mw-redirect">Install</a> the following packages:
</p>
<ul>
<li> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=samba">samba</a></span>, see also <a href="../en/Samba.html" title="Samba">Samba</a>
</li>
<li> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=pam-krb5">pam-krb5</a></span>
</li>
<li> <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=ntp">ntp</a></span> or <span class="plainlinks archwiki-template-pkg"><a rel="nofollow" class="external text" href="https://www.archlinux.org/packages/?name=openntpd">openntpd</a></span>, see also <a href="../en/Network_Time_Protocol_daemon.html" title="NTPd" class="mw-redirect">NTPd</a> or <a href="../en/OpenNTPD.html" title="OpenNTPD">OpenNTPD</a>
</li>
</ul>
<h3><span class="mw-headline" id="Updating_DNS">Updating DNS</span></h3>
<p>Active Directory is heavily dependent upon DNS. You will need to update <code>/etc/resolv.conf</code> to use one or more of the Active Directory domain controllers:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/resolv.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
nameserver &lt;IP1&gt;
nameserver &lt;IP2&gt;
</pre>
<p>Replacing &lt;IP1&gt; and &lt;IP2&gt; with valid IP addresses for the AD servers. If your AD domains do not permit DNS forwarding or recursion, you may need to add additional resolvers. 
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>If your machine dual boots Windows and Linux, you should use a different DNS hostname and netbios name for the linux configuration if both operating systems will be members of the same domain.</div>
<h3><span class="mw-headline" id="Configuring_NTP">Configuring NTP</span></h3>
<p>Read <a href="../en/Time.html#Time_synchronization" title="Time">Time#Time synchronization</a> to configure an NTP service.
</p>
<p>On the NTP servers configuration, use the IP addresses for the AD servers, as they typically run NTP as a service. Alternatively, you can use other known NTP servers provided the Active directory servers sync to the same stratum.
</p>
<p>Ensure that the service is configured to sync the time automatically very early on startup.
</p>
<h3><span class="mw-headline" id="Kerberos">Kerberos</span></h3>
<p>Let us assume that your AD is named example.com. Let us further assume your AD is ruled by two domain controllers, the primary and secondary one, which are named PDC and BDC, pdc.example.com and bdc.example.com respectively. Their IP adresses will be 192.168.1.2 and 192.168.1.3 in this example.  Take care to watch your syntax; upper-case is very important here.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/krb5.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[libdefaults]
        default_realm 	= 	EXAMPLE.COM
	clockskew 	= 	300
	ticket_lifetime	=	1d
        forwardable     =       true
        proxiable       =       true
        dns_lookup_realm =      true
        dns_lookup_kdc  =       true
	
[realms]
	EXAMPLE.COM = {
		kdc 	= 	PDC.EXAMPLE.COM
                admin_server = PDC.EXAMPLE.COM
		default_domain = EXAMPLE.COM
	}
	
[domain_realm]
        .kerberos.server = EXAMPLE.COM
	.example.com = EXAMPLE.COM
	example.com = EXAMPLE.COM
	example	= EXAMPLE.COM

[appdefaults]
	pam = {
	ticket_lifetime 	= 1d
	renew_lifetime 		= 1d
	forwardable 		= true
	proxiable 		= false
	retain_after_close 	= false
	minimum_uid 		= 0
	debug 			= false
	}

[logging]
	default 		= FILE:/var/log/krb5libs.log
	kdc 			= FILE:/var/log/kdc.log
        admin_server            = FILE:/var/log/kadmind.log
</pre>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>Heimdal 1.3.1 deprecated DES encryption which is required for AD authentication before Windows Server 2008. You will probably have to add <pre>allow_weak_crypto = true</pre> to the <code>[libdefaults]</code> section.</div>
<h4><span class="mw-headline" id="Creating_a_Kerberos_Ticket">Creating a Kerberos Ticket</span></h4>
<p>Now you can query the AD domain controllers and request a kerberos ticket (<b>uppercase is necessary</b>):
</p>
<pre>kinit administrator@EXAMPLE.COM</pre>
<p>You can use any username that has rights as a Domain Administrator.
</p>
<h4><span class="mw-headline" id="Validating_the_Ticket">Validating the Ticket</span></h4>
<p>Run <b>klist</b> to verify you did receive the token. You should see something similar to:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
 Ticket cache: FILE:/tmp/krb5cc_0
 Default principal: administrator@EXAMPLE.COM
 
 Valid starting    Expires           Service principal 
 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM
         renew until 02/05/12 21:27:47
</pre>
<h3><span class="mw-headline" id="pam_winbind.conf">pam_winbind.conf</span></h3>
<p>If you get errors stating that /etc/security/pam_winbind.conf was not found, create the file and add the following:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/security/pam_winbind.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[global]
  debug = no
  debug_state = no
  try_first_pass = yes
  krb5_auth = yes
  krb5_cache_type = FILE
  cached_login = yes
  silent = no
  mkhomedir = yes
</pre>
<h3><span class="mw-headline" id="Samba">Samba</span></h3>
<p>Samba is a free software re-implementation of the SMB/CIFS networking protocol. It also includes tools for Linux machines to act as Windows networking servers and clients.
</p>
<div style="padding: 5px; margin: 0.50em 0; background-color: #DDDDFF; border: thin solid #BBBBDD; overflow: hidden;">
<strong> Note: </strong>The configuration can vary greatly depending on how the Windows environment is deployed. Be prepared to troubleshoot and research</div>
<p>In this section, we will focus on getting Authentication to work first by editing the 'Global' section first. Later, we will go back and add shares.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[Global]
  netbios name = MYARCHLINUX
  workgroup = EXAMPLE
  realm = EXAMPLE.COM
  server string = %h ArchLinux Host
  security = ads
  encrypt passwords = yes
  password server = pdc.example.com

  idmap config * : backend = rid
  idmap config * : range = 10000-20000

  winbind use default domain = Yes
  winbind enum users = Yes
  winbind enum groups = Yes
  winbind nested groups = Yes
  winbind separator = +
  winbind refresh tickets = yes
  winbind offline logon = yes
  winbind cache time = 300

  template shell = /bin/bash
  template homedir = /home/%D/%U
   
  preferred master = no
  dns proxy = no
  wins server = pdc.example.com
  wins proxy = no

  inherit acls = Yes
  map acl inherit = Yes
  acl group control = yes

  load printers = no
  debug level = 3
  use sendfile = no
</pre>
<h3><span class="mw-headline" id="Join_the_Domain">Join the Domain</span></h3>
<p>You need an AD Administrator account to do this. Let us assume this is named Administrator. The command is 'net ads join'
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads join -U Administrator</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
Administrator's password: xxx
Using short domain name -- EXAMPLE
Joined 'MYARCHLINUX' to realm 'EXAMPLE.COM'
</pre>
<h2><span class="mw-headline" id="Starting_and_testing_services">Starting and testing services</span></h2>
<h3><span class="mw-headline" id="Starting_Samba">Starting Samba</span></h3>
<p>Hopefully, you have not rebooted yet! Fine. If you are in an X-session, quit it, so you can test login into another console, while you are still logged in.
</p>
<p>Enable and start the individual Samba deamons <code>smbd.service</code>, <code>nmbd.service</code>, and <code>winbindd.service</code>.
</p>
<p>Next we'll need to modify the NSSwitch configuration, which tells the Linux host how to retrieve information from various sources and in which order to do so. In this case, we are appending Active Directory as additional sources for Users, Groups, and Hosts.
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/nsswitch.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
 passwd:            files winbind
 shadow:            files winbind
 group:             files winbind 
 
 hosts:             files dns wins
</pre>
<h3><span class="mw-headline" id="Testing_Winbind">Testing Winbind</span></h3>
<p>Let us check if winbind is able to query the AD. The following command should return a list of AD users:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wbinfo -u</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
administrator
guest
krbtgt
test.user
</pre>
<ul><li> Note we created an Active Directory user called 'test.user' on the domain controller</li></ul>
<p>We can do the same for AD groups:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># wbinfo -g</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
domain computers
domain controllers
schema admins
enterprise admins
cert publishers
domain admins
domain users
domain guests
group policy creator owners
ras and ias servers
allowed rodc password replication group
denied rodc password replication group
read-only domain controllers
enterprise read-only domain controllers
dnsadmins
dnsupdateproxy
</pre>
<h3><span class="mw-headline" id="Testing_nsswitch">Testing nsswitch</span></h3>
<p>To ensure that our host is able to query the domain for users and groups, we test nsswitch settings by issuing the 'getent' command. The following output shows what a stock ArchLinux install looks like:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># getent passwd</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/bin/false
daemon:x:2:2:daemon:/sbin:/bin/false
mail:x:8:12:mail:/var/spool/mail:/bin/false
ftp:x:14:11:ftp:/srv/ftp:/bin/false
http:x:33:33:http:/srv/http:/bin/false
nobody:x:99:99:nobody:/:/bin/false
dbus:x:81:81:System message bus:/:/bin/false
ntp:x:87:87:Network Time Protocol:/var/empty:/bin/false
avahi:x:84:84:avahi:/:/bin/false
administrator:*:10001:10006:Administrator:/home/EXAMPLE/administrator:/bin/bash
guest:*:10002:10007:Guest:/home/EXAMPLE/guest:/bin/bash
krbtgt:*:10003:10006:krbtgt:/home/EXAMPLE/krbtgt:/bin/bash
test.user:*:10000:10006:Test User:/home/EXAMPLE/test.user:/bin/bash
</pre>
<p>And for groups:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># getent group</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
root:x:0:root
bin:x:1:root,bin,daemon
daemon:x:2:root,bin,daemon
sys:x:3:root,bin
adm:x:4:root,daemon
tty:x:5:
disk:x:6:root
lp:x:7:daemon
mem:x:8:
kmem:x:9:
wheel:x:10:root
ftp:x:11:
mail:x:12:
uucp:x:14:
log:x:19:root
utmp:x:20:
locate:x:21:
rfkill:x:24:
smmsp:x:25:
http:x:33:
games:x:50:
network:x:90:
video:x:91:
audio:x:92:
optical:x:93:
floppy:x:94:
storage:x:95:
scanner:x:96:
power:x:98:
nobody:x:99:
users:x:100:
dbus:x:81:
ntp:x:87:
avahi:x:84:
domain computers:x:10008:
domain controllers:x:10009:
schema admins:x:10010:administrator
enterprise admins:x:10011:administrator
cert publishers:x:10012:
domain admins:x:10013:test.user,administrator
domain users:x:10006:
domain guests:x:10007:
group policy creator owners:x:10014:administrator
ras and ias servers:x:10015:
allowed rodc password replication group:x:10016:
denied rodc password replication group:x:10017:krbtgt
read-only domain controllers:x:10018:
enterprise read-only domain controllers:x:10019:
dnsadmins:x:10020:
dnsupdateproxy:x:10021:
</pre>
<h3><span class="mw-headline" id="Testing_Samba_commands">Testing Samba commands</span></h3>
<p>Try out some net commands to see if Samba can communicate with  AD:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads info</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[2012/02/05 20:21:36.473559,  0] param/loadparm.c:7599(lp_do_parameter)
  Ignoring unknown parameter "idmapd backend"
LDAP server: 192.168.1.2
LDAP server name: PDC.example.com
Realm: EXAMPLE.COM
Bind Path: dc=EXAMPLE,dc=COM
LDAP port: 389
Server time: Sun, 05 Feb 2012 20:21:33 CST
KDC server: 192.168.1.2
Server time offset: -3
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads lookup</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[2012/02/05 20:22:39.298823,  0] param/loadparm.c:7599(lp_do_parameter)
  Ignoring unknown parameter "idmapd backend"
Information for Domain Controller: 192.168.1.2

Response Type: LOGON_SAM_LOGON_RESPONSE_EX
GUID: 2a098512-4c9f-4fe4-ac22-8f9231fabbad
Flags:
        Is a PDC:                                   yes
        Is a GC of the forest:                      yes
        Is an LDAP server:                          yes
        Supports DS:                                yes
        Is running a KDC:                           yes
        Is running time services:                   yes
        Is the closest DC:                          yes
        Is writable:                                yes
        Has a hardware clock:                       yes
        Is a non-domain NC serviced by LDAP server: no
        Is NT6 DC that has some secrets:            no
        Is NT6 DC that has all secrets:             yes
Forest:                 example.com
Domain:                 example.com
Domain Controller:      PDC.example.com
Pre-Win2k Domain:       EXAMPLE
Pre-Win2k Hostname:     PDC
Server Site Name :              Office
Client Site Name :              Office
NT Version: 5
LMNT Token: ffff
LM20 Token: ffff
</pre>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># net ads status -U administrator | less</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
objectClass: computer
cn: myarchlinux
distinguishedName: CN=myarchlinux,CN=Computers,DC=leafscale,DC=inc
instanceType: 4
whenCreated: 20120206043413.0Z
whenChanged: 20120206043414.0Z
uSNCreated: 16556
uSNChanged: 16563
name: myarchlinux
objectGUID: 2c24029c-8422-42b2-83b3-a255b9cb41b3
userAccountControl: 69632
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 129729780312632000
localPolicyFlags: 0
pwdLastSet: 129729764538848000
primaryGroupID: 515
objectSid: S-1-5-21-719106045-3766251393-3909931865-1105
...&lt;snip&gt;...
</pre>
<h2><span class="mw-headline" id="Configuring_PAM">Configuring PAM</span></h2>
<p>Now we will change various rules in PAM to allow Active Directory users to use the system for things like login and sudo access.  When changing the rules, note the order of these items and whether they are marked as <b>required</b> or <b>sufficient</b> is critical to things working as expected. You should not deviate from these rules unless you know how to write PAM rules.
</p>
<p>In case of logins, PAM should first ask for AD accounts, and for local accounts if no matching AD account was found. Therefore, we add entries to include <code>pam_winbind.so</code> into the authentication process.
</p>
<p>The Arch Linux PAM configuration keeps the central auth process in <code>/etc/pam.d/system-auth</code>. Starting with the stock configuration from <code>pambase</code>, change it like this:
</p>
<h3><span class="mw-headline" id="system-auth">system-auth</span></h3>
<h4><span class="mw-headline" id=".22auth.22_section.22">"auth" section"</span></h4>
<p>Find the line:
</p>
<pre>auth required pam_unix.so ...
</pre>
<p>Delete it, and replace with:
</p>
<pre>auth [success=1 default=ignore] pam_localuser.so
auth [success=2 default=die] pam_winbind.so
auth [success=1 default=die] pam_unix.so nullok
auth requisite pam_deny.so
</pre>
<h4><span class="mw-headline" id=".22account.22_section">"account" section</span></h4>
<p>Find the line:
</p>
<pre>account required pam_unix.so
</pre>
<p>Keep it, and add this below:
</p>
<pre>account [success=1 default=ignore] pam_localuser.so
account required pam_winbind.so
</pre>
<h4><span class="mw-headline" id=".22password.22_section">"password" section</span></h4>
<p>Find the line:
</p>
<pre>password required pam_unix.so ...
</pre>
<p>Delete it, and replace with:
</p>
<pre>password [success=1 default=ignore] pam_localuser.so
password [success=2 default=die] pam_winbind.so
password [success=1 default=die] pam_unix.so sha512 shadow
password requisite pam_deny.so
</pre>
<h4><span class="mw-headline" id=".22session.22_section">"session" section</span></h4>
<p>Find the line:
</p>
<pre>session required pam_unix.so
</pre>
<p>Keep it, and add this line immediately above it:
</p>
<pre>session required pam_mkhomedir.so skel=/etc/skel/ umask=0022
</pre>
<p>Below the pam_unix line, add these:
</p>
<pre>session [success=1 default=ignore] pam_localuser.so
session required pam_winbind.so
</pre>
<h3><span class="mw-headline" id="Testing_login">Testing login</span></h3>
<p>Now, start a new console session (or ssh) and try to login using the AD credentials. The domain name is optional, as this was set in the Winbind configuration as 'default realm'.  Please note that in the case of ssh, you will need to modify the <code>/etc/ssh/sshd_config</code> file to allow kerberos authentication <code>(KerberosAuthentication yes)</code>.
</p>
<pre>
test.user
EXAMPLE+test.user
</pre>
<p>Both should work. You should notice that <code>/home/example/test.user</code> will be automatically created.
<b>Log into another session using an linux account. Check that you still be able to log in as root - but keep in mind to be logged in as root in at least one session!</b>
</p>
<h2><span class="mw-headline" id="Configuring_Shares">Configuring Shares</span></h2>
<p>Earlier we skipped configuration of the shares. Now that things are working, go back to <code>/etc/samba/smb.conf</code>, and add the exports for the host that you want available on the windows network. 
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[MyShare]
  comment = Example Share
  path = /srv/exports/myshare
  read only = no
  browseable = yes
  valid users = @NETWORK+"Domain Admins" NETWORK+test.user
</pre>
<p>In the above example, the keyword <b>NETWORK</b> is to be used. Do not mistakenly substitute this with your domain name. For adding groups, prepend the '@' symbol to the group. Note that <code>Domain Admins</code> is encapsulated in quotes so Samba correctly parses it when reading the configuration file.
</p>
<h2><span class="mw-headline" id="Adding_a_machine_keytab_file_and_activating_password-free_kerberized_ssh_to_the_machine">Adding a machine keytab file and activating password-free kerberized ssh to the machine</span></h2>
<p>This explains how to generate a machine keytab file which you will need e.g. to enable password-free kerberized ssh to your machine from other machines in the domain. The scenario in mind is that you have a bunch of systems in your domain and you just added a server/workstation using the above description to your domain onto which a lot of users need to ssh in order to work - e.g. GPU workstation or an OpenMP compute node, etc. In this case you might not want to type your password every time you log in. On the other hand the key authentication used by many users in this case can not give you the necessary credentials to e.g. mount kerberized NFSv4 shares. So this will help you to enable password-free logins from your clients to the machine in question using kerberos ticket forwarding.
</p>
<h3><span class="mw-headline" id="Creating_a_machine_key_tab_file">Creating a machine key tab file</span></h3>
<p>run 'net ads keytab create -U administrator' as root to create a machine keytab file in /etc/krb5.keytab. It will promt you with a warning that we need to enable keytab authentication in our configuration file, so we will do that in the next step. In my case it had problems when a key tab file is already in place - the command just did not come back it hang ... In that case you should rename the existing /etc/krb5.keytab and run the command again - it should work now.
</p>
<pre># net ads keytab create -U administrator</pre>
<p>verify the content of your keytab by running:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist -k /etc/krb5.keytab</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
Keytab name: FILE:/etc/krb5.keytab
KVNO Principal
---- --------------------------------------------------------------------------
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/myarchlinux.example.com@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 host/MYARCHLINUX@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
   4 MYARCHLINUX$@EXAMPLE.COM
</pre>
<h3><span class="mw-headline" id="Enabling_keytab_authentication">Enabling keytab authentication</span></h3>
<p>Now you need to tell winbind to use the file by adding these lines to the /etc/samba/smb.conf:
</p>
<pre> kerberos method = system keytab
 dedicated keytab file = /etc/krb5.keytab
</pre>
<p>It should look sth. like this:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;">/etc/samba/smb.conf</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
[Global]
  netbios name = MYARCHLINUX
  workgroup = EXAMPLE
  realm = EXAMPLE.COM
  server string = %h ArchLinux Host
  security = ads
  encrypt passwords = yes
  password server = pdc.example.com
  kerberos method = secrets and keytab
  dedicated keytab file = /etc/krb5.keytab

  idmap config * : backend = tdb
  idmap config * : range = 10000-20000

  winbind use default domain = Yes
  winbind enum users = Yes
  winbind enum groups = Yes
  winbind nested groups = Yes
  winbind separator = +
  winbind refresh tickets = yes

  template shell = /bin/bash
  template homedir = /home/%D/%U
   
  preferred master = no
  dns proxy = no
  wins server = pdc.example.com
  wins proxy = no

  inherit acls = Yes
  map acl inherit = Yes
  acl group control = yes

  load printers = no
  debug level = 3
  use sendfile = no
</pre>
<p>Restart the winbind.service using 'systemctl restart winbind.service' with root privileges.
</p>
<pre># systemctl restart winbind.service</pre>
<p>Check if everything works by getting a machine ticket for your system by running 
</p>
<pre># kinit MYARCHLINUX$ -kt /etc/krb5.keytab</pre>
<p>This should not give you any feedback but running 'klist' should show you sth like:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># klist</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">
 Ticket cache: FILE:/tmp/krb5cc_0
 Default principal: MYARCHLINUX$@EXAMPLE.COM
 
 Valid starting    Expires           Service principal 
 02/04/12 21:27:47 02/05/12 07:27:42 krbtgt/EXAMPLE.COM@EXAMPLE.COM
         renew until 02/05/12 21:27:47
</pre>
<p>Some common mistakes here are a) forgetting the trailing $ or b) ignoring case sensitivity - it needs to look exactly like the entry in the keytab (usually you cannot to much wrong with all capital)
</p>
<h3><span class="mw-headline" id="Preparing_sshd_on_server">Preparing sshd on server</span></h3>
<p>All we need to do is add some options to our sshd_config and restart the sshd.service.
</p>
<p>Edit /etc/ssh/sshd_config to look like this in the appropriate places:
</p>
<pre style="margin-bottom: 0; border-bottom:none; padding-bottom:0.8em;"># /etc/ssh/sshd_config</pre>
<pre style="margin-top: 0; border-top-style:dashed; padding-top: 0.8em;">

...

# Change to no to disable s/key passwords
ChallengeResponseAuthentication no

# Kerberos options
KerberosAuthentication yes
#KerberosOrLocalPasswd yes
KerberosTicketCleanup yes
KerberosGetAFSToken yes

# GSSAPI options
GSSAPIAuthentication yes
GSSAPICleanupCredentials yes

...

</pre>
<p>Restart the sshd.service using:
</p>
<pre># systemctl restart sshd.service</pre>
<h3><span class="mw-headline" id="Adding_necessary_options_on_client">Adding necessary options on client</span></h3>
<p>First we need to make sure that the tickets on our client are forwardable. This is usually standard but we better check anyways. You have to look for the  forwardable option and set it to 'true'
</p>
<pre>forwardable     =       true</pre>
<p>Secondly we need to add the options 
</p>
<pre> GSSAPIAuthentication yes
 GSSAPIDelegateCredentials yes
</pre>
<p>to our .ssh/config file to tell ssh to use this options - alternatively they can be invoked using the -o options directly in the ssh command (see 'man ssh' for help).
</p>
<h3><span class="mw-headline" id="Testing_the_setup">Testing the setup</span></h3>
<p>On Client:
</p>
<p>make sure you have a valid ticket - if in doubt run 'kinit'
</p>
<p>then use ssh to connect to you machine
</p>
<pre>ssh myarchlinux.example.com </pre>
<p>you should get connected without needing to enter your password.
</p>
<p>if you have key authentication additionally activated then you should perform
</p>
<pre>ssh -v myarchlinux.example.com </pre>
<p>to see which authentication method it actually uses.
</p>
<p>For debugging you can enable DEBUG3 on the server and look into the journal using journalctl 
</p>
<h3><span class="mw-headline" id="Nifty_fine-tuning_for_complete_password-free_kerberos_handling.">Nifty fine-tuning for complete password-free kerberos handling.</span></h3>
<p>In case your clients are not using domain accounts on their local machines (for whatever reason) it can be hard to actually teach them to kinit before ssh to the workstation. Therefore I came up with a nice workaround:
</p>
<h2><span class="mw-headline" id="Generating_user_Keytabs_which_are_accepted_by_AD">Generating user Keytabs which are accepted by AD</span></h2>
<p>On a system let the user run:
</p>
<pre>
ktutil
addent -password -p username@EXAMPLE.COM -k 1 -e RC4-HMAC
- enter password for username -
wkt username.keytab
q
</pre>
<p>Now test the file by invoking:
</p>
<pre>kinit -kt username.keytab</pre>
<p>It should not promt you to give your password nor should it give any other feedback. If it worked you are basically done - just put the line above into your ~./bashrc - you can now get kerberos tickets without typing a password and with that you can connect to your workstation without typing a password while being completely kerberized and able to authenticate against NFSv4 and CIFS via tickets - pretty neat.
</p>
<h3><span class="mw-headline" id="Nice_to_know">Nice to know</span></h3>
<p>The file 'username.keytab' is not machinespecific and can therefore be copied around. E.g. we created the files on a linux machine and copied them to our Mac clients as the commands on Macs are different ...
</p>
<h2><span class="mw-headline" id="See_also">See also</span></h2>
<ul>
<li> <a href="https://en.wikipedia.org/wiki/Active_Directory" class="extiw" title="wikipedia:Active Directory">Wikipedia: Active Directory</a>
</li>
<li> <a href="https://en.wikipedia.org/wiki/Samba_(software)" class="extiw" title="wikipedia:Samba (software)">Wikipedia: Samba</a>
</li>
<li> <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)" class="extiw" title="wikipedia:Kerberos (protocol)">Wikipedia: Kerberos</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.samba.org/samba/docs">Samba: Documentation</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://wiki.samba.org/index.php/Samba_&amp;_Active_Directory">Samba Wiki: Samba &amp; Active Directory</a>
</li>
<li> <a rel="nofollow" class="external text" href="http://www.samba.org/samba/docs/man/manpages-3/smb.conf.5.html">Samba Man Page: smb.conf</a>
</li>
</ul>
<h3><span class="mw-headline" id="Commercial_Solutions">Commercial Solutions</span></h3>
<ul>
<li> Centrify</li>
<li> Likewise</li>
</ul>

</div>
<div id="catlinks" class="catlinks"><div id="mw-normal-catlinks" class="mw-normal-catlinks">
<a href="../Special:Categories.html" title="Special:Categories">Category</a>: <ul><li><a href="../en/Category:Networking.html" title="Category:Networking">Networking</a></li></ul>
</div></div>					<div class="visualClear"></div>
				</div>
			</div>
		</div>
		<div class="visualClear"></div>
					<div id="footer" role="contentinfo">
Extracted from <a href="https://wiki.archlinux.org"> ArchWiki </a> and licensed under <a href="http://www.gnu.org/copyleft/fdl.html"> GDL >= 1.3</a>
		</div>
		</div>
		</body>
</html>
